!function(a){var b={};a.Webvs=b,b.Events=a.Backbone&&Backbone.Events||a.Events,b.ModelLike=_.extend(_.clone(b.Events),{get:function(){throw new Error("get not implemented")},toJSON:function(){throw new Error("toJSON not implemented")},setAttribute:function(){throw new Error("setAttribute not implemented")},set:function(a,b,c){var d,e;if(!_.isString(a)&&arguments.length<=2){e=b.silent,c=_.defaults({silent:!0},b),b=_.clone(a),d=!1;for(a in b)this.setAttribute(a,b[a],c)&&(d=!0,e||this.trigger("change:"+a,this,b[a],c));d&&!e&&this.trigger("change",this,c)}else c=c||{},d=this.setAttribute(a,b,c),d&&!c.silent&&(this.trigger("change:"+a,this,b,c),this.trigger("change",this,c));return d}}),b.defineClass=function(a,b){return a.prototype=Object.create(b.prototype),a.prototype.constructor=a,a.super=b.prototype,_.chain(arguments).drop(2).each(function(b){_.extend(a.prototype,b)}),a},b.ComponentRegistry={},b.registerComponent=function(a,c){b.checkRequiredOptions(c,["name"]),a.Meta=c,b[c.name]=a,b.ComponentRegistry[c.name]=a},b.noop=function(){},b.checkRequiredOptions=function(a,b){for(var c in b){var d=b[c];if(!(d in a))throw new Error("Required option "+d+" not found")}},b.glslFloatRepr=function(a){return a+(a%1===0?".0":"")},b.parseColor=function(a){if(_.isArray(a)&&3==a.length)return a;if(_.isString(a)){var b;if(a=a.toLowerCase(),b=a.match(/^#([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})$/))return _.chain(b).last(3).map(function(a){return parseInt(a,16)}).value();if(b=a.match(/^rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/))return _.chain(b).last(3).map(function(a){return Math.min(parseInt(a,10),255)}).value()}throw new Error("Invalid Color Format")},b.parseColorNorm=function(a){return _.map(b.parseColor(a),function(a){return a/255})},b.logShaderError=function(a,b){var c=a.split("\n"),d=c.length.toString().length,e=b.match(/(\d+):(\d+)/);e&&(e=[parseInt(e[1],10),parseInt(e[2],10)]);var f=_.map(c,function(a,c){var f,g=c+1+"";for(f=0;f<d-g.length;f++)g="0"+g;var h="";if(e&&e[1]==c+1){var i="";for(f=0;f<e[0]+d+2;f++)i+=" ";h="\n"+i+"^\n"+i+b}return g+": "+a+h}).join("\n");console.log("Shader Error : \n"+f)},_.flatMap=_.compose(_.flatten,_.map),b.BlendModes={REPLACE:1,MAXIMUM:2,AVERAGE:3,ADDITIVE:4,SUBTRACTIVE1:5,SUBTRACTIVE2:6,MULTIPLY:7,MULTIPLY2:8,ADJUSTABLE:9,ALPHA:10},_.extend(b,b.BlendModes),b.Channels={CENTER:0,LEFT:1,RIGHT:2},_.extend(b,b.Channels),b.Source={SPECTRUM:1,WAVEFORM:2},_.extend(b,b.Source),b.getEnumValue=function(a,b){if(a=a.toUpperCase(),!(a in b))throw new Error("Unknown key "+a+", expecting one of "+_.keys(b).join(","));return b[a]},b.randString=function(a,b){var c=[];b=b||"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var d=0;a>d;d++)c.push(b.charAt(Math.floor(Math.random()*b.length)));return c.join("")},b.clamp=function(a,b,c){return Math.min(Math.max(a,b),c)},b.getComponentClass=function(a){var c=b.ComponentRegistry[a];if(!c)throw new Error("Unknown Component class "+a);return c},b.getProperty=function(a,c){_.isString(c)&&(c=c.split("."));var d=a[c.shift()];return d?c.length>0?b.getProperty(d,c):d:void 0},b.setProperty=function(a,c,d){_.isString(c)&&(c=c.split("."));var e=c.shift();0===c.length?a[e]=d:b.setProperty(a[e],c,d)}}(window),function(a){a.ResourcePack={name:"Builtin",prefix:"./resources/",fileNames:["avsres_texer_circle_edgeonly_19x19.bmp","avsres_texer_circle_edgeonly_29x29.bmp","avsres_texer_circle_fade_13x13.bmp","avsres_texer_circle_heavyblur_19x19.bmp","avsres_texer_circle_heavyblur_21x21.bmp","avsres_texer_circle_heavyblur_29x29.bmp","avsres_texer_circle_sharp_09x09.bmp","avsres_texer_circle_sharp_19x19.bmp","avsres_texer_circle_slightblur_13x13.bmp","avsres_texer_circle_slightblur_21x21.bmp","avsres_texer_hexagon-h_blur_123x123.bmp","avsres_texer_square_edgeonly_24x24.bmp","avsres_texer_square_edgeonly_28x28.bmp","avsres_texer_square_edgeonly_30x30.bmp","avsres_texer_square_sharp_20x20.bmp","avsres_texer_square_sharp_32x32.bmp","avsres_texer_square_sharp_48x48.bmp","avsres_texer_square_sharp_60x60.bmp","avsres_texer_square_sharp_64x64.bmp","avsres_texer_square_sharp_72x72.bmp","avsres_texer_square_sharp_96x96.bmp","avsres_texer_square_sharp_250x250.bmp"]}}(Webvs),function(a){function b(a){a?(_.isArray(a)||(a=[a]),this.packs=a):this.packs=[],this.clear()}a.ResourceManager=a.defineClass(b,Object,a.ModelLike,{registerUri:function(a,b){_.isString(a)&&_.isString(b)?this.uris[a]=b:_.extend(this.uris,a)},get:function(a){return"uris"==a?this.uris:"packs"==a?this.packs:void 0},setAttribute:function(a,b){return"uris"==a?(this.uris=b,!0):!1},toJSON:function(){return{uris:_.clone(this.uris)}},clear:function(){this.uris={},this.images={},this.waitCount=0,this.ready=!0},destroy:function(){this.stopListening()},_getUri:function(a){var b=this.uris[a];if(b)return b;for(var c=this.packs.length-1;c>=0;c--){var d=this.packs[c];if(-1!=d.fileNames.indexOf(a))return d.prefix+a}},_loadStart:function(){this.waitCount++,1==this.waitCount&&(this.ready=!1,this.trigger("wait"))},_loadEnd:function(){this.waitCount--,0===this.waitCount&&(this.ready=!0,this.trigger("ready"))},getImage:function(a,b,c,d){d=d||this;var e=this,f=this.images[a];if(f)return void(b&&b.call(d,f));var g=this._getUri(a);if(!g)throw new Error("Unknown image file "+a);f=new Image,0!==g.indexOf("data:")&&(f.crossOrigin="anonymous"),f.onload=function(){e.images[a]=f,b&&b.call(d,f),e._loadEnd()},c&&(f.onError=function(){c.call(d)&&e._loadEnd()}),this._loadStart(),f.src=g}})}(Webvs),function(a){function b(){}a.AnalyserAdapter=a.defineClass(b,Object,{beat:!1,update:function(){},getWaveform:function(){return new Float32Array(0)},getSpectrum:function(){return new Float32Array(0)}})}(Webvs),function(a){function b(a){this.dancer=a,this.beat=!1;var b=this;this.kick=a.createKick({onKick:function(){b.beat=!0},offKick:function(){b.beat=!1}}),this.kick.on()}a.DancerAdapter=a.defineClass(b,a.AnalyserAdapter,{getWaveform:function(){return this.dancer.getWaveform()},getSpectrum:function(){return this.dancer.getSpectrum()}})}(Webvs),function(a){function b(a){a=_.defaults(a||{},{threshold:.125,decay:.02}),this.threshold=a.threshold,this.movingThreshold=0,this.decay=a.decay,this.eqData=[],this.waveformData=[];for(var b=0;3>b;b++)this.eqData[b]=new Float32Array(256),this.waveformData[b]=new Float32Array(256)}a.SMAnalyser=a.defineClass(b,a.AnalyserAdapter,{createSound:function(a){return a.useWaveformData=!0,a.useEQData=!0,this.setSound(soundManager.createSound(a)),this.sound},setSound:function(a){this.sound=a},update:function(){if(this.sound&&0!==this.sound.eqData.left.length&&0!==this.sound.waveformData.left.length){var a;for(this.eqData[1]=new Float32Array(this.sound.eqData.left),this.eqData[2]=new Float32Array(this.sound.eqData.right),this.waveformData[1]=new Float32Array(this.sound.waveformData.left),this.waveformData[2]=new Float32Array(this.sound.waveformData.right),a=0;256>a;a++)this.eqData[0][a]=this.eqData[1][a]/2+this.eqData[2][a]/2,this.waveformData[0][a]=this.waveformData[1][a]/2+this.waveformData[2][a]/2;this.beat=!1;var b=0,c=0;for(a=0;256>a;a++)b+=Math.abs(this.waveformData[1][a]),c+=Math.abs(this.waveformData[2][a]);var d=Math.max(b,c)/256;d>=this.movingThreshold&&d>=this.threshold?(this.movingThreshold=d,this.beat=!0):this.movingThreshold=this.movingThreshold*(1-this.decay)+d*this.decay}},getWaveform:function(a){return a=_.isUndefined(a)?0:a,this.waveformData[a]},getSpectrum:function(a){return a=_.isUndefined(a)?0:a,this.eqData[a]}})}(Webvs),function(a){function b(a){if(a=_.defaults(a||{},{fftSize:512,threshold:.125,decay:.02}),a.context)this.context=a.context;else if(window.webkitAudioContext)this.context=new webkitAudioContext;else{if(!window.AudioContext)throw new Error("Cannot create webaudio context");this.context=new AudioContext}this.fftSize=a.fftSize,this.threshold=a.threshold,this.movingThreshold=0,this.decay=a.decay,this.visData=[];for(var b=0;3>b;b++){var c=new Float32Array(this.fftSize/2),d=new Float32Array(this.fftSize);this.visData[b]={spectrum:c,waveform:d}}}a.WebAudioAnalyser=a.defineClass(b,a.AnalyserAdapter,{connectToNode:function(a){this.source=a,this.gain=this.context.createGain(),this.gain.channelCountMode="explicit",this.gain.channelCount=2,this.source.connect(this.gain),this.channelSplit=this.context.createChannelSplitter(2),this.gain.connect(this.channelSplit),this.analysers=[];for(var b=0;2>b;b++){var c=this.context.createAnalyser();c.fftSize=this.fftSize,this.channelSplit.connect(c,b),this.analysers[b]=c}},update:function(){if(this.analysers){for(var a,b=new Uint8Array(this.fftSize),c=0;2>c;c++){var d=this.visData[c+1],e=this.analysers[c];for(e.getByteFrequencyData(b),a=0;a<d.spectrum.length;a++)d.spectrum[a]=b[a]/255;for(e.getByteTimeDomainData(b),a=0;a<d.waveform.length;a++)d.waveform[a]=b[a]/255*2-1}var f=this.visData[0];for(a=0;a<f.spectrum.length;a++)f.spectrum[a]=this.visData[1].spectrum[a]/2+this.visData[2].spectrum[a]/2;for(a=0;a<f.waveform.length;a++)f.waveform[a]=this.visData[1].waveform[a]/2+this.visData[2].waveform[a]/2;this.beat=!1;var g=0,h=0;for(a=0;a<this.fftSize;a++)g+=Math.abs(this.visData[1].waveform[a]),h+=Math.abs(this.visData[2].waveform[a]);var i=Math.max(g,h)/this.fftSize;i>=this.movingThreshold&&i>=this.threshold?(this.movingThreshold=i,this.beat=!0):this.movingThreshold=this.movingThreshold*(1-this.decay)+i*this.decay}},load:function(a,b){var c;a instanceof HTMLMediaElement?(c=a,this.source=this.context.createMediaElementSource(c)):(c=new Audio,c.src=a,this.source=this.context.createMediaElementSource(c));var d=_.bind(function(){this.connectToNode(this.source),this.source.connect(this.context.destination),b&&b(c),c.removeEventListener("canplay",d)},this);return c.readyState<3?c.addEventListener("canplay",d):d(),c},getWaveform:function(a){return a=_.isUndefined(a)?0:a,this.visData[a].waveform},getSpectrum:function(a){return a=_.isUndefined(a)?0:a,this.visData[a].spectrum}})}(Webvs),function(a){function b(b){if(a.checkRequiredOptions(b,["canvas","analyser"]),b=_.defaults(b,{showStat:!1}),this.canvas=b.canvas,this.msgElement=b.msgElement,this.analyser=b.analyser,this.isStarted=!1,b.showStat){var c=new Stats;c.setMode(0),c.domElement.style.position="absolute",c.domElement.style.right="5px",c.domElement.style.bottom="5px",document.body.appendChild(c.domElement),this.stats=c}this.meta={},this._initResourceManager(b.resourcePrefix),this._registerContextEvents(),this._initGl(),this._setupRoot({id:"root"})}a.Main=a.defineClass(b,Object,a.ModelLike,{_initResourceManager:function(b){var c=a.ResourcePack;b&&(c=_.clone(c),c.prefix=b),this.rsrcMan=new a.ResourceManager(c),this.listenTo(this.rsrcMan,"wait",this.handleRsrcWait),this.listenTo(this.rsrcMan,"ready",this.handleRsrcReady)},_registerContextEvents:function(){var a=this;this.canvas.addEventListener("webglcontextlost",function(b){b.preventDefault(),a.stop()}),this.canvas.addEventListener("webglcontextrestored",function(){a.resetCanvas()})},_initGl:function(){try{this.gl=this.canvas.getContext("webgl",{alpha:!1}),this.copier=new a.CopyProgram(this.gl,{dynamicBlend:!0}),this.buffers=new a.FrameBufferManager(this.gl,this.copier,!0,0)}catch(b){throw new Error("Couldnt get webgl context"+b)}},_setupRoot:function(b){this.registerBank={},this.bootTime=(new Date).getTime(),this.rootComponent=new a.EffectList(this.gl,this,null,b)},_startAnimation:function(){var a=this,b=function(){a.analyser.update(),a.rootComponent.draw(),a.animReqId=requestAnimationFrame(b)};if(this.stats){var c=b;b=function(){a.stats.begin(),c.call(this,arguments),a.stats.end()}}this.animReqId=requestAnimationFrame(b)},_stopAnimation:function(){cancelAnimationFrame(this.animReqId)},start:function(){this.isStarted||(this.isStarted=!0,this.rsrcMan.ready&&this._startAnimation())},stop:function(){this.isStarted&&(this.isStarted=!1,this.rsrcMan.ready&&this._stopAnimation())},loadPreset:function(a){a=_.clone(a),a.id="root",this.rootComponent.destroy(),this.rsrcMan.clear(),"resources"in a&&"uris"in a.resources&&this.rsrcMan.registerUri(a.resources.uris),this.meta=_.clone(a.meta),this._setupRoot(a)},resetCanvas:function(){var a=this.rootComponent.generateOptionsObj();this.rootComponent.destroy(),this.copier.cleanup(),this.buffers.destroy(),this._initGl(),this._setupRoot(a)},notifyResize:function(){this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight),this.buffers.resize(),this.trigger("resize",this.gl.drawingBufferWidth,this.gl.drawingBufferHeight)},setAttribute:function(a,b){return"meta"==a?(this.meta=b,!0):!1},get:function(a){return"meta"==a?this.meta:void 0},toJSON:function(){var a=this.rootComponent.toJSON();return a=_.pick(a,"clearFrame","components"),a.resources=this.rsrcMan.toJSON(),a.meta=_.clone(this.meta),a},destroy:function(){if(this.stop(),this.rootComponent.destroy(),this.rootComponent=null,this.stats){var a=this.stats.domElement;a.parentNode.removeChild(a),this.stats=null}this.rsrcMan.destroy(),this.rsrcMan=null,this.stopListening()},handleRsrcWait:function(){this.isStarted&&this._stopAnimation()},handleRsrcReady:function(){this.isStarted&&this._startAnimation()}})}(Webvs),function(a){function b(a,b,c,d){this.gl=a,this.main=b,this.parent=c,this.id=d.id,this.id||(this.id=_.uniqueId(this.constructor.Meta.name+"_")),this.enabled=_.isUndefined(d.enabled)?!0:d.enabled,this.opts=_.omit(d,["id","enabled"]),this.defaultOptions&&(this.opts=_.defaults(this.opts,this.defaultOptions)),this.init()}a.Component=a.defineClass(b,Object,a.ModelLike,{init:function(){},draw:function(){},destroy:function(){this.stopListening()},setParent:function(a){this.parent=a},toJSON:function(){var a=_.clone(this.opts);return a.id=this.id,a.type=this.constructor.Meta.name,a.enabled=this.enabled,a},setAttribute:function(a,b,c){var d=this.get(a);if("type"==a||_.isEqual(b,d))return!1;if("enabled"==a?this.enabled=b:"id"==a?this.id=b:this.opts[a]=b,this.onChange)try{for(var e=_.flatten([this.onChange[a]||[],this.onChange["*"]||[]]),f=0;f<e.length;f++)this[e[f]].call(this,b,a,d)}catch(g){"enabled"==a?this.enabled=d:"id"==a?this.id=d:this.opts[a]=d,this.lastError=g,this.trigger("error:"+a,this,b,c,g)}return!0},get:function(a){return"enabled"==a?this.enabled:"id"==a?this.id:this.opts[a]},getPath:function(){return _.isUndefined(this.parent)||_.isUndefined(this.id)?this.componentName+"#Main":this.parent.getIdString()+"/"+this.componentName+"#"+this.id}})}(Webvs),function(a){function b(a,c,d,e){b.super.constructor.call(this,a,c,d,e),delete this.opts.components}a.Container=a.defineClass(b,a.Component,{init:function(){var b=[];if(this.opts.components)for(var c=0;c<this.opts.components.length;c++){var d=this.opts.components[c],e=new(a.getComponentClass(d.type))(this.gl,this.main,this,d);b.push(e)}this.components=b},destroy:function(){b.super.destroy.call(this);for(var a=0;a<this.components.length;a++)this.components[a].destroy()},createComponent:function(b){return new(a.getComponentClass(b.type))(this.gl,this.main,this,b)},addComponent:function(b,c,d){var e;return b instanceof a.Component?(e=b,e.setParent(this)):e=this.createComponent(b),_.isNumber(c)||(c=this.components.length),this.components.splice(c,0,e),d=_.defaults({pos:c},d),this.trigger("addComponent",e,this,d),e},detachComponent:function(a,b){if(_.isString(a)){var c,d=a;for(c=0;c<this.components.length;c++)if(this.components[c].id==d){a=c;break}if(c==this.components.length)return}var e=this.components[a];return this.components.splice(a,1),b=_.defaults({pos:a},b),this.trigger("detachComponent",e,this,b),e},findComponent:function(a){var c;for(c=0;c<this.components.length;c++){var d=this.components[c];if(d.id==a)return d}for(c=0;c<this.components.length;c++){var e=this.components[c];if(e instanceof b){var f=e.findComponent(a);if(f)return f}}},toJSON:function(){var a=b.super.toJSON.call(this);a.components=[];for(var c=0;c<this.components.length;c++)a.components.push(this.components[c].toJSON());return a}})}(Webvs),function(a){function b(a,c,d,e){b.super.constructor.call(this,a,c,d,e)}a.registerComponent(b,{name:"EffectList"});var c=_.extend({IGNORE:50},a.BlendModes);b.ELBlendModes=c,a.defineClass(b,a.Container,{defaultOptions:{code:{init:"",perFrame:""},output:"REPLACE",input:"IGNORE",clearFrame:!1,enableOnBeat:!1,enableOnBeatFor:1},onChange:{code:"updateCode",output:"updateBlendMode",input:"updateBlendMode"},init:function(){b.super.init.call(this),this.fm=new a.FrameBufferManager(this.gl,this.main.copier,this.parent?!0:!1),this.updateCode(),this.updateBlendMode(this.opts.input,"input"),this.updateBlendMode(this.opts.output,"output"),this.frameCounter=0,this.first=!0,this.listenTo(this.main,"resize",this.handleResize)},draw:function(){var a=this.opts;if((!a.enableOnBeat||(this.main.analyser.beat?this.frameCounter=a.enableOnBeatFor:this.frameCounter>0&&this.frameCounter--,0!==this.frameCounter))&&(this.code.beat=this.main.analyser.beat?1:0,this.code.enabled=1,this.code.clear=a.clearFrame,this.inited||(this.inited=!0,this.code.init()),this.code.perFrame(),0!==this.code.enabled)){if(this.fm.setRenderTarget(),(a.clearFrame||this.first||this.code.clear)&&(this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.first=!1),this.input!==c.IGNORE){var b=this.parent.fm.getCurrentTexture();this.main.copier.run(this.fm,this.input,b)}for(var d=0;d<this.components.length;d++)this.components[d].enabled&&this.components[d].draw();this.fm.restoreRenderTarget(),this.output!=c.IGNORE&&(this.parent?this.main.copier.run(this.parent.fm,this.output,this.fm.getCurrentTexture()):this.main.copier.run(null,null,this.fm.getCurrentTexture()))}},destroy:function(){b.super.destroy.call(this),this.fm&&this.fm.destroy()},updateCode:function(){this.code=a.compileExpr(this.opts.code,["init","perFrame"]).codeInst,this.code.setup(this.main,this),this.inited=!1},updateBlendMode:function(b,d){this[d]=a.getEnumValue(b,c)},handleResize:function(){this.fm.resize(),this.code.updateDimVars(this.gl)}})}(Webvs),function(a){function b(c,d){d=_.defaults(d,{blendMode:a.REPLACE,swapFrame:!1,copyOnSwap:!1,dynamicBlend:!1,blendValue:.5});var e=["precision mediump float;","varying vec2 v_position;","uniform vec2 u_resolution;","uniform sampler2D u_srcTexture;","#define PI "+Math.PI,"#define getSrcColorAtPos(pos) (texture2D(u_srcTexture, pos))","#define setPosition(pos) (v_position = (((pos)+1.0)/2.0),gl_Position = vec4((pos), 0, 1))"],f=["precision mediump float;","varying vec2 v_position;","uniform vec2 u_resolution;","uniform sampler2D u_srcTexture;","#define PI "+Math.PI,"#define getSrcColorAtPos(pos) (texture2D(u_srcTexture, pos))","#define getSrcColor() (texture2D(u_srcTexture, v_position))"];if(this.gl=c,this.swapFrame=d.swapFrame,this.copyOnSwap=d.copyOnSwap,this.blendValue=d.blendValue,this.blendMode=d.blendMode,this.dynamicBlend=d.dynamicBlend,this.dynamicBlend)f.push("uniform int u_blendMode;","void setFragColor(vec4 color) {"),_.each(b.shaderBlendEq,function(a,b){f.push("   if(u_blendMode == "+b+") {","       gl_FragColor = ("+a+");","   }","   else")},this),f.push("   {","       gl_FragColor = color;","   }","}");else if(this._isShaderBlend(this.blendMode)){var g=b.shaderBlendEq[this.blendMode];f.push("#define setFragColor(color) (gl_FragColor = ("+g+"))")}else f.push("#define setFragColor(color) (gl_FragColor = color)");this.fragmentSrc=f.join("\n")+"\n"+d.fragmentShader.join("\n"),this.vertexSrc=e.join("\n")+"\n"+d.vertexShader.join("\n"),this._locations={},this._textureVars=[],this._arrBuffers={},this._compile()}b.shaderBlendEq=_.object([[a.MAXIMUM,"max(color, texture2D(u_srcTexture, v_position))"],[a.MULTIPLY,"clamp(color * texture2D(u_srcTexture, v_position) * 256.0, 0.0, 1.0)"]]),a.ShaderProgram=a.defineClass(b,Object,{_isShaderBlend:function(a){return a in b.shaderBlendEq},_compile:function(){var a=this.gl,b=this._compileShader(this.vertexSrc,a.VERTEX_SHADER),c=this._compileShader(this.fragmentSrc,a.FRAGMENT_SHADER),d=a.createProgram();if(a.attachShader(d,b),a.attachShader(d,c),a.linkProgram(d),!a.getProgramParameter(d,a.LINK_STATUS))throw new Error("Program link Error: "+a.getProgramInfoLog(d));this.vertex=b,this.fragment=c,this.program=d},_compileShader:function(b,c){var d=this.gl,e=d.createShader(c);if(d.shaderSource(e,b),d.compileShader(e),!d.getShaderParameter(e,d.COMPILE_STATUS))throw a.logShaderError(b,d.getShaderInfoLog(e)),new Error("Shader compilation Error: "+d.getShaderInfoLog(e));return e},draw:function(){},run:function(a,b){var c=this.gl,d=c.getParameter(c.CURRENT_PROGRAM);if(c.useProgram(this.program),b&&!this.dynamicBlend)throw new Error("Cannot set blendmode at runtime. Use dynamicBlend");b=b||this.blendMode,a&&(this.setUniform("u_resolution","2f",c.drawingBufferWidth,c.drawingBufferHeight),this.swapFrame||this._isShaderBlend(b)?(this.setUniform("u_srcTexture","texture2D",a.getCurrentTexture()),a.switchTexture(),this.copyOnSwap&&a.copyOver()):this.dynamicBlend&&this.setUniform("u_srcTexture","texture2D",null)),this.dynamicBlend&&this.setUniform("u_blendMode","1i",b),this._setGlBlendMode(b),this.draw.apply(this,_.drop(arguments,2)),c.disable(c.BLEND),c.useProgram(d)},_setGlBlendMode:function(b){var c=this.gl;switch(b){case a.ADDITIVE:c.enable(c.BLEND),c.blendFunc(c.ONE,c.ONE),c.blendEquation(c.FUNC_ADD);break;case a.SUBTRACTIVE1:c.enable(c.BLEND),c.blendFunc(c.ONE,c.ONE),c.blendEquation(c.FUNC_REVERSE_SUBTRACT);break;case a.SUBTRACTIVE2:c.enable(c.BLEND),c.blendFunc(c.ONE,c.ONE),c.blendEquation(c.FUNC_SUBTRACT);break;case a.ALPHA:c.enable(c.BLEND),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA),c.blendEquation(c.FUNC_ADD);break;case a.MULTIPLY2:c.enable(c.BLEND),c.blendFunc(c.DST_COLOR,c.ZERO),c.blendEquation(c.FUNC_ADD);break;case a.ADJUSTABLE:c.enable(c.BLEND),c.blendColor(0,0,0,this.blendValue),c.blendFunc(c.CONSTANT_ALPHA,c.ONE_MINUS_CONSTANT_ALPHA),c.blendEquation(c.FUNC_ADD);break;case a.AVERAGE:c.enable(c.BLEND),c.blendColor(.5,.5,.5,1),c.blendFunc(c.CONSTANT_COLOR,c.CONSTANT_COLOR),c.blendEquation(c.FUNC_ADD);break;case a.REPLACE:case a.MULTIPLY:case a.MAXIMUM:c.disable(c.BLEND);break;default:throw new Error("Unknown blend mode "+b+" in shader")}},getLocation:function(a,b){var c=this._locations[a];return _.isUndefined(c)&&(c=b?this.gl.getAttribLocation(this.program,a):this.gl.getUniformLocation(this.program,a),this._locations[a]=c),c},getTextureId:function(a){var b=_.indexOf(this._textureVars,a);return-1===b&&(this._textureVars.push(a),b=this._textureVars.length-1),b},setUniform:function(a,b,c){var d=this.getLocation(a),e=this.gl;switch(b){case"texture2D":var f=this.getTextureId(a);e.activeTexture(e["TEXTURE"+f]),e.bindTexture(e.TEXTURE_2D,c),e.uniform1i(d,f);break;case"1f":case"2f":case"3f":case"4f":case"1i":case"2i":case"3i":case"4i":var g=[d].concat(_.drop(arguments,2));e["uniform"+b].apply(e,g);break;case"1fv":case"2fv":case"3fv":case"4fv":case"1iv":case"2iv":case"3iv":case"4iv":e["uniform"+b].apply(e,d,c)}},setVertexAttribArray:function(a,b,c,d,e,f,g){var h=this.gl;c=c||2,d=d||h.FLOAT,e=e||!1,f=f||0,g=g||0;var i=this._arrBuffers[a];_.isUndefined(i)&&(i=h.createBuffer(),this._arrBuffers[a]=i);var j=this.getLocation(a,!0);h.bindBuffer(h.ARRAY_BUFFER,i),h.bufferData(h.ARRAY_BUFFER,b,h.STATIC_DRAW),h.enableVertexAttribArray(j),h.vertexAttribPointer(j,c,d,e,f,g)},setElementArray:function(a){var b=this.gl,c=this._arrBuffers.__indexBuffer;_.isUndefined(c)&&(c=b.createBuffer(),this._arrBuffers.__indexBuffer=c),b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,c),b.bufferData(b.ELEMENT_ARRAY_BUFFER,a,b.STATIC_DRAW)},destroy:function(){var a=this.gl;_.each(this._buffers,function(b){a.deleteBuffer(b)},this),a.deleteProgram(this.program),a.deleteShader(this.vertexShader),a.deleteShader(this.fragmentShader)}})}(Webvs),function(a){function b(a,c){c=_.defaults(c,{vertexShader:["attribute vec2 a_position;","void main() {","   setPosition(a_position);","}"]}),b.super.constructor.call(this,a,c)}a.QuadBoxProgram=a.defineClass(b,a.ShaderProgram,{draw:function(){this.setVertexAttribArray("a_position",new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1])),this.gl.drawArrays(this.gl.TRIANGLES,0,6)}})}(Webvs),function(a){function b(a,c){c=_.defaults(c||{},{fragmentShader:["uniform sampler2D u_copySource;","void main() {","   setFragColor(texture2D(u_copySource, v_position));","}"]}),b.super.constructor.call(this,a,c)}a.CopyProgram=a.defineClass(b,a.QuadBoxProgram,{draw:function(a){this.setUniform("u_copySource","texture2D",a),b.super.draw.call(this)}})}(Webvs),function(a){function b(a,b,c,d){this.gl=a,this.copier=b,this.initTexCount=_.isNumber(d)?d:2,this.textureOnly=c,this._initFrameBuffers()}a.FrameBufferManager=a.defineClass(b,Object,{_initFrameBuffers:function(){var a=this.gl;this.textureOnly||(this.framebuffer=a.createFramebuffer()),this.names={},this.textures=[];for(var b=0;b<this.initTexCount;b++)this.addTexture();this.curTex=0,this.isRenderTarget=!1},addTexture:function(a){if(a&&a in this.names)return this.names[a].refCount++,this.names[a];var b=this.gl,c=b.createTexture();return b.bindTexture(b.TEXTURE_2D,c),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.drawingBufferWidth,b.drawingBufferHeight,0,b.RGBA,b.UNSIGNED_BYTE,null),this.textures.push(c),a&&(this.names[a]={refCount:1,index:this.textures.length-1}),this.textures.length-1},removeTexture:function(a){if(_.isString(a)&&a in this.names&&this.names[a].refCount>1)return void this.names[a].refCount--;var b=this._findIndex(a);if(b==this.curTex&&(this.oldTexture||this.oldFrameBuffer))throw new Error("Cannot remove current texture when set as render target");var c=this.gl;c.deleteTexture(this.textures[b]),this.textures.splice(b,1),this.curTex>=this.textures.length&&(this.curTex=this.textures.lenght-1),delete this.names[a]},setRenderTarget:function(a){var b=this.gl,c=b.getParameter(b.FRAMEBUFFER_BINDING);if(this.textureOnly){if(!c)throw new Error("Cannot use textureOnly when current rendertarget is the default FrameBuffer");this.oldTexture=b.getFramebufferAttachmentParameter(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME)}else this.oldFrameBuffer=c,b.bindFramebuffer(b.FRAMEBUFFER,this.framebuffer);if(this.isRenderTarget=!0,_.isUndefined(a)){var d=this.textures[this.curTex];b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,d,0)}else this.switchTexture(a)},restoreRenderTarget:function(){var a=this.gl;this.textureOnly?(a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.oldTexture,0),this.oldTexture=null):(a.bindFramebuffer(a.FRAMEBUFFER,this.oldFrameBuffer),this.oldFrameBuffer=null),this.isRenderTarget=!1},getCurrentTexture:function(){return this.textures[this.curTex]},getTexture:function(a){var b=this._findIndex(a);return this.textures[b]},copyOver:function(){var a=this.textures.length,b=this.textures[(a+this.curTex-1)%a];this.copier.run(null,null,b)},switchTexture:function(a){if(!this.isRenderTarget)throw new Error("Cannot switch texture when not set as rendertarget");var b=this.gl;this.curTex=_.isUndefined(a)?this.curTex+1:this._findIndex(a),this.curTex%=this.textures.length;var c=this.textures[this.curTex];b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,c,0)},resize:function(){for(var a=this.gl,b=0;b<this.textures.length;b++)a.bindTexture(a.TEXTURE_2D,this.textures[b]),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.drawingBufferWidth,a.drawingBufferHeight,0,a.RGBA,a.UNSIGNED_BYTE,null)},destroy:function(){for(var a=this.gl,b=0;b<this.textures.length;b++)a.deleteTexture(this.textures[b]);this.textureOnly||a.deleteFramebuffer(this.frameBuffer)},_findIndex:function(a){var b;if(_.isString(a)&&a in this.names)b=this.names[a].index;else{if(!(_.isNumber(a)&&a>=0&&a<this.textures.length))throw new Error("Unknown texture '"+a+"'");b=a}return b}})}(Webvs),function(a){function b(a,c){b.super.constructor.call(this,a,{fragmentShader:["uniform vec3 u_color;","void main() {","   setFragColor(vec4(u_color, 1));","}"],blendMode:c})}a.ClearScreenProgram=a.defineClass(b,a.QuadBoxProgram,{draw:function(a){this.setUniform.apply(this,["u_color","3f"].concat(a)),b.super.draw.call(this)}})}(Webvs),function(a){function b(){}function c(a,b,c){this.operator=a,this.leftOperand=b,this.rightOperand=c}function d(a,b){this.operator=a,this.operand=b}function e(a,b){this.funcName=a,this.args=b}function f(a,b){this.lhs=a,this.expr=b}function g(a){this.statements=a}function h(a,b){this.value=a,this.type=b}a.AstBase=a.defineClass(b,Object),a.AstBinaryExpr=a.defineClass(c,b),a.AstUnaryExpr=a.defineClass(d,b),a.AstFuncCall=a.defineClass(e,b),a.AstAssignment=a.defineClass(f,b),a.AstProgram=a.defineClass(g,b),a.AstPrimaryExpr=a.defineClass(h,b)}(Webvs),Webvs.PegExprParser=function(){function a(a){return'"'+a.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var b={parse:function(b,c){function d(a){var b={};for(var c in a)b[c]=a[c];return b}function e(a,c){for(var d=a.offset+c,e=a.offset;d>e;e++){var f=b.charAt(e);"\n"===f?(a.seenCR||a.line++,a.column=1,a.seenCR=!1):"\r"===f||"\u2028"===f||"\u2029"===f?(a.line++,a.column=1,a.seenCR=!0):(a.column++,a.seenCR=!1)}a.offset+=c}function f(a){F.offset<H.offset||(F.offset>H.offset&&(H=d(F),I=[]),I.push(a))}function g(){var a="program@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g,i,j,k,l,m,n,o,p,q,r;if(p=d(F),q=d(F),g=x(),null!==g)if(i=h(),null!==i)if(j=x(),null!==j){for(k=[],r=d(F),59===b.charCodeAt(F.offset)?(l=";",e(F,1)):(l=null,0===G&&f('";"')),null!==l?(m=x(),null!==m?(n=h(),null!==n?(o=x(),null!==o?l=[l,m,n,o]:(l=null,F=d(r))):(l=null,F=d(r))):(l=null,F=d(r))):(l=null,F=d(r));null!==l;)k.push(l),r=d(F),59===b.charCodeAt(F.offset)?(l=";",e(F,1)):(l=null,0===G&&f('";"')),null!==l?(m=x(),null!==m?(n=h(),null!==n?(o=x(),null!==o?l=[l,m,n,o]:(l=null,F=d(r))):(l=null,F=d(r))):(l=null,F=d(r))):(l=null,F=d(r));null!==k?(59===b.charCodeAt(F.offset)?(l=";",e(F,1)):(l=null,0===G&&f('";"')),l=null!==l?l:"",null!==l?(m=x(),null!==m?g=[g,i,j,k,l,m]:(g=null,F=d(q))):(g=null,F=d(q))):(g=null,F=d(q))}else g=null,F=d(q);else g=null,F=d(q);else g=null,F=d(q);return null!==g&&(g=function(a,b,c,d){var e=[d[1]];return e=e.concat(_.map(d[3],function(a){return a[2]})),new Webvs.AstProgram(e)}(p.offset,p.line,p.column,g)),null===g&&(F=d(p)),J[a]={nextPos:d(F),result:g},g}function h(){var a="statement@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g,h,i,j,k,l,n;return l=d(F),n=d(F),g=s(),null!==g?(h=x(),null!==h?(61===b.charCodeAt(F.offset)?(i="=",e(F,1)):(i=null,0===G&&f('"="')),null!==i?(j=x(),null!==j?(k=m(),null!==k?g=[g,h,i,j,k]:(g=null,F=d(n))):(g=null,F=d(n))):(g=null,F=d(n))):(g=null,F=d(n))):(g=null,F=d(n)),null!==g&&(g=function(a,b,c,d,e){return new Webvs.AstAssignment(d,e)}(l.offset,l.line,l.column,g[0],g[4])),null===g&&(F=d(l)),null===g&&(g=m()),J[a]={nextPos:d(F),result:g},g}function i(){var a="unary_ops@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g;return 43===b.charCodeAt(F.offset)?(g="+",e(F,1)):(g=null,0===G&&f('"+"')),null===g&&(45===b.charCodeAt(F.offset)?(g="-",e(F,1)):(g=null,0===G&&f('"-"'))),J[a]={nextPos:d(F),result:g},g}function j(){var a="additive_ops@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g;return 43===b.charCodeAt(F.offset)?(g="+",e(F,1)):(g=null,0===G&&f('"+"')),null===g&&(45===b.charCodeAt(F.offset)?(g="-",e(F,1)):(g=null,0===G&&f('"-"'))),J[a]={nextPos:d(F),result:g},g}function k(){var a="multiplicative_ops@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g;return 42===b.charCodeAt(F.offset)?(g="*",e(F,1)):(g=null,0===G&&f('"*"')),null===g&&(47===b.charCodeAt(F.offset)?(g="/",e(F,1)):(g=null,0===G&&f('"/"')),null===g&&(37===b.charCodeAt(F.offset)?(g="%",e(F,1)):(g=null,0===G&&f('"%"')))),J[a]={nextPos:d(F),result:g},g}function l(){var a="boolean_ops@"+F.offset,c=J[a];
if(c)return F=d(c.nextPos),c.result;var g;return 38===b.charCodeAt(F.offset)?(g="&",e(F,1)):(g=null,0===G&&f('"&"')),null===g&&(124===b.charCodeAt(F.offset)?(g="|",e(F,1)):(g=null,0===G&&f('"|"'))),J[a]={nextPos:d(F),result:g},g}function m(){var a="boolean_expr@"+F.offset,b=J[a];if(b)return F=d(b.nextPos),b.result;var c,e,f,g,h,i,j,k,m;if(j=d(F),k=d(F),c=n(),null!==c){for(e=[],m=d(F),f=x(),null!==f?(g=l(),null!==g?(h=x(),null!==h?(i=n(),null!==i?f=[f,g,h,i]:(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m));null!==f;)e.push(f),m=d(F),f=x(),null!==f?(g=l(),null!==g?(h=x(),null!==h?(i=n(),null!==i?f=[f,g,h,i]:(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m));null!==e?c=[c,e]:(c=null,F=d(k))}else c=null,F=d(k);return null!==c&&(c=function(a,b,c,d,e){return C(d,e)}(j.offset,j.line,j.column,c[0],c[1])),null===c&&(F=d(j)),J[a]={nextPos:d(F),result:c},c}function n(){var a="additive_expr@"+F.offset,b=J[a];if(b)return F=d(b.nextPos),b.result;var c,e,f,g,h,i,k,l,m;if(k=d(F),l=d(F),c=o(),null!==c){for(e=[],m=d(F),f=x(),null!==f?(g=j(),null!==g?(h=x(),null!==h?(i=o(),null!==i?f=[f,g,h,i]:(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m));null!==f;)e.push(f),m=d(F),f=x(),null!==f?(g=j(),null!==g?(h=x(),null!==h?(i=o(),null!==i?f=[f,g,h,i]:(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m));null!==e?c=[c,e]:(c=null,F=d(l))}else c=null,F=d(l);return null!==c&&(c=function(a,b,c,d,e){return C(d,e)}(k.offset,k.line,k.column,c[0],c[1])),null===c&&(F=d(k)),J[a]={nextPos:d(F),result:c},c}function o(){var a="multiplicative_expr@"+F.offset,b=J[a];if(b)return F=d(b.nextPos),b.result;var c,e,f,g,h,i,j,l,m;if(j=d(F),l=d(F),c=p(),null!==c){for(e=[],m=d(F),f=x(),null!==f?(g=k(),null!==g?(h=x(),null!==h?(i=p(),null!==i?f=[f,g,h,i]:(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m));null!==f;)e.push(f),m=d(F),f=x(),null!==f?(g=k(),null!==g?(h=x(),null!==h?(i=p(),null!==i?f=[f,g,h,i]:(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m));null!==e?c=[c,e]:(c=null,F=d(l))}else c=null,F=d(l);return null!==c&&(c=function(a,b,c,d,e){return C(d,e)}(j.offset,j.line,j.column,c[0],c[1])),null===c&&(F=d(j)),J[a]={nextPos:d(F),result:c},c}function p(){var a="unary@"+F.offset,b=J[a];if(b)return F=d(b.nextPos),b.result;var c,e,f,g,h;return g=d(F),h=d(F),c=i(),null!==c?(e=x(),null!==e?(f=q(),null!==f?c=[c,e,f]:(c=null,F=d(h))):(c=null,F=d(h))):(c=null,F=d(h)),null!==c&&(c=function(a,b,c,d,e){return new Webvs.AstUnaryExpr(d,e)}(g.offset,g.line,g.column,c[0],c[2])),null===c&&(F=d(g)),null===c&&(c=q()),J[a]={nextPos:d(F),result:c},c}function q(){var a="func_call@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g,h,i,j,k,l,n,o,p,q,s,t;if(p=d(F),q=d(F),s=d(F),/^[a-zA-Z_]/.test(b.charAt(F.offset))?(g=b.charAt(F.offset),e(F,1)):(g=null,0===G&&f("[a-zA-Z_]")),null!==g){for(h=[],/^[a-zA-Z_0-9]/.test(b.charAt(F.offset))?(i=b.charAt(F.offset),e(F,1)):(i=null,0===G&&f("[a-zA-Z_0-9]"));null!==i;)h.push(i),/^[a-zA-Z_0-9]/.test(b.charAt(F.offset))?(i=b.charAt(F.offset),e(F,1)):(i=null,0===G&&f("[a-zA-Z_0-9]"));null!==h?g=[g,h]:(g=null,F=d(s))}else g=null,F=d(s);if(null!==g)if(h=x(),null!==h)if(40===b.charCodeAt(F.offset)?(i="(",e(F,1)):(i=null,0===G&&f('"("')),null!==i){for(s=d(F),j=[],t=d(F),k=x(),null!==k?(l=m(),null!==l?(n=x(),null!==n?(44===b.charCodeAt(F.offset)?(o=",",e(F,1)):(o=null,0===G&&f('","')),null!==o?k=[k,l,n,o]:(k=null,F=d(t))):(k=null,F=d(t))):(k=null,F=d(t))):(k=null,F=d(t));null!==k;)j.push(k),t=d(F),k=x(),null!==k?(l=m(),null!==l?(n=x(),null!==n?(44===b.charCodeAt(F.offset)?(o=",",e(F,1)):(o=null,0===G&&f('","')),null!==o?k=[k,l,n,o]:(k=null,F=d(t))):(k=null,F=d(t))):(k=null,F=d(t))):(k=null,F=d(t));null!==j?(k=x(),null!==k?(l=m(),null!==l?j=[j,k,l]:(j=null,F=d(s))):(j=null,F=d(s))):(j=null,F=d(s)),j=null!==j?j:"",null!==j?(k=x(),null!==k?(41===b.charCodeAt(F.offset)?(l=")",e(F,1)):(l=null,0===G&&f('")"')),null!==l?g=[g,h,i,j,k,l]:(g=null,F=d(q))):(g=null,F=d(q))):(g=null,F=d(q))}else g=null,F=d(q);else g=null,F=d(q);else g=null,F=d(q);return null!==g&&(g=function(a,b,c,d,e){var f=[];return _.each(e[0],function(a){f.push(a[1])}),f.push(e[2]),new Webvs.AstFuncCall(D(d),f)}(p.offset,p.line,p.column,g[0],g[3])),null===g&&(F=d(p)),null===g&&(g=r()),J[a]={nextPos:d(F),result:g},g}function r(){var a="primary_expr@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g,h,i,j,k;return g=w(),null===g&&(g=u(),null===g&&(g=v(),null===g&&(g=t(),null===g&&(j=d(F),k=d(F),40===b.charCodeAt(F.offset)?(g="(",e(F,1)):(g=null,0===G&&f('"("')),null!==g?(h=m(),null!==h?(41===b.charCodeAt(F.offset)?(i=")",e(F,1)):(i=null,0===G&&f('")"')),null!==i?g=[g,h,i]:(g=null,F=d(k))):(g=null,F=d(k))):(g=null,F=d(k)),null!==g&&(g=function(a,b,c,d){return d}(j.offset,j.line,j.column,g[1])),null===g&&(F=d(j)))))),J[a]={nextPos:d(F),result:g},g}function s(){var a="assignable@"+F.offset,b=J[a];if(b)return F=d(b.nextPos),b.result;var c;return c=v(),null===c&&(c=t()),J[a]={nextPos:d(F),result:c},c}function t(){var a="identifier@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g,h,i,j,k;if(j=d(F),k=d(F),/^[a-zA-Z_]/.test(b.charAt(F.offset))?(g=b.charAt(F.offset),e(F,1)):(g=null,0===G&&f("[a-zA-Z_]")),null!==g){for(h=[],/^[a-zA-Z_0-9]/.test(b.charAt(F.offset))?(i=b.charAt(F.offset),e(F,1)):(i=null,0===G&&f("[a-zA-Z_0-9]"));null!==i;)h.push(i),/^[a-zA-Z_0-9]/.test(b.charAt(F.offset))?(i=b.charAt(F.offset),e(F,1)):(i=null,0===G&&f("[a-zA-Z_0-9]"));null!==h?g=[g,h]:(g=null,F=d(k))}else g=null,F=d(k);return null!==g&&(g=function(a,b,c,d){return new Webvs.AstPrimaryExpr(D(d).toLowerCase(),"ID")}(j.offset,j.line,j.column,g)),null===g&&(F=d(j)),J[a]={nextPos:d(F),result:g},g}function u(){var a="constant@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g,h,i,j,k;if(j=d(F),k=d(F),36===b.charCodeAt(F.offset)?(g="$",e(F,1)):(g=null,0===G&&f('"$"')),null!==g){for(h=[],/^[a-zA-Z_0-9]/.test(b.charAt(F.offset))?(i=b.charAt(F.offset),e(F,1)):(i=null,0===G&&f("[a-zA-Z_0-9]"));null!==i;)h.push(i),/^[a-zA-Z_0-9]/.test(b.charAt(F.offset))?(i=b.charAt(F.offset),e(F,1)):(i=null,0===G&&f("[a-zA-Z_0-9]"));null!==h?g=[g,h]:(g=null,F=d(k))}else g=null,F=d(k);return null!==g&&(g=function(a,b,c,d){return new Webvs.AstPrimaryExpr(D(d).toLowerCase(),"CONST")}(j.offset,j.line,j.column,g[1])),null===g&&(F=d(j)),J[a]={nextPos:d(F),result:g},g}function v(){var a="register@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g,h,i,j,k,l,m;if(l=d(F),m=d(F),64===b.charCodeAt(F.offset)?(g="@",e(F,1)):(g=null,0===G&&f('"@"')),null!==g){for(h=[],/^[a-zA-Z_0-9]/.test(b.charAt(F.offset))?(i=b.charAt(F.offset),e(F,1)):(i=null,0===G&&f("[a-zA-Z_0-9]"));null!==i;)h.push(i),/^[a-zA-Z_0-9]/.test(b.charAt(F.offset))?(i=b.charAt(F.offset),e(F,1)):(i=null,0===G&&f("[a-zA-Z_0-9]"));null!==h?g=[g,h]:(g=null,F=d(m))}else g=null,F=d(m);return null!==g&&(g=function(a,b,c,d){return new Webvs.AstPrimaryExpr("__REG_AT_"+D(d).toLowerCase(),"REG")}(l.offset,l.line,l.column,g[1])),null===g&&(F=d(l)),null===g&&(l=d(F),m=d(F),/^[rR]/.test(b.charAt(F.offset))?(g=b.charAt(F.offset),e(F,1)):(g=null,0===G&&f("[rR]")),null!==g?(/^[eE]/.test(b.charAt(F.offset))?(h=b.charAt(F.offset),e(F,1)):(h=null,0===G&&f("[eE]")),null!==h?(/^[gG]/.test(b.charAt(F.offset))?(i=b.charAt(F.offset),e(F,1)):(i=null,0===G&&f("[gG]")),null!==i?(/^[0-9]/.test(b.charAt(F.offset))?(j=b.charAt(F.offset),e(F,1)):(j=null,0===G&&f("[0-9]")),null!==j?(/^[0-9]/.test(b.charAt(F.offset))?(k=b.charAt(F.offset),e(F,1)):(k=null,0===G&&f("[0-9]")),null!==k?g=[g,h,i,j,k]:(g=null,F=d(m))):(g=null,F=d(m))):(g=null,F=d(m))):(g=null,F=d(m))):(g=null,F=d(m)),null!==g&&(g=function(a,b,c,d){return new Webvs.AstPrimaryExpr("__REG_"+D(d).toLowerCase(),"REG")}(l.offset,l.line,l.column,g)),null===g&&(F=d(l))),J[a]={nextPos:d(F),result:g},g}function w(){var a="value@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g,h,i,j,k,l,m,n,o;for(m=d(F),n=d(F),g=[],/^[0-9]/.test(b.charAt(F.offset))?(h=b.charAt(F.offset),e(F,1)):(h=null,0===G&&f("[0-9]"));null!==h;)g.push(h),/^[0-9]/.test(b.charAt(F.offset))?(h=b.charAt(F.offset),e(F,1)):(h=null,0===G&&f("[0-9]"));if(null!==g)if(46===b.charCodeAt(F.offset)?(h=".",e(F,1)):(h=null,0===G&&f('"."')),null!==h){if(/^[0-9]/.test(b.charAt(F.offset))?(j=b.charAt(F.offset),e(F,1)):(j=null,0===G&&f("[0-9]")),null!==j)for(i=[];null!==j;)i.push(j),/^[0-9]/.test(b.charAt(F.offset))?(j=b.charAt(F.offset),e(F,1)):(j=null,0===G&&f("[0-9]"));else i=null;if(null!==i){if(o=d(F),/^[Ee]/.test(b.charAt(F.offset))?(j=b.charAt(F.offset),e(F,1)):(j=null,0===G&&f("[Ee]")),null!==j){if(/^[0-9]/.test(b.charAt(F.offset))?(l=b.charAt(F.offset),e(F,1)):(l=null,0===G&&f("[0-9]")),null!==l)for(k=[];null!==l;)k.push(l),/^[0-9]/.test(b.charAt(F.offset))?(l=b.charAt(F.offset),e(F,1)):(l=null,0===G&&f("[0-9]"));else k=null;null!==k?j=[j,k]:(j=null,F=d(o))}else j=null,F=d(o);j=null!==j?j:"",null!==j?g=[g,h,i,j]:(g=null,F=d(n))}else g=null,F=d(n)}else g=null,F=d(n);else g=null,F=d(n);if(null!==g&&(g=function(a,b,c,d){return new Webvs.AstPrimaryExpr(parseFloat(D(d)),"VALUE")}(m.offset,m.line,m.column,g)),null===g&&(F=d(m)),null===g){if(m=d(F),n=d(F),/^[a-fA-F0-9]/.test(b.charAt(F.offset))?(h=b.charAt(F.offset),e(F,1)):(h=null,0===G&&f("[a-fA-F0-9]")),null!==h)for(g=[];null!==h;)g.push(h),/^[a-fA-F0-9]/.test(b.charAt(F.offset))?(h=b.charAt(F.offset),e(F,1)):(h=null,0===G&&f("[a-fA-F0-9]"));else g=null;if(null!==g?(/^[hH]/.test(b.charAt(F.offset))?(h=b.charAt(F.offset),e(F,1)):(h=null,0===G&&f("[hH]")),null!==h?g=[g,h]:(g=null,F=d(n))):(g=null,F=d(n)),null!==g&&(g=function(a,b,c,d){return new Webvs.AstPrimaryExpr(parseInt(D(d),16),"VALUE")}(m.offset,m.line,m.column,g[0])),null===g&&(F=d(m)),null===g){if(m=d(F),n=d(F),/^[0-9]/.test(b.charAt(F.offset))?(h=b.charAt(F.offset),e(F,1)):(h=null,0===G&&f("[0-9]")),null!==h)for(g=[];null!==h;)g.push(h),/^[0-9]/.test(b.charAt(F.offset))?(h=b.charAt(F.offset),e(F,1)):(h=null,0===G&&f("[0-9]"));else g=null;null!==g?(/^[dD]/.test(b.charAt(F.offset))?(h=b.charAt(F.offset),e(F,1)):(h=null,0===G&&f("[dD]")),h=null!==h?h:"",null!==h?g=[g,h]:(g=null,F=d(n))):(g=null,F=d(n)),null!==g&&(g=function(a,b,c,d){return new Webvs.AstPrimaryExpr(parseInt(D(d),10),"VALUE")}(m.offset,m.line,m.column,g[0])),null===g&&(F=d(m))}}return J[a]={nextPos:d(F),result:g},g}function x(){var a="__@"+F.offset,b=J[a];if(b)return F=d(b.nextPos),b.result;var c,e;for(c=[],e=y(),null===e&&(e=z(),null===e&&(e=A()));null!==e;)c.push(e),e=y(),null===e&&(e=z(),null===e&&(e=A()));return J[a]={nextPos:d(F),result:c},c}function y(){var a="whiteSpace@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g;return/^[\t\x0B\f \xA0\uFEFF]/.test(b.charAt(F.offset))?(g=b.charAt(F.offset),e(F,1)):(g=null,0===G&&f("[\\t\\x0B\\f \\xA0\\uFEFF]")),J[a]={nextPos:d(F),result:g},g}function z(){var a="lineEnd@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g;return/^[\n\r\u2028\u2029]/.test(b.charAt(F.offset))?(g=b.charAt(F.offset),e(F,1)):(g=null,0===G&&f("[\\n\\r\\u2028\\u2029]")),J[a]={nextPos:d(F),result:g},g}function A(){var a="comment@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g,h,i,j,k,l,m;if(k=d(F),"/*"===b.substr(F.offset,2)?(g="/*",e(F,2)):(g=null,0===G&&f('"/*"')),null!==g){for(h=[],l=d(F),m=d(F),G++,"*/"===b.substr(F.offset,2)?(i="*/",e(F,2)):(i=null,0===G&&f('"*/"')),G--,null===i?i="":(i=null,F=d(m)),null!==i?(b.length>F.offset?(j=b.charAt(F.offset),e(F,1)):(j=null,0===G&&f("any character")),null!==j?i=[i,j]:(i=null,F=d(l))):(i=null,F=d(l));null!==i;)h.push(i),l=d(F),m=d(F),G++,"*/"===b.substr(F.offset,2)?(i="*/",e(F,2)):(i=null,0===G&&f('"*/"')),G--,null===i?i="":(i=null,F=d(m)),null!==i?(b.length>F.offset?(j=b.charAt(F.offset),e(F,1)):(j=null,0===G&&f("any character")),null!==j?i=[i,j]:(i=null,F=d(l))):(i=null,F=d(l));null!==h?("*/"===b.substr(F.offset,2)?(i="*/",e(F,2)):(i=null,0===G&&f('"*/"')),null!==i?g=[g,h,i]:(g=null,F=d(k))):(g=null,F=d(k))}else g=null,F=d(k);if(null===g)if(k=d(F),"//"===b.substr(F.offset,2)?(g="//",e(F,2)):(g=null,0===G&&f('"//"')),null!==g){for(h=[],l=d(F),m=d(F),G++,i=z(),G--,null===i?i="":(i=null,F=d(m)),null!==i?(b.length>F.offset?(j=b.charAt(F.offset),e(F,1)):(j=null,0===G&&f("any character")),null!==j?i=[i,j]:(i=null,F=d(l))):(i=null,F=d(l));null!==i;)h.push(i),l=d(F),m=d(F),G++,i=z(),G--,null===i?i="":(i=null,F=d(m)),null!==i?(b.length>F.offset?(j=b.charAt(F.offset),e(F,1)):(j=null,0===G&&f("any character")),null!==j?i=[i,j]:(i=null,F=d(l))):(i=null,F=d(l));null!==h?g=[g,h]:(g=null,F=d(k))}else g=null,F=d(k);return J[a]={nextPos:d(F),result:g},g}function B(a){a.sort();for(var b=null,c=[],d=0;d<a.length;d++)a[d]!==b&&(c.push(a[d]),b=a[d]);return c}function C(a,b){var c=a;return _.each(b,function(a){c=new Webvs.AstBinaryExpr(a[1],c,a[3])}),c}function D(a){return _.flatten(a).join("")}var E={program:g,statement:h,unary_ops:i,additive_ops:j,multiplicative_ops:k,boolean_ops:l,boolean_expr:m,additive_expr:n,multiplicative_expr:o,unary:p,func_call:q,primary_expr:r,assignable:s,identifier:t,constant:u,register:v,value:w,__:x,whiteSpace:y,lineEnd:z,comment:A};if(void 0!==c){if(void 0===E[c])throw new Error("Invalid rule name: "+a(c)+".")}else c="program";var F={offset:0,line:1,column:1,seenCR:!1},G=0,H={offset:0,line:1,column:1,seenCR:!1},I=[],J={},K=E[c]();if(null===K||F.offset!==b.length){var L=Math.max(F.offset,H.offset),M=L<b.length?b.charAt(L):null,N=F.offset>H.offset?F:H;throw new this.SyntaxError(B(I),M,L,N.line,N.column)}return K},toSource:function(){return this._source}};return b.SyntaxError=function(b,c,d,e,f){function g(b,c){var d,e;switch(b.length){case 0:d="end of input";break;case 1:d=b[0];break;default:d=b.slice(0,b.length-1).join(", ")+" or "+b[b.length-1]}return e=c?a(c):"end of input","Expected "+d+" but "+e+" found."}this.name="SyntaxError",this.expected=b,this.found=c,this.message=g(b,c),this.offset=d,this.line=e,this.column=f},b.SyntaxError.prototype=Error.prototype,b}(),function(a){function b(){}a.CodeInstance=a.defineClass(b,Object,{rand:function(a){return Math.floor(Math.random()*a)+1},gettime:function(a){switch(a){case 0:var b=(new Date).getTime();return(b-this._bootTime)/1e3;default:throw new Error("Invalid startTime mode for gettime call")}},getosc:function(a,b){for(var c=this._analyser.getWaveform(),d=Math.floor((a-b/2)*(c.length-1)),e=Math.floor((a+b/2)*(c.length-1)),f=0,g=d;e>=g;g++)f+=c[g];return f/(e-d+1)},bindUniforms:function(a){if(_.each(this._uniforms,function(b){a.setUniform(b,"1f",this[b])},this),_.each(this._glslRegisters,function(b){a.setUniform(b,"1f",this._registerBank[b])},this),this._hasRandom){var b=[Math.random()/100,Math.random()/100];a.setUniform("__randStep","2fv",b)}_.each(this._preCompute,function(b,c){var d=_.map(_.drop(b),function(a){return _.isString(a)?"__REG"==a.substring(0,5)?this._registerBank[a]:this[a]:a},this),e=this[b[0]].apply(this,d);a.setUniform(c,"1f",e)},this)},setup:function(a,b){this._registerBank=a.registerBank,this._bootTime=a.bootTime,this._analyser=a.analyser,this.updateDimVars(b.gl),_.each(this._registerUsages,function(b){_.has(a.registerBank,b)||(a.registerBank[b]=0)})},updateDimVars:function(a){this.w=a.drawingBufferWidth,this.h=a.drawingBufferHeight}}),b.clone=function(a,c){_.isArray(a)||(a.cid=0,a=[codeInst]);var d=a.length;return c>d?_.times(c-d,function(c){var e=Object.create(b.prototype);_.extend(e,a[0]),e.cid=c+d,a.push(e)}):d>c&&(a=_.first(this.clones,c)),a},b.copyValues=function(a,b){_.each(b,function(b,c){_.isFunction(c)||"_"===b.charAt(0)||(a[b]=c)})}}(Webvs),function(a){function b(b){var c={};for(var d in b)try{c[d]=a.PegExprParser.parse(b[d])}catch(e){throw new Error("Error parsing "+d+" ("+e.line+":"+e.column+") : "+e)}return c}function c(b,c,d,e){function g(b,c){var e;if(b instanceof a.AstProgram)for(e=0;e<b.statements.length;e++)g(b.statements[e],c);else if(b instanceof a.AstBinaryExpr)g(b.leftOperand,c),g(b.rightOperand,c);else if(b instanceof a.AstUnaryExpr)g(b.operand,c);else if(b instanceof a.AstFuncCall){if(f(b),_.contains(d,c)&&_.contains(j,b.funcName)){var k=_.every(b.args,function(b){return b instanceof a.AstPrimaryExpr});if(!k)throw new Error("Non Pre-Computable arguments for "+b.funcName+" in shader code, use variables or constants");var l,m=[b.funcName].concat(_.map(b.args,function(a){return a.value}));for(var n in h.preCompute)if(h.preCompute[n]==m)break;l||(l="__PC_"+b.funcName+"_"+i++,h.preCompute[l]=m),b.preComputeUniformName=l}for(h.funcCall[c].push(b.funcName),e=0;e<b.args.length;e++)g(b.args[e],c)}else b instanceof a.AstAssignment?(g(b.lhs,c),g(b.expr,c)):b instanceof a.AstPrimaryExpr&&"ID"===b.type?h.variable[c].push(b.value):b instanceof a.AstPrimaryExpr&&"REG"===b.type&&h.register[c].push(b.value)}var h={funcCall:{},variable:{},register:{},preCompute:{}},i=0;for(var k in b)h.funcCall[k]=[],h.variable[k]=[],h.register[k]=[],g(b[k],k),h.funcCall[k]=_.uniq(h.funcCall[k]),h.variable[k]=_.uniq(h.variable[k]),h.register[k]=_.uniq(h.register[k]);return h.jsVars=_.chain(h.variable).pick(c).values().flatten().uniq().value(),h.glslVars=_.chain(h.variable).pick(d).values().flatten().uniq().value(),h.nonUniforms=_.chain(h.glslVars).difference(h.jsVars).union(e).uniq().value(),h.uniforms=_.intersection(h.glslVars,h.jsVars),h.glslUsedFuncs=_.chain(h.funcCall).pick(d).values().flatten().uniq().value(),h.glslRegisters=_.chain(h.register).pick(d).values().flatten().uniq().value(),h}function d(b,c,d){function e(b){if(b instanceof a.AstBinaryExpr)return"("+e(b.leftOperand)+b.operator+e(b.rightOperand)+")";if(b instanceof a.AstUnaryExpr)return"("+b.operator+e(b.operand)+")";if(b instanceof a.AstFuncCall)switch(b.funcName){case"above":return["(",e(b.args[0]),">",e(b.args[1]),"?1:0)"].join("");case"below":return["(",e(b.args[0]),"<",e(b.args[1]),"?1:0)"].join("");case"equal":return["(",e(b.args[0]),"==",e(b.args[1]),"?1:0)"].join("");case"if":return["(",e(b.args[0]),"!==0?",e(b.args[1]),":",e(b.args[2]),")"].join("");case"select":var c=["((function() {"];return c.push("switch("+e(b.args[0])+") {"),_.each(_.last(b.args,b.args.length-1),function(a,b){c.push("case "+b+": return "+e(a)+";")}),c.push("default : throw new Error('Unknown selector value in select');"),c.push("}}).call(this))"),c.join("");case"sqr":return"(Math.pow(("+e(b.args[0])+"),2))";case"band":return"((("+e(b.args[0])+")&&("+e(b.args[1])+"))?1:0)";case"bor":return"((("+e(b.args[0])+")||("+e(b.args[1])+"))?1:0)";case"bnot":return"((!("+e(b.args[0])+"))?1:0)";case"invsqrt":return"(1/Math.sqrt("+e(b.args[0])+"))";case"atan2":return"(Math.atan(("+e(b.args[0])+")/("+e(b.args[1])+")))";default:var d,f=_.map(b.args,function(a){return e(a)}).join(",");return d=_.contains(i,b.funcName)?"Math.":"this.","("+d+b.funcName+"("+f+"))"}if(b instanceof a.AstAssignment)return e(b.lhs)+"="+e(b.expr);if(b instanceof a.AstProgram){var h=_.map(b.statements,function(a){return e(a)});return h.join(";\n")}return b instanceof a.AstPrimaryExpr&&"VALUE"===b.type?b.value.toString():b instanceof a.AstPrimaryExpr&&"CONST"===b.type?g(b.value).toString():b instanceof a.AstPrimaryExpr&&"ID"===b.type?"this."+b.value:b instanceof a.AstPrimaryExpr&&"REG"===b.type?'this._registerBank["'+b.value+'"]':void 0}var f,h=new a.CodeInstance;for(f=0;f<c.jsVars.length;f++)h[c.jsVars[f]]=0;for(f=0;f<d.length;f++){var j=d[f],k=b[j];if(k){var l=e(k);h[j]=new Function(l)}else h[j]=a.noop}return h._registerUsages=_.chain(c.register).values().flatten().uniq().value(),h._glslRegisters=c.glslRegisters,_.contains(c.glslUsedFuncs,"rand")&&(h._hasRandom=!0),h._uniforms=c.uniforms,h._preCompute=c.preCompute,h}function e(b,c,d){function e(b){if(b instanceof a.AstBinaryExpr)return"("+e(b.leftOperand)+b.operator+e(b.rightOperand)+")";if(b instanceof a.AstUnaryExpr)return"("+b.operator+e(b.operand)+")";if(b instanceof a.AstFuncCall){if(b.preComputeUniformName)return"("+b.preComputeUniformName+")";switch(b.funcName){case"above":return["(",e(b.args[0]),">",e(b.args[1]),"?1.0:0.0)"].join("");case"below":return["(",e(b.args[0]),"<",e(b.args[1]),"?1.0:0.0)"].join("");case"equal":return["(",e(b.args[0]),"==",e(b.args[1]),"?1.0:0.0)"].join("");case"if":return["(",e(b.args[0]),"!=0.0?",e(b.args[1]),":",e(b.args[2]),")"].join("");case"select":var c=e(b.args[0]),d=function(a,b){return 1==a.length?e(a[0]):["(("+c+" === "+b+")?","("+e(a[0])+"):","("+d(_.last(a,a.length-1),b+1)+"))"].join("")};return d(_.last(b.args,b.args.length-1),0);case"sqr":return"(pow(("+e(b.args[0])+"), 2))";case"band":return"(float(("+e(b.args[0])+")&&("+e(b.args[1])+")))";case"bor":return"(float(("+e(b.args[0])+")||("+e(b.args[1])+")))";case"bnot":return"(float(!("+e(b.args[0])+")))";case"invsqrt":return"(1/sqrt("+e(b.args[0])+"))";case"atan2":return"(atan(("+e(b.args[0])+"),("+e(b.args[1])+"))";default:var f=_.map(b.args,function(a){return e(a)}).join(",");return"("+b.funcName+"("+f+"))"}}if(b instanceof a.AstAssignment)return e(b.lhs)+"="+e(b.expr);if(b instanceof a.AstProgram){var h=_.map(b.statements,function(a){return e(a)});return h.join(";\n")+";"}return b instanceof a.AstPrimaryExpr&&"VALUE"===b.type?a.glslFloatRepr(b.value):b instanceof a.AstPrimaryExpr&&"CONST"===b.type?g(b.value).toString():b instanceof a.AstPrimaryExpr&&("ID"===b.type||"REG"===b.type)?b.value:void 0}var f,h=[];h=h.concat(_.map(c.nonUniforms,function(a){return"float "+a+" = 0.0;"})),h=h.concat(_.map(c.uniforms,function(a){return"uniform float "+a+";"})),h=h.concat(_.chain(c.glslUsedFuncs).map(function(a){return a in k?k[a]:[]}).flatten().value()),h=h.concat(_.chain(c.preCompute).keys().map(function(a){return"uniform float "+a+";"}).value());for(f=0;f<d.length;f++){var i=d[f],j=b[i];if(j){var l=e(j);h.push("void "+i+"() {"),h.push(l),h.push("}")}else h.push("void "+i+"() {}")}return h.join("\n")}function f(a){var b=h[a.funcName];if(void 0===b)throw Error("Unknown function "+a.funcName);if(_.isNumber(b)){if(a.args.length!=b)throw Error(a.funcName+" accepts "+b+" arguments")}else if(b.min&&a.args.length<b.min)throw Error(a.funcName+" accepts atleast "+b.min+" arguments")}function g(a){switch(a){case"pi":return Math.PI;case"e":return Math.E;case"phi":return 1.6180339887;default:throw new Error("Unknown constant "+a)}}a.compileExpr=function(a,f,g,h){f=f||[],g=g||[],h=h||[],a=_.chain(a).map(function(a,b){return _.isArray(a)&&(a=a.join("\n")),a=a.trim(),[b,a]}).filter(function(a){return a[1].length>0}).object().value();var i=b(a),j=c(i,f,g,h),k=d(i,j,f),l=e(i,j,g);return{codeInst:k,glslCode:l}};var h={above:2,below:2,equal:2,pow:2,sqr:1,sqrt:1,invsqrt:1,floor:1,ceil:1,abs:1,"if":3,min:2,max:2,sin:1,cos:1,tan:1,asin:1,acos:1,atan:1,atan2:2,log:1,band:2,bor:2,bnot:1,rand:1,gettime:1,getosc:3,select:{min:2}},i=["min","max","sin","cos","abs","tan","asin","acos","atan","log","pow","sqrt","floor","ceil"],j=["getosc","gettime"],k={rand:["uniform vec2 __randStep;","vec2 __randSeed;","float rand(float max) {","   __randSeed += __randStep;","   float val = fract(sin(dot(__randSeed.xy ,vec2(12.9898,78.233))) * 43758.5453);","   return (floor(val*max)+1);","}"].join("\n")}}(Webvs),function(a){function b(a,c,d,e){b.super.constructor.call(this,a,c,d,e)}a.registerComponent(b,{name:"GlobalVar",menu:"Misc"}),a.defineClass(b,a.Component,{defaultOptions:{code:{init:"",onBeat:"",perFrame:""}},onChange:{code:"updateCode"},init:function(){this.updateCode(),this.listenTo(this.main,"resize",this.handleResize)},draw:function(){var a=this.code;a.b=this.main.analyser.beat?1:0,this.inited||(a.init(),this.inited=!0),this.main.analyser.beat&&a.onBeat(),a.perFrame()},updateCode:function(){this.code=a.compileExpr(this.opts.code,["init","onBeat","perFrame"]).codeInst,this.code.setup(this.main,this),this.inited=!1},handleResize:function(){this.code.updateDimVars(this.gl)}})}(Webvs),function(a){function b(a,c,d,e){b.super.constructor.call(this,a,c,d,e)}a.registerComponent(b,{name:"BufferSave",menu:"Misc"});var c={SAVE:0,RESTORE:1,SAVERESTORE:2,RESTORESAVE:3};b.Actions=c,a.defineClass(b,a.Component,{defaultOptions:{action:"SAVE",bufferId:"buffer1",blendMode:"REPLACE"},onChange:{action:"updateAction",bufferId:"updateBuffer",blendMode:"updateBlendMode"},init:function(){this.updateAction(),this.updateBlendMode(),this.updateBuffer()},draw:function(){var a;this.action==c.SAVERESTORE||this.action==c.RESTORESAVE?(a=this.nextAction,this.nextAction=this.nextAction==c.SAVE?c.RESTORE:c.SAVE):a=this.action;var b=this.main.buffers;switch(a){case c.SAVE:b.setRenderTarget(this.opts.bufferId),this.main.copier.run(null,null,this.parent.fm.getCurrentTexture()),b.restoreRenderTarget();break;case c.RESTORE:this.main.copier.run(this.parent.fm,this.blendMode,b.getTexture(this.opts.bufferId))}},destroy:function(){b.super.destroy.call(this),this.main.buffers.removeTexture(this.opts.bufferId)},updateAction:function(){this.action=a.getEnumValue(this.opts.action,c),this.action==c.SAVERESTORE?this.nextAction=c.SAVE:this.action==c.RESTORESAVE&&(this.nextAction=c.RESTORE)},updateBuffer:function(a,b,c){this.opts.bufferId=this.opts.bufferId+"",c&&this.main.buffers.removeTexture(c),this.main.buffers.addTexture(this.opts.bufferId)},updateBlendMode:function(){this.blendMode=a.getEnumValue(this.opts.blendMode,a.BlendModes)}})}(Webvs),function(a){function b(a,c,d,e){b.super.constructor.call(this,a,c,d,e)}a.registerComponent(b,{name:"FadeOut",menu:"Trans"}),a.defineClass(b,a.Component,{defaultOptions:{speed:1,color:"#000000"},onChange:{speed:"updateSpeed",color:"updateColor"},init:function(){this.program=new a.ClearScreenProgram(this.gl,a.AVERAGE),this.updateSpeed(),this.updateColor()},draw:function(){this.frameCount++,this.frameCount==this.maxFrameCount&&(this.frameCount=0,this.program.run(this.parent.fm,null,this.color))},destroy:function(){b.super.destroy.call(this),this.program.destroy()},updateSpeed:function(){this.frameCount=0,this.maxFrameCount=Math.floor(1/this.opts.speed)},updateColor:function(){this.color=a.parseColorNorm(this.opts.color)}})}(Webvs),function(a){function b(a,c,d,e){b.super.constructor.call(this,a,c,d,e)}function c(b,e,f,g){var h="";switch(g){case d.WRAP:h="pos = vec2(pos.x<0?pos.x+1.0:pos.x%1, pos.y<0?pos.y+1.0:pos.y%1);";break;case d.EXTEND:h="pos = clamp(pos, vec2(0,0), vec2(1,1));"}var i,j,k=[],l=Math.floor(f/2);for(i=0;f>i;i++)for(j=0;f>j;j++){var m=e[i*f+j];0!==m&&(k.push("pos = v_position + texel * vec2("+(j-l)+","+(l-i)+");"),k.push(h),k.push("colorSum += texture2D(u_srcTexture, pos) * "+a.glslFloatRepr(m)+";"))}c.super.constructor.call(this,b,{swapFrame:!0,fragmentShader:["uniform float u_scale;","uniform float u_bias;","void main() {","   vec2 texel = 1.0/(u_resolution-vec2(1,1));","   vec2 pos;","   vec4 colorSum = vec4(0,0,0,0);",k.join("\n"),"   setFragColor(vec4(((colorSum+u_bias)/u_scale).rgb, 1.0));","}"]})}a.registerComponent(b,{name:"Convolution",menu:"Trans"});var d={EXTEND:0,WRAP:1};b.EdgeModes=d,a.defineClass(b,a.Component,{defaultOptions:{edgeMode:"EXTEND",autoScale:!0,scale:0,kernel:[0,0,0,0,1,0,0,0,0],bias:0},onChange:{edgeMode:"updateProgram",kernel:["updateProgram","updateScale"],scale:"updateScale"},init:function(){this.updateProgram(),this.updateScale()},draw:function(){this.program.run(this.parent.fm,null,this.scale,this.opts.bias)},destroy:function(){b.super.destroy.call(this),this.program.destroy()},updateScale:function(){var a=this.opts;this.scale=a.autoScale?_.reduce(a.kernel,function(a,b){return a+b},0):a.scale},updateProgram:function(){var b=this.opts;if(!_.isArray(b.kernel)||b.kernel.length%2!==1)throw new Error("Invalid convolution kernel");var c=Math.floor(Math.sqrt(b.kernel.length));if(c*c!=b.kernel.length)throw new Error("Invalid convolution kernel");this.program&&this.program.destroy();var e=a.getEnumValue(this.opts.edgeMode,d);this.program=new a.ConvolutionProgram(this.gl,b.kernel,c,e)}}),a.ConvolutionProgram=a.defineClass(c,a.QuadBoxProgram,{draw:function(a,b){this.setUniform("u_scale","1f",a),this.setUniform("u_bias","1f",b),c.super.draw.call(this)}})}(Webvs),function(a){function b(a,c,d,e){b.super.constructor.call(this,a,c,d,e)}function c(a,b,e){var f="";switch(b){case d.RED:f="srcColor.r";break;case d.GREEN:f="srcColor.g";break;case d.BLUE:f="srcColor.b";break;case d["(R+G+B)/2"]:f="min((srcColor.r+srcColor.g+srcColor.b)/2.0, 1.0)";break;case d["(R+G+B)/3"]:f="(srcColor.r+srcColor.g+srcColor.b)/3.0";break;case d.MAX:f="max(srcColor.r, max(srcColor.g, srcColor.b))"}c.super.constructor.call(this,a,{blendMode:e,swapFrame:!0,fragmentShader:["uniform sampler2D u_colorMap;","void main() {","   vec4 srcColor = getSrcColor();","   setFragColor(texture2D(u_colorMap, vec2(("+f+"), 0)));","}"]})}a.registerComponent(b,{name:"ColorMap",menu:"Trans"});var d={RED:0,GREEN:1,BLUE:2,"(R+G+B)/2":3,"(R+G+B)/3":4,MAX:5};b.MapKey=d;var e={SINGLE:0,ONBEATRANDOM:1,ONBEATSEQUENTIAL:2};b.MapCycleModes=e,a.defineClass(b,a.Component,{defaultOptions:{key:"RED",output:"REPLACE",mapCycleMode:"SINGLE",maps:[[{index:0,color:"#000000"},{index:255,color:"#FFFFFF"}]]},onChange:{maps:"updateMap",key:"updateProgram",mapCycleMode:"updateCycleMode",output:"updateProgram"},init:function(){this.updateProgram(),this.updateMap(),this.updateCycleMode()},draw:function(){this.main.analyser.beat&&(this.mapCycleMode==e.ONBEATRANDOM?this.currentMap=Math.floor(Math.random()*this.opts.maps.length):this.mapCycleMode==e.ONBEATSEQUENTIAL&&(this.currentMap=(this.currentMap+1)%this.colorMaps.length)),this.program.run(this.parent.fm,null,this.colorMaps[this.currentMap])},destroy:function(){b.super.destroy.call(this),this.program.destroy(),_.each(this.colorMaps,function(a){this.gl.deleteTexture(a)},this)},updateProgram:function(){this.program&&this.program.cleanup();var b=a.getEnumValue(this.opts.output,a.BlendModes),c=a.getEnumValue(this.opts.key,d);this.program=new a.ColorMapProgram(this.gl,c,b)},updateMap:function(){this.colorMaps&&_.each(this.colorMaps,function(a){this.gl.deleteTexture(a)},this),this.colorMaps=_.map(this.opts.maps,function(a){return this._buildColorMap(a)},this),this.currentMap=0},updateCycleMode:function(){this.mapCycleMode=a.getEnumValue(this.opts.mapCycleMode,e)},_buildColorMap:function(b){var c=this.gl;b=_.sortBy(b,function(a){return a.index});var d=_.map(b,function(a){return a.index});if(_.uniq(d).length!=d.length)throw new Error("map cannot have repeated indices");b=_.map(b,function(b){var c=a.parseColor(b.color);return{color:c,index:b.index}});var e=_.first(b);0!==e.index&&b.splice(0,0,{color:e.color,index:0});var f=_.last(b);255!==f.index&&b.push({color:f.color,index:255});var g=new Uint8Array(768),h=0,i=_.zip(_.first(b,b.length-1),_.last(b,b.length-1));_.each(i,function(a){var b=a[0],c=a[1],d=c.index-b.index;_.times(d,function(a){g[h++]=Math.floor((b.color[0]*(d-a)+c.color[0]*a)/d),g[h++]=Math.floor((b.color[1]*(d-a)+c.color[1]*a)/d),g[h++]=Math.floor((b.color[2]*(d-a)+c.color[2]*a)/d)})}),g[h++]=f.color[0],g[h++]=f.color[1],g[h++]=f.color[2];var j=c.createTexture();return c.bindTexture(c.TEXTURE_2D,j),c.texImage2D(c.TEXTURE_2D,0,c.RGB,256,1,0,c.RGB,c.UNSIGNED_BYTE,g),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),j}}),a.ColorMapProgram=a.defineClass(c,a.QuadBoxProgram,{draw:function(a){this.setUniform("u_colorMap","texture2D",a),c.super.draw.call(this)}})}(Webvs),function(a){function b(a,c,d,e){b.super.constructor.call(this,a,c,d,e)}function c(a){c.super.constructor.call(this,a,{swapFrame:!0,fragmentShader:["uniform int u_mode;","uniform vec3 u_color;","uniform vec3 u_outColor;","uniform float u_level;","void main() {","   vec4 inColor4 = getSrcColor();","   vec3 inColor = inColor4.rgb;","   bool clip = false;","   if(u_mode == 0) {","           clip = all(lessThanEqual(inColor, u_color));","   }","   if(u_mode == 1) {","           clip = all(greaterThanEqual(inColor, u_color));","   }","   if(u_mode == 2) {","           clip = (distance(inColor, u_color) <= u_level*0.5);","   }","   if(clip) {","       setFragColor(vec4(u_outColor, inColor4.a));","   } else {","       setFragColor(inColor4);","   }","}"]})
}a.registerComponent(b,{name:"ColorClip",menu:"Trans"});var d={BELOW:0,ABOVE:1,NEAR:2};b.ClipModes=d,a.defineClass(b,a.Component,{defaultOptions:{mode:"BELOW",color:"#202020",outColor:"#202020",level:0},onChange:{mode:"updateMode",color:"updateColor",outColor:"updateColor"},init:function(){this.program=new c(this.gl),this.updateColor(),this.updateMode()},draw:function(){this.program.run(this.parent.fm,null,this.mode,this.color,this.outColor,this.opts.level)},destroy:function(){b.super.destroy.call(this),this.program.destroy()},updateMode:function(){this.mode=a.getEnumValue(this.opts.mode,d)},updateColor:function(){this.color=a.parseColorNorm(this.opts.color),this.outColor=a.parseColorNorm(this.opts.outColor)}}),a.ColorClipProgram=a.defineClass(c,a.QuadBoxProgram,{draw:function(a,b,d,e){this.setUniform("u_mode","1i",a),this.setUniform.apply(this,["u_color","3f"].concat(b)),this.setUniform.apply(this,["u_outColor","3f"].concat(d)),this.setUniform("u_level","1f",e),c.super.draw.call(this)}})}(Webvs),function(a){function b(a,c,d,e){b.super.constructor.call(this,a,c,d,e)}function c(b,d,e,f,g,h,i){var j=[h,this.glslFilter(e,f),"void main() {",g?"__randSeed = v_position;":"","   x = v_position.x*2.0-1.0;","   y = -(v_position.y*2.0-1.0);",this.glslRectToPolar(d),"   alpha=0.5;","   perPixel();",this.glslPolarToRect(d),"   setFragColor(vec4(filter(vec2(x, -y)), "+(i?"alpha":"1.0")+"));","}"];c.super.constructor.call(this,b,{fragmentShader:j,blendMode:i?a.ALPHA:a.REPLACE,swapFrame:!0})}function d(b,c,e,f,g,h,i){var j=["attribute vec2 a_position;","varying vec2 v_newPoint;","varying float v_alpha;","uniform int u_coordMode;",h,"void main() {",g?"__randSeed = a_position;":"","   x = a_position.x;","   y = -a_position.y;",this.glslRectToPolar(c),"   alpha = 0.5;","   perPixel();","   v_alpha = alpha;",this.glslPolarToRect(c),"   v_newPoint = vec2(x,-y);","   setPosition(a_position);","}"],k=["varying vec2 v_newPoint;","varying float v_alpha;",this.glslFilter(e,f),"void main() {","   setFragColor(vec4(filter(v_newPoint), "+(i?"v_alpha":"1.0")+"));","}"];d.super.constructor.call(this,b,{blendMode:i?a.ALPHA:a.REPLACE,fragmentShader:k,vertexShader:j,swapFrame:!0})}a.registerComponent(b,{name:"DynamicMovement",menu:"Trans"});var e={POLAR:0,RECT:1};b.CoordModes=e,a.defineClass(b,a.Component,{defaultOptions:{code:{init:"",onBeat:"",perFrame:"",perPixel:""},gridW:16,gridH:16,blend:!1,noGrid:!1,compat:!1,bFilter:!0,coord:"POLAR"},onChange:{code:"updateCode",noGrid:["updateProgram","updateGrid"],compat:"updateProgram",bFilter:"updateProgram",coord:"updateProgram",blend:"updateProgram",gridW:"updateGrid",gridH:"updateGrid"},init:function(){this.updateCode(),this.updateGrid(),this.listenTo(this.main,"resize",this.handleResize)},draw:function(){var a=this.code;this.inited||(a.init(),a.inited=!0);var b=this.main.analyser.beat;a.b=b?1:0,a.perFrame(),b&&a.onBeat(),this.program.run(this.parent.fm,null,this.code,this.gridVertices,this.gridVerticesSize)},destroy:function(){b.super.destroy.call(this),this.program.destroy()},updateCode:function(){var b=a.compileExpr(this.opts.code,["init","onBeat","perFrame"],["perPixel"],["x","y","d","r","alpha"]),c=b.codeInst;c.setup(this.main,this),this.inited=!1,this.code=c,this.glslCode=b.glslCode,this.updateProgram()},updateProgram:function(){var b,c=this.opts,d=a.getEnumValue(this.opts.coord,e);b=c.noGrid?new a.DMovProgramNG(this.gl,d,c.bFilter,c.compat,this.code.hasRandom,this.glslCode,c.blend):new a.DMovProgram(this.gl,d,c.bFilter,c.compat,this.code.hasRandom,this.glslCode,c.blend),this.program&&this.program.destroy(),this.program=b},updateGrid:function(){var b=this.opts;if(b.noGrid)this.gridVertices=void 0,this.gridVerticesSize=void 0;else{for(var c=a.clamp(b.gridW,1,this.gl.drawingBufferWidth),d=a.clamp(b.gridH,1,this.gl.drawingBufferHeight),e=c/this.gl.drawingBufferWidth*2,f=d/this.gl.drawingBufferHeight*2,g=Math.ceil(this.gl.drawingBufferWidth/c),h=Math.ceil(this.gl.drawingBufferHeight/d),i=new Float32Array(g*h*6*2),j=0,k=-1,l=-1,m=0;h>m;m++){for(var n=0;g>n;n++){var o=Math.min(k+e,1),p=Math.min(l+f,1);i[j++]=k,i[j++]=l,i[j++]=o,i[j++]=l,i[j++]=k,i[j++]=p,i[j++]=o,i[j++]=l,i[j++]=o,i[j++]=p,i[j++]=k,i[j++]=p,k+=e}k=-1,l+=f}this.gridVertices=i,this.gridVerticesSize=j/2}},handleResize:function(){this.code.updateDimVars(this.gl)}});var f={glslRectToPolar:function(a){return a===e.POLAR?["float ar = u_resolution.x/u_resolution.y;","x=x*ar;","d = distance(vec2(x, y), vec2(0,0))/sqrt(2.0);","r = mod(atan(y, x)+PI*0.5, 2.0*PI);"].join("\n"):""},glslPolarToRect:function(a){return a===e.POLAR?["d = d*sqrt(2.0);","x = d*sin(r)/ar;","y = -d*cos(r);"].join("\n"):""},glslFilter:function(a,b){return a&&!b?["vec3 filter(vec2 point) {","   vec2 texel = 1.0/(u_resolution-vec2(1,1));","   vec2 coord = (point+1.0)/2.0;","   vec2 cornoff = fract(coord/texel);","   vec2 corn = floor(coord/texel)*texel;","   vec3 tl = getSrcColorAtPos(corn).rgb;","   vec3 tr = getSrcColorAtPos(corn + vec2(texel.x, 0)).rgb;","   vec3 bl = getSrcColorAtPos(corn + vec2(0, texel.y)).rgb;","   vec3 br = getSrcColorAtPos(corn + texel).rgb;","   vec3 pt = mix(tl, tr, cornoff.x);","   vec3 pb = mix(bl, br, cornoff.x);","   return mix(pt, pb, cornoff.y);","}"].join("\n"):a&&b?["vec3 filter(vec2 point) {","   vec2 texel = 1.0/(u_resolution-vec2(1,1));","   vec2 coord = (point+1.0)/2.0;","   vec2 corn = floor(coord/texel)*texel;","   ivec2 cornoff = (ivec2(fract(coord/texel)*255.0));","   ivec3 tl = ivec3(255.0 * getSrcColorAtPos(corn).rgb);","   ivec3 tr = ivec3(255.0 * getSrcColorAtPos(corn + vec2(texel.x, 0)).rgb);","   ivec3 bl = ivec3(255.0 * getSrcColorAtPos(corn + vec2(0, texel.y)).rgb);","   ivec3 br = ivec3(255.0 * getSrcColorAtPos(corn + texel).rgb);","   #define bt(i, j) int((float(i)/255.0)*float(j))","   int a1 = bt(255-cornoff.x,255-cornoff.y);","   int a2 = bt(cornoff.x    ,255-cornoff.y);","   int a3 = bt(255-cornoff.x,cornoff.y);","   int a4 = bt(cornoff.x    ,cornoff.y);","   float r = float(bt(a1,tl.r) + bt(a2,tr.r) + bt(a3,bl.r) + bt(a4,br.r))/255.0;","   float g = float(bt(a1,tl.g) + bt(a2,tr.g) + bt(a3,bl.g) + bt(a4,br.g))/255.0;","   float b = float(bt(a1,tl.b) + bt(a2,tr.b) + bt(a3,bl.b) + bt(a4,br.b))/255.0;","   return vec3(r,g,b);","}"].join("\n"):["vec3 filter(vec2 point) {","   return getSrcColorAtPos((point+1.0)/2.0).rgb;","}"].join("\n")}};a.DMovProgramNG=a.defineClass(c,a.QuadBoxProgram,f,{draw:function(a){a.bindUniforms(this),c.super.draw.call(this)}}),a.DMovProgram=a.defineClass(d,a.ShaderProgram,f,{draw:function(a,b,c){a.bindUniforms(this),this.setVertexAttribArray("a_position",b,2,this.gl.FLOAT,!1,0,0),this.gl.drawArrays(this.gl.TRIANGLES,0,c)}})}(Webvs),function(a){function b(a,c,d,e){b.super.constructor.call(this,a,c,d,e)}function c(a){c.super.constructor.call(this,a,{swapFrame:!0,fragmentShader:["uniform int u_channel;","void main() {","   vec3 color = getSrcColor().rgb;",_.flatMap(_.keys(d),function(a){return["if(u_channel == "+d[a]+") {","   setFragColor(vec4(color."+a.toLowerCase()+",1));","}"]}).join("\n"),"}"]})}a.registerComponent(b,{name:"ChannelShift",menu:"Trans"});var d={RGB:0,RBG:1,BRG:2,BGR:3,GBR:4,GRB:5};b.Channels=d,a.defineClass(b,a.Component,{defaultOptions:{channel:"RGB",onBeatRandom:!1},onChange:{channel:"updateChannel"},init:function(){this.program=new c(this.gl),this.updateChannel()},draw:function(){this.opts.onBeatRandom&&this.main.analyser.beat&&(this.channel=Math.floor(Math.random()*b.channels.length)),this.program.run(this.parent.fm,null,this.channel)},destroy:function(){b.super.destroy.call(this),this.program.destroy()},updateChannel:function(){this.channel=a.getEnumValue(this.opts.channel,d)}}),a.ChannelShiftProgram=a.defineClass(c,a.QuadBoxProgram,{draw:function(a){this.setUniform("u_channel","1i",a),c.super.draw.call(this)}})}(Webvs),function(a){function b(a,c,d,e){b.super.constructor.call(this,a,c,d,e)}function c(a,b){c.super.constructor.call(this,a,{blendMode:b,swapFrame:!0,fragmentShader:["uniform vec3 u_tone;","uniform bool u_invert;","void main() {","   vec4 srcColor = getSrcColor();","   float depth = max(srcColor.r, max(srcColor.g, srcColor.b));","   if(u_invert) {","       depth = 1.0-depth;","   }","   setFragColor(vec4(depth*u_tone, 1));","}"]})}a.registerComponent(b,{name:"UniqueTone",menu:"Trans"}),a.defineClass(b,a.Component,{defaultOptions:{color:"#ffffff",invert:!1,blendMode:"REPLACE"},onChange:{color:"updateColor",blendMode:"updateProgram"},init:function(){this.updateColor(),this.updateProgram()},draw:function(){this.program.run(this.parent.fm,null,this.tone,this.opts.invert)},destroy:function(){b.super.destroy.call(this),this.program.destroy()},updateColor:function(){this.tone=a.parseColorNorm(this.opts.color)},updateProgram:function(){var b=a.getEnumValue(this.opts.blendMode,a.BlendModes),d=new c(this.gl,b);this.program&&this.program.cleanup(),this.program=d}}),a.UniqueToneProgram=a.defineClass(c,a.QuadBoxProgram,{draw:function(a,b){this.setUniform.apply(this,["u_tone","3f"].concat(a)),this.setUniform("u_invert","1f",b?1:0),c.super.draw.call(this)}})}(Webvs),function(a){function b(a,c,d,e){b.super.constructor.call(this,a,c,d,e)}function c(a){c.super.constructor.call(this,a,{swapFrame:!0,fragmentShader:["void main() {","   setFragColor(vec4(1,1,1,1)-getSrcColor());","}"]})}a.registerComponent(b,{name:"Invert",menu:"Trans"}),a.defineClass(b,a.Component,{defaultOptions:{},init:function(){this.program=new c(this.gl)},draw:function(){this.program.run(this.parent.fm,null)},destroy:function(){b.super.destroy.call(this),this.program.destroy()}}),a.InvertProgram=a.defineClass(c,a.QuadBoxProgram)}(Webvs),function(a){function b(a,c,d,e){b.super.constructor.call(this,a,c,d,e)}function c(a,b){c.super.constructor.call(this,a,{swapFrame:!0,blendMode:b,fragmentShader:["uniform vec2 u_size;","void main() {","    vec2 samplePos = u_size * ( floor(v_position/u_size) + vec2(0.5,0.5) );","    setFragColor(getSrcColorAtPos(samplePos));","}"]})}a.registerComponent(b,{name:"Mosaic",menu:"Trans"}),a.defineClass(b,a.Component,{defaultOptions:{blendMode:"REPLACE",squareSize:.5,onBeatSizeChange:!1,onBeatSquareSize:1,onBeatSizeDuration:10},onChange:{blendMode:"updateProgram"},init:function(){this.frameCount=0,this.size=this.opts.squareSize,this.updateProgram()},draw:function(){if(this.opts.onBeatSizeChange&&this.main.analyser.beat&&(this.size=this.opts.onBeatSquareSize,this.frameCount=this.opts.onBeatSizeDuration),0!==this.size){var a=1/Math.floor(this.size*(this.gl.drawingBufferWidth-1)+1),b=1/Math.floor(this.size*(this.gl.drawingBufferHeight-1)+1);this.program.run(this.parent.fm,null,a,b)}if(this.frameCount>0)if(this.frameCount--,0===this.frameCount)this.size=this.opts.squareSize;else{var c=Math.abs(this.opts.squareSize-this.opts.onBeatSquareSize)/this.opts.onBeatSizeDuration;this.size+=c*(this.opts.onBeatSquareSize>this.opts.squareSize?-1:1)}},destroy:function(){b.super.destroy.call(this),this.program.destroy()},updateProgram:function(){var b=a.getEnumValue(this.opts.blendMode,a.BlendModes),c=new a.MosaicProgram(this.gl,b);this.program&&this.program.destroy(),this.program=c}}),a.MosaicProgram=a.defineClass(c,a.QuadBoxProgram,{draw:function(a,b){this.setUniform("u_size","2f",a,b),c.super.draw.call(this)}})}(Webvs),function(a){function b(a,c,d,e){b.super.constructor.call(this,a,c,d,e)}function c(a){c.super.constructor.call(this,a,{swapFrame:!0,fragmentShader:["uniform int u_mode;","uniform vec4 u_mix0;","uniform vec4 u_mix1;","uniform vec4 u_mix2;","uniform vec4 u_mix3;","#define getQuadrant(pos) ( (pos.x<0.5) ? (pos.y<0.5?2:0) : (pos.y<0.5?3:1) )","#define check(a,b, c,d,e,f) ( ((a==c || a==d) && (b==e || b==f)) || ((a==e || a==f) && (b==c || b==d)) )","#define xFlip(qa, qb) (check(qa,qb, 0,2, 1,3)?-1:1)","#define yFlip(qa, qb) (check(qa,qb, 0,1, 2,3)?-1:1)","#define mirrorPos(pos,qa,qb) ((pos-vec2(0.5,0.5))*vec2(xFlip(qa,qb),yFlip(qa,qb))+vec2(0.5,0.5))","#define getMirrorColor(pos,qa,qb) (getSrcColorAtPos(mirrorPos(pos,qa,qb)))","void main() {","    int quadrant = getQuadrant(v_position);","    vec4 mix;","    if(quadrant == 0)      { mix = u_mix0; }","    else if(quadrant == 1) { mix = u_mix1; }","    else if(quadrant == 2) { mix = u_mix2; }","    else if(quadrant == 3) { mix = u_mix3; }","    if(u_mode == 0) {","        int otherQuadrant = int(mix.x);","        setFragColor(getMirrorColor(v_position, quadrant, otherQuadrant));","    } else {","        vec4 c0 = getMirrorColor(v_position, quadrant, 0);","        vec4 c1 = getMirrorColor(v_position, quadrant, 1);","        vec4 c2 = getMirrorColor(v_position, quadrant, 2);","        vec4 c3 = getMirrorColor(v_position, quadrant, 3);","        setFragColor(vec4(","            dot(vec4(c0.r,c1.r,c2.r,c3.r), mix),","            dot(vec4(c0.g,c1.g,c2.g,c3.g), mix),","            dot(vec4(c0.b,c1.b,c2.b,c3.b), mix),","            1.0","        ));","    }","}"]})}a.registerComponent(b,{name:"Mirror",menu:"Trans"}),a.defineClass(b,a.Component,{defaultOptions:{onBeatRandom:!1,topToBottom:!0,bottomToTop:!1,leftToRight:!1,rightToLeft:!1,smoothTransition:!1,transitionDuration:4},onChange:{topToBottom:"updateMap",bottomToTop:"updateMap",leftToRight:"updateMap",rightToLeft:"updateMap"},init:function(){this.program=new c(this.gl),this.animFrameCount=0,this.mix=[[0,0,0,0],[1,0,0,0],[2,0,0,0],[3,0,0,0]],this.mixDelta=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],this.updateMap()},draw:function(){if(this.opts.onBeatRandom&&this.main.analyser.beat&&this._setQuadrantMap(!0),this.program.run(this.parent.fm,null,this._inTransition(),this.mix),this._inTransition())if(this.animFrameCount--,0===this.animFrameCount)this._setMix(!0);else for(var a=0;4>a;a++)for(var b=0;4>b;b++)this.mix[a][b]+=this.mixDelta[a][b]},updateMap:function(){this._setQuadrantMap(!1)},_inTransition:function(){return this.opts.smoothTransition&&0!==this.animFrameCount},_setQuadrantMap:function(a){var b=[0,1,2,3],c=this.opts;if(a){var d=Math.floor(16*Math.random());c={topToBottom:1&d&&this.opts.topToBottom,bottomToTop:2&d&&this.opts.bottomToTop,leftToRight:4&d&&this.opts.leftToRight,rightToLeft:8&d&&this.opts.rightToLeft}}c.topToBottom&&(b[2]=b[0],b[3]=b[1]),c.bottomToTop&&(b[0]=b[2],b[1]=b[3]),c.leftToRight&&(b[1]=b[0],b[3]=b[2]),c.rightToLeft&&(b[0]=b[1],b[2]=b[3]),this.map=b,this._setMix(!1)},_setMix:function(a){var b,c;if(this.opts.smoothTransition&&!a){if(0===this.animFrameCount)for(b=0;4>b;b++){var d=this.mix[b][0];this.mix[b][0]=0,this.mix[b][d]=1}for(b=0;4>b;b++)for(c=0;4>c;c++){var e=c==this.map[b]?1:0;this.mixDelta[b][c]=(e-this.mix[b][c])/this.opts.transitionDuration}this.animFrameCount=this.opts.transitionDuration}else for(b=0;4>b;b++)for(this.mix[b][0]=this.map[b],c=1;4>c;c++)this.mix[b][c]=0}}),a.MirrorProgram=a.defineClass(c,a.QuadBoxProgram,{draw:function(a,b){this.setUniform("u_mode","1i",a?1:0);for(var d=0;4>d;d++)this.setUniform.apply(this,["u_mix"+d,"4f"].concat(b[d]));c.super.draw.call(this)}})}(Webvs),function(a){function b(a,c,d,e){b.super.constructor.call(this,a,c,d,e)}function c(a,b){c.super.constructor.call(this,a,{copyOnSwap:!0,blendMode:b,vertexShader:["attribute vec2 a_position;","attribute vec3 a_color;","varying vec3 v_color;","uniform float u_pointSize;","void main() {","   gl_PointSize = u_pointSize;","   setPosition(a_position);","   v_color = a_color;","}"],fragmentShader:["varying vec3 v_color;","void main() {","   setFragColor(vec4(v_color, 1));","}"]})}a.registerComponent(b,{name:"SuperScope",menu:"Render"});var d={LINES:1,DOTS:2};b.DrawModes=d,a.defineClass(b,a.Component,{defaultOptions:{code:{init:"n=800",perFrame:"t=t-0.05",onBeat:"",perPoint:"d=i+v*0.2; r=t+i*$PI*4; x=cos(r)*d; y=sin(r)*d"},blendMode:"REPLACE",channel:"CENTER",source:"SPECTRUM",drawMode:"LINES",thickness:1,clone:1,colors:["#ffffff"],cycleSpeed:.01},onChange:{code:["updateCode","updateClones"],colors:"updateColors",cycleSpeed:"updateSpeed",clone:"updateClones",channel:"updateChannel",thickness:"updateThickness",blendMode:"updateProgram",drawMode:"updateDrawMode",source:"updateSource"},init:function(){this.updateDrawMode(),this.updateSource(),this.updateProgram(),this.updateCode(),this.updateClones(),this.updateSpeed(),this.updateColors(),this.updateChannel(),this.updateThickness(),this.listenTo(this.main,"resize",this.handleResize)},draw:function(){var a=this._makeColor();_.each(this.code,function(b){this.drawScope(b,a,!this.inited)},this),this.inited=!0},destroy:function(){b.super.destroy.call(this),this.program.destroy()},drawScope:function(b,c,e){this.gl;b.red=c[0],b.green=c[1],b.blue=c[2],e&&b.init();var f=this.main.analyser.beat;b.b=f?1:0,b.perFrame(),f&&b.onBeat();var g,h=Math.floor(b.n);g=this.source==a.Source.SPECTRUM?this.main.analyser.getSpectrum(this.channel):this.main.analyser.getWaveform(this.channel);var i,j,k,l,m,n,o,p,q=this.drawMode==d.DOTS,r=g.length/h,s=0,t=0;this.veryThick?(i=q?6*h:6*h-6,j=this.opts.thickness/this.gl.drawingBufferWidth,k=this.opts.thickness/this.gl.drawingBufferHeight):i=q?h:2*h-2;for(var u=new Float32Array(2*i),v=new Float32Array(3*i),w=0;h>w;w++){var x,y=0,z=0;for(x=Math.floor(w*r);(w+1)*r>x;x++,z++)y+=g[x];y/=z;var A=w/(h>1?h-1:1);if(b.i=A,b.v=y,b.perPoint(),b.y*=-1,this.veryThick)if(q)for(u[s++]=b.x-j,u[s++]=b.y-k,u[s++]=b.x+j,u[s++]=b.y-k,u[s++]=b.x-j,u[s++]=b.y+k,u[s++]=b.x+j,u[s++]=b.y-k,u[s++]=b.x-j,u[s++]=b.y+k,u[s++]=b.x+j,u[s++]=b.y+k,x=0;6>x;x++)v[t++]=b.red,v[t++]=b.green,v[t++]=b.blue;else{if(0!==w){var B=Math.abs(l-b.x),C=Math.abs(m-b.y),D=C>=B?j:0,E=B>C?k:0;for(u[s++]=l+D,u[s++]=m+E,u[s++]=b.x+D,u[s++]=b.y+E,u[s++]=l-D,u[s++]=m-E,u[s++]=b.x+D,u[s++]=b.y+E,u[s++]=l-D,u[s++]=m-E,u[s++]=b.x-D,u[s++]=b.y-E,x=0;6>x;x++)v[t++]=b.red,v[t++]=b.green,v[t++]=b.blue}l=b.x,m=b.y,n=b.red,o=b.green,p=b.blue}else if(q)u[s++]=b.x,u[s++]=b.y,v[t++]=b.red,v[t++]=b.green,v[t++]=b.blue;else{if(0!==w)for(u[s++]=l,u[s++]=m,u[s++]=b.x,u[s++]=b.y,x=0;2>x;x++)v[t++]=b.red,v[t++]=b.green,v[t++]=b.blue;l=b.x,m=b.y,n=b.red,o=b.green,p=b.blue}}this.program.run(this.parent.fm,null,u,v,q,this.veryThick?1:this.opts.thickness,this.veryThick)},updateProgram:function(){var b=a.getEnumValue(this.opts.blendMode,a.BlendModes),d=new c(this.gl,b);this.program&&this.program.destroy(),this.program=d},updateCode:function(){var b=a.compileExpr(this.opts.code,["init","onBeat","perFrame","perPoint"]).codeInst;b.n=100,b.setup(this.main,this),this.inited=!1,this.code=[b]},updateClones:function(){this.code=a.CodeInstance.clone(this.code,this.opts.clone)},updateColors:function(){this.colors=_.map(this.opts.colors,a.parseColorNorm),this.curColorId=0},updateSpeed:function(){var a=this.maxStep;this.maxStep=Math.floor(1/this.opts.cycleSpeed),this.curStep=this.curStep?Math.floor(this.curStep/a*this.maxStep):0},updateChannel:function(){this.channel=a.getEnumValue(this.opts.channel,a.Channels)},updateSource:function(){this.source=a.getEnumValue(this.opts.source,a.Source)},updateDrawMode:function(){this.drawMode=a.getEnumValue(this.opts.drawMode,d)},updateThickness:function(){var a;a=this.gl.getParameter(this.drawMode==d.DOTS?this.gl.ALIASED_POINT_SIZE_RANGE:this.gl.ALIASED_LINE_WIDTH_RANGE),this.veryThick=this.opts.thickness<a[0]||this.opts.thickness>a[1]?!0:!1},_makeColor:function(){if(1==this.colors.length)return this.colors[0];for(var a=[],b=this.colors[this.curColorId],c=this.colors[(this.curColorId+1)%this.colors.length],d=this.curStep/this.maxStep,e=0;3>e;e++)a[e]=b[e]*(1-d)+c[e]*d;return this.curStep=(this.curStep+1)%this.maxStep,0===this.curStep&&(this.curColorId=(this.curColorId+1)%this.colors.length),a},handleResize:function(){_.each(this.code,function(a){a.updateDimVars(this.gl)},this)}}),a.SuperScopeShader=a.defineClass(c,a.ShaderProgram,{draw:function(a,b,c,d,e){var f=this.gl;this.setUniform("u_pointSize","1f",d),this.setVertexAttribArray("a_position",a,2,f.FLOAT,!1,0,0),this.setVertexAttribArray("a_color",b,3,f.FLOAT,!1,0,0);var g;c||(g=f.getParameter(f.LINE_WIDTH),f.lineWidth(d));var h;h=e?f.TRIANGLES:c?f.POINTS:f.LINES,f.drawArrays(h,0,a.length/2),c||f.lineWidth(g)}})}(Webvs),function(a){function b(a,c,d,e){b.super.constructor.call(this,a,c,d,e)}function c(a){c.super.constructor.call(this,a,{copyOnSwap:!0,vertexShader:["uniform bool u_colorFilter;","attribute vec2 a_texVertex;","attribute vec2 a_vertex;","attribute vec3 a_color;","varying vec2 v_texVertex;","varying vec3 v_color;","void main() {","   if(u_colorFilter) {","       v_color = a_color;","   }","   v_texVertex = a_texVertex;","   setPosition(a_vertex);","}"],fragmentShader:["uniform bool u_colorFilter;","uniform sampler2D u_image;","varying vec2 v_texVertex;","varying vec3 v_color;","void main() {","   vec3 outColor = texture2D(u_image, v_texVertex).rgb;","   if(u_colorFilter) {","       outColor = outColor*v_color;","   }","   setFragColor(vec4(outColor, 1));","}"]})}a.registerComponent(b,{name:"Texer",menu:"Render"}),a.defineClass(b,a.Component,{defaultOptions:{code:{init:"",onBeat:"",perFrame:"",perPoint:""},imageSrc:"avsres_texer_circle_edgeonly_19x19.bmp",source:"SPECTRUM",resizing:!1,wrapAround:!1,clone:1,colorFiltering:!0},onChange:{code:"updateCode",clone:"updateClone",imageSrc:"updateImage",source:"updateSource"},init:function(){this.program=new c(this.gl),this.updateCode(),this.updateClone(),this.updateImage(),this.updateSource(),this.listenTo(this.main,"resize",this.handleResize)},draw:function(){_.each(this.code,function(a){this._drawScope(a,!this.inited)},this),this.inited=!0},destroy:function(){b.super.destroy.call(this),this.program.destroy(),this.gl.deleteTexture(this.texture)},updateCode:function(){var b=a.compileExpr(this.opts.code,["init","onBeat","perFrame","perPoint"]).codeInst;b.n=100,b.setup(this.main,this),this.inited=!1,this.code=[b]},updateClone:function(){this.code=a.CodeInstance.clone(this.code,this.opts.clone)},updateImage:function(){var a=this.gl;this.main.rsrcMan.getImage(this.opts.imageSrc,function(b){this.imagewidth=b.width,this.imageHeight=b.height,this.texture?a.bindTexture(a.TEXTURE_2D,this.texture):(this.texture=a.createTexture(),a.bindTexture(a.TEXTURE_2D,this.texture),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE)),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b)},null,this)},updateSource:function(){this.source=a.getEnumValue(this.opts.source,a.Source)},_drawScope:function(b,c){function d(a,b,c,d,e,f,g){-1-c>a||a>1||-1-d>b||b>1||(i.push(a,b,a+c,b,a+c,b+d,a,b+d),j.push(0,0,1,0,1,1,0,1),l&&l.push(e,f,g,e,f,g,e,f,g,e,f,g),k.push(m+0,m+1,m+2,m+0,m+2,m+3),m+=4)}c&&b.init();var e=this.main.analyser.beat;b.b=e?1:0,b.perFrame(),e&&b.onBeat();var f,g=Math.floor(b.n);f=this.source==a.Source.SPECTRUM?this.main.analyser.getSpectrum():this.main.analyser.getWaveform();for(var h=f.length/g,i=[],j=[],k=[],l=this.opts.colorFiltering?[]:null,m=0,n=this.imagewidth/this.gl.drawingBufferWidth*2,o=this.imageHeight/this.gl.drawingBufferHeight*2,p=0;g>p;p++){for(var q=0,r=0,s=Math.floor(p*h);(p+1)*h>s;s++,r++)q+=f[s];q/=r;var t=p/(g-1);b.i=t,b.v=q,b.sizex=1,b.sizey=1,b.red=1,b.green=1,b.blue=1,b.perPoint();var u=n,v=o;this.opts.resizing&&(u*=b.sizex,v*=b.sizey);var w=b.x-u/2,x=-b.y-v/2;if(d(w,x,u,v,b.red,b.green,b.blue),this.opts.wrapAround){var y=-1>w?2:w>1-u?-2:0,z=-1>x?2:x>1-v?-2:0;y&&d(y+w,x,u,v,b.red,b.green,b.blue),z&&d(w,z+x,u,v,b.red,b.green,b.blue),y&&z&&d(y+w,z+x,u,v,b.red,b.green,b.blue)}}this.program.run(this.parent.fm,null,new Float32Array(i),new Float32Array(j),new Uint16Array(k),l?new Float32Array(l):null,this.texture)},handleResize:function(){this.code.updateDimVars(this.gl)}}),a.TexerProgram=a.defineClass(c,a.ShaderProgram,{draw:function(a,b,c,d,e){this.setUniform("u_image","texture2D",e),this.setVertexAttribArray("a_vertex",a),this.setVertexAttribArray("a_texVertex",b),d?(this.setUniform("u_colorFilter","1f",1),this.setVertexAttribArray("a_color",d,3)):this.setUniform("u_colorFilter","1f",0),this.setElementArray(c),this.gl.drawElements(this.gl.TRIANGLES,c.length,this.gl.UNSIGNED_SHORT,0)}})}(Webvs),function(a){function b(a,c,d,e){b.super.constructor.call(this,a,c,d,e)}function c(a,b){c.super.constructor.call(this,a,{copyOnSwap:!0,blendMode:b,vertexShader:["attribute vec2 a_point;","uniform vec2 u_position;","uniform vec2 u_scale;","void main() {","   setPosition((a_point*u_scale)+u_position);","}"],fragmentShader:["uniform vec3 u_color;","void main() {","   setFragColor(vec4(u_color, 1));","}"]})}a.registerComponent(b,{name:"MovingParticle",menu:"Render"}),a.defineClass(b,a.Component,{defaultOptions:{color:"#FFFFFF",distance:.7,particleSize:10,onBeatSizeChange:!1,onBeatParticleSize:10,blendMode:"REPLACE"},onChange:{color:"updateColor",blendMode:"updateProgram"},init:function(){this.centerX=0,this.centerY=0,this.velocityX=0,this.velocityY=0,this.posX=0,this.posY=0,this._computeGeometry(),this.updateProgram(),this.updateColor()},_computeGeometry:function(){if(!a.MovingParticle.circleGeometry){var b=100,c=new Float32Array(2*(b+2)),d=0;c[d++]=0,c[d++]=0;for(var e=0;b>e;e++)c[d++]=Math.sin(2*e*Math.PI/b),c[d++]=Math.cos(2*e*Math.PI/b);c[d++]=c[2],c[d++]=c[3],a.MovingParticle.circleGeometry=c}},draw:function(){this.main.analyser.beat&&(this.centerX=.3*(2*Math.random()-1),this.centerY=.3*(2*Math.random()-1)),this.velocityX-=.004*(this.posX-this.centerX),this.velocityY-=.004*(this.posY-this.centerY),this.posX+=this.velocityX,this.posY+=this.velocityY,this.velocityX*=.991,this.velocityY*=.991;var b,c,d=this.posX*this.opts.distance,e=this.posY*this.opts.distance;this.opts.onBeatSizeChange&&this.main.analyser.beat?(b=this.opts.onBeatParticleSize,c=this.opts.onBeatParticleSize):(b=this.opts.particleSize,c=this.opts.particleSize),b=2*b/this.gl.drawingBufferWidth,c=2*c/this.gl.drawingBufferHeight,this.program.run(this.parent.fm,null,a.MovingParticle.circleGeometry,b,c,d,e,this.color)},updateProgram:function(){var b=a.getEnumValue(this.opts.blendMode,a.BlendModes),d=new c(this.gl,b);this.program&&this.program.destroy(),this.program=d},updateColor:function(){this.color=a.parseColorNorm(this.opts.color)},destroy:function(){b.super.destroy.call(this),this.program.destroy()}}),a.MovingParticleShader=a.defineClass(c,a.ShaderProgram,{draw:function(a,b,c,d,e,f){this.setUniform("u_scale","2f",b,c),this.setUniform("u_position","2f",d,e),this.setUniform.apply(this,["u_color","3f"].concat(f)),this.setVertexAttribArray("a_point",a),this.gl.drawArrays(this.gl.TRIANGLE_FAN,0,a.length/2)}})}(Webvs),function(a){function b(a,c,d,e){b.super.constructor.call(this,a,c,d,e)}a.registerComponent(b,{name:"ClearScreen",menu:"Render"}),a.defineClass(b,a.Component,{defaultOptions:{beatCount:0,color:"#000000",blendMode:"REPLACE"},onChange:{color:"updateColor",blendMode:"updateProgram"},init:function(){this.prevBeat=!1,this.beatCount=0,this.updateColor(),this.updateProgram()},draw:function(){var a=!1;0===this.opts.beatCount?a=!0:(this.main.analyser.beat&&!this.prevBeat&&(this.beatCount++,this.beatCount>=this.opts.beatCount&&(a=!0,this.beatCount=0)),this.prevBeat=this.main.analyser.beat),a&&this.program.run(this.parent.fm,null,this.color)},destroy:function(){b.super.destroy.call(this),this.program.destroy()},updateColor:function(){this.color=a.parseColorNorm(this.opts.color)},updateProgram:function(){var b=a.getEnumValue(this.opts.blendMode,a.BlendModes),c=new a.ClearScreenProgram(this.gl,b);this.program&&this.program.destroy(),this.program=c}})}(Webvs),function(a){function b(a,c,d,e){b.super.constructor.call(this,a,c,d,e)}function c(a){c.super.constructor.call(this,a,{copyOnSwap:!0,vertexShader:["attribute vec2 a_texVertex;","uniform vec2 u_pos;","uniform vec2 u_texRes;","varying vec2 v_texCoord;","void main() {","   v_texCoord = a_texVertex;","   setPosition(a_texVertex*(u_texRes/u_resolution)*vec2(2,-2)+u_pos);","}"],fragmentShader:["uniform sampler2D u_image;","varying vec2 v_texCoord;","void main() {","   setFragColor(texture2D(u_image, v_texCoord));","}"]})}a.registerComponent(b,{name:"Picture",menu:"Render"}),a.defineClass(b,a.Component,{defaultOptions:{src:"avsres_texer_circle_edgeonly_19x19.bmp",x:0,y:0},onChange:{src:"updateImage"},init:function(){this.program=new a.PictureProgram(this.gl),this.updateImage()},draw:function(){this.program.run(this.parent.fm,null,this.opts.x,this.opts.y,this.texture,this.width,this.height)},destroy:function(){b.super.destroy.call(this),this.program.destroy(),this.gl.deleteTexture(this.texture)},updateImage:function(){var a=this.gl;this.main.rsrcMan.getImage(this.opts.src,function(b){this.width=b.width,this.height=b.height,this.texture?a.bindTexture(a.TEXTURE_2D,this.texture):(this.texture=a.createTexture(),a.bindTexture(a.TEXTURE_2D,this.texture),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE)),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b)},null,this)}}),a.PictureProgram=a.defineClass(c,a.ShaderProgram,{draw:function(a,b,c,d,e){this.setUniform("u_pos","2f",a,-b),this.setUniform("u_texRes","2f",d,e),this.setUniform("u_image","texture2D",c),this.setVertexAttribArray("a_texVertex",new Float32Array([0,0,0,1,1,1,0,0,1,1,1,0])),this.gl.drawArrays(this.gl.TRIANGLES,0,6)}})}(Webvs);