!function(){function a(a,b,c){var d=function(){};if(d.prototype=b.prototype,a.prototype=new d,a.super=b.prototype,a.prototype.constructor=a,c)for(var e in c)a.prototype[e]=c[e]}function b(){}function c(a,b){for(var c in b){var d=b[c];if(!(d in a))throw new Error("Required option "+d+"not found")}}function d(a){return"[object Array]"===Object.prototype.toString.call(a)}function e(a,b){if(!e)throw new Error("Assertion Failed: "+b)}function f(a){c(a,["canvas","analyser"]),this.canvas=a.canvas,this.analyser=a.analyser,this._initGl()}function g(){}function h(a,b){this.vertexSrc=a,this.fragmentSrc=b}function i(a){var b=["attribute vec2 a_texCoord;","varying vec2 v_texCoord;","void main() {","    v_texCoord = a_texCoord;","    gl_Position = vec4((a_texCoord*2.0)-1.0, 0, 1);","}"].join("\n");i.super.constructor.call(this,b,a)}function j(a,b){this.codeSrc=a,this.externalVars=b?b:[],this._parseSrc()}function k(){}function l(){}function m(a,b,c){this.operator=a,this.leftOperand=b,this.rightOperand=c}function n(a,b){this.operator=a,this.operand=b}function o(a,b){this.funcName=a,this.args=b}function p(a,b){this.lhs=a,this.expr=b}function q(a){this.statements=a}function r(a,b){this.value=a,this.type=b}function s(a){var b;switch(a){case G.REPLACE:b="src";break;case G.MAXIMUM:b="max(src, dest)";break;case G.ADDITIVE:b="clamp(src+dest, vec4(0,0,0,0), vec4(1,1,1,1))";break;default:throw new Error("Invalid copy blend mode")}var c=["precision mediump float;","uniform sampler2D u_curRender;",a!=G.REPLACE?"uniform sampler2D u_destTexture;":"","varying vec2 v_texCoord;","void main() {",a!=G.REPLACE?"vec4 dest = texture2D(u_destTexture, v_texCoord);":"","   vec4 src = texture2D(u_curRender, v_texCoord);","   gl_FragColor = "+b+";","}"].join("\n");s.super.constructor.call(this,c)}function t(a){c(a,["components"]),this._constructComponent(a.components),this.output=a.output?G[a.output]:G.REPLACE,this.clearFrame=a.clearFrame?a.clearFrame:!1,this.first=!0,t.super.constructor.call(this)}function u(){}function v(a){this.dancer=a,this.beat=!1;var b=this;this.kick=a.createKick({onKick:function(){b.beat=!0},offKick:function(){b.beat=!1}}),this.kick.on()}function w(a){if(a=a?a:{},this.n=a.n?a.n:1,this.color=a.color?a.color:[0,0,0],3!=this.color.length)throw new Error("Invalid clear color, must be an array of 3");for(var b=0;b<this.color.length;b++)this.color[b]=this.color[b]/255;this.blend=a.blend?a.blend:!1,this.prevBeat=!1,this.beatCount=0;var c=["attribute vec2 a_position;","void main() {","   gl_Position = vec4(a_position, 0, 1);","}"].join("\n"),d=["precision mediump float;","uniform vec3 u_color;","void main() {","   gl_FragColor = vec4(u_color, 1);","}"].join("\n");w.super.constructor.call(this,c,d)}function x(a){c(a,["src","x","y"]),this.src=a.src,this.x=a.x,this.y=a.y;var b=["attribute vec2 a_texCoord;","varying vec2 v_texCoord;","uniform vec2 u_resolution;","uniform vec2 u_imageResolution;","uniform vec2 u_imagePos;","void main() {","    v_texCoord = a_texCoord*vec2(1,-1);","    vec2 clipSpace = ((a_texCoord*u_imageResolution+u_imagePos)/u_resolution)*2.0-1.0;","    gl_Position = vec4(clipSpace*vec2(1, -1), 0, 1);","}"].join("\n"),d=["precision mediump float;","uniform sampler2D u_image;","varying vec2 v_texCoord;","void main() {","   gl_FragColor = texture2D(u_image, v_texCoord);","}"].join("\n");x.super.constructor.call(this,b,d)}function y(a){c(a,["code"]);var b;if(a.code in y.examples)b=y.examples[a.code]();else{if("object"!=typeof a.code)throw new Error("Invalid superscope");b=a.code}var d=new j(b,["n","v","i","x","y","b","w","h","red","green","blue"]),e=d.generateCode(["init","onBeat","perFrame","perPoint"],[],[]);this.code=e[0],this.code.n=100,this.spectrum=a.spectrum?a.spectrum:!1,this.dots=a.dots?a.dots:!1;for(var f=a.colors?a.colors:[[255,255,255]],g=0;g<f.length;g++){if(3!=f[g].length)throw new Error("Invalid color, must be an array of 3");for(var h=0;3>h;h++)f[g][h]=f[g][h]/255}this.colors=f,this.currentColor=f[0],this.maxStep=100,this.step=this.maxStep,this.colorId=0,this.colorStep=[0,0,0],this.thickness=a.thickness?a.thickness:1,this.inited=!1;var i=["attribute vec2 a_position;","attribute vec3 a_color;","varying vec3 v_color;","uniform float u_pointSize;","void main() {","   gl_PointSize = u_pointSize;","   gl_Position = vec4(clamp(a_position, vec2(-1,-1), vec2(1,1)), 0, 1);","   v_color = a_color;","}"].join("\n"),k=["precision mediump float;","varying vec3 v_color;","void main() {","   gl_FragColor = vec4(v_color, 1);","}"].join("\n");y.super.constructor.call(this,i,k)}function z(a){if(a=_.defaults(a,{channel:"RGB",onBeatRandom:!1}),this.channel=this.channels.indexOf(a.channel),-1==this.channel)throw new Error("Invalid Channel");this.onBeatRandom=a.onBeatRandom;var b=["precision mediump float;","uniform vec2 u_resolution;","uniform sampler2D u_curRender;","varying vec2 v_texCoord;","uniform int u_channel;","void main() {","   vec3 color = texture2D(u_curRender, v_texCoord).rgb;",_.flatMap(this.channels,function(a,b){return["if(u_channel == "+b+") {","   gl_FragColor = vec4(color."+a.toLowerCase()+",1);","}"]}).join("\n"),"}"].join("\n");z.super.constructor.call(this,b)}function A(a){c(a,["kernel"]);var b=["precision mediump float;","uniform vec2 u_resolution;","uniform sampler2D u_curRender;","varying vec2 v_texCoord;","uniform float u_kernel[9];","uniform float u_kernelWeight;","void main() {","   vec2 onePixel = vec2(1.0, 1.0)/u_resolution;","   vec4 colorSum = texture2D(u_curRender, v_texCoord + onePixel * vec2(-1, 1)) * u_kernel[0] + ","                   texture2D(u_curRender, v_texCoord + onePixel * vec2(0, -1)) * u_kernel[1] + ","                   texture2D(u_curRender, v_texCoord + onePixel * vec2(1, -1)) * u_kernel[2] + ","                   texture2D(u_curRender, v_texCoord + onePixel * vec2(-1, 0)) * u_kernel[3] + ","                   texture2D(u_curRender, v_texCoord + onePixel * vec2(0, 0))  * u_kernel[4] + ","                   texture2D(u_curRender, v_texCoord + onePixel * vec2(1, 0))  * u_kernel[5] + ","                   texture2D(u_curRender, v_texCoord + onePixel * vec2(-1, 1)) * u_kernel[6] + ","                   texture2D(u_curRender, v_texCoord + onePixel * vec2(0, 1))  * u_kernel[7] + ","                   texture2D(u_curRender, v_texCoord + onePixel * vec2(1, 1))  * u_kernel[8];","   gl_FragColor = vec4((colorSum / u_kernelWeight).rgb, 1.0);","}"].join("\n");if(a.kernel in A.kernels)this.kernel=A.kernels[a.kernel];else{if(!d(a.kernel)||9!=a.kernel.length)throw new Error("Invalid convolution kernel");this.kernel=a.kernel}for(var e=0,f=0;f<this.kernel.length;f++)e+=this.kernel[f];this.kernelWeight=e,A.super.constructor.call(this,b)}function B(a){c(a,["code"]),a=_.defaults(a,{gridW:16,gridH:16,coord:"POLAR"});var b;if(a.code in B.examples)b=B.examples[a.code];else{if("object"!=typeof a.code)throw new Error("Invalid Dynamic movement code");b=a.code}var d=new j(b,["x","y","r","d","b","w","h"]),e=d.generateCode(["init","onBeat","perFrame"],["perPixel"],["x","y","d","r"]);this.code=e[0],this.inited=!1,this.gridW=a.gridW,this.gridH=a.gridH,this.coordMode=a.coord;var f="";"POLAR"===this.coordMode&&(f=["d = distance(a_position, vec2(0,0));","r = atan(a_position.x, a_position.y);"].join("\n"));var g="";"POLAR"===this.coordMode&&(g=["x = d*sin(r);","y = -d*cos(r);"].join("\n"));var h=["precision mediump float;","attribute vec2 a_position;","varying vec2 v_newPoint;","uniform vec2 u_resolution;","uniform int u_coordMode;",e[1],"void main() {",this.code.hasRandom?"__randSeed = a_position;":"","   x = a_position.x;","   y = -a_position.y;",f,"   perPixel();",g,"   v_newPoint = vec2(x,-y);","   gl_Position = vec4(a_position, 0, 1);","}"].join("\n"),i=["precision mediump float;","varying vec2 v_newPoint;","uniform sampler2D u_curRender;","void main() {","   gl_FragColor = vec4(texture2D(u_curRender, mod((v_newPoint+1.0)/2.0, 1.0)).rgb, 1);","}"].join("\n");B.super.constructor.call(this,h,i)}function C(a){if(a=a?a:{},this.speed=a.speed?a.speed:1,this.color=a.color?a.color:[0,0,0],3!=this.color.length)throw new Error("Invalid clear color, must be an array of 3");for(var b=0;b<this.color.length;b++)this.color[b]=this.color[b]/255;this.frameCount=0,this.maxFrameCount=Math.floor(1/this.speed);var c=["attribute vec2 a_position;","void main() {","   gl_Position = vec4(a_position, 0, 1);","}"].join("\n"),d=["precision mediump float;","uniform vec3 u_color;","void main() {","   gl_FragColor = vec4(u_color, 1);","}"].join("\n");C.super.constructor.call(this,c,d)}var E=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){return window.setTimeout(a,1e3/60)},F=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||function(a){return window.clearTimeout(a)};_.flatMap=_.compose(_.flatten,_.map),a(f,Object,{_initGl:function(){try{this.gl=this.canvas.getContext("experimental-webgl"),this.resolution={width:this.canvas.width,height:this.canvas.height}}catch(a){throw new Error("Couldnt get webgl context"+a)}},loadPreset:function(a){this.preset=a,this.stop(),this.rootComponent&&this.rootComponent.destroyComponent(),this.rootComponent=new t(a)},resetCanvas:function(){this.stop(),this.rootComponent&&(this.rootComponent.destroyComponent(),this.rootComponent=null),this._initGl(),this.preset&&(this.rootComponent=new t(this.preset))},start:function(){if(this.rootComponent){this.registerBank={};var a=this.rootComponent,b=a.initComponent(this.gl,this.resolution,this.analyser,this.registerBank),c=this,d=function(){c.analyser.isPlaying()&&a.updateComponent(),c.animReqId=E(d)};b.then(function(){c.animReqId=E(d)})}},stop:function(){"undefined"!=typeof this.animReqId&&F(this.animReqId)}}),a(g,Object,{swapFrame:!1,initComponent:function(a,b,c,d){this.gl=a,this.resolution=b,this.analyser=c,this.registerBank=d},updateComponent:function(){},destroyComponent:function(){}}),a(h,g,{swapFrame:!1,initComponent:function(a,b,c,d){h.super.initComponent.call(this,a,b,c,d),this._compileProgram(this.vertexSrc,this.fragmentSrc),this.resolutionLocation=this.gl.getUniformLocation(this.program,"u_resolution"),this.init()},updateComponent:function(){h.super.updateComponent.apply(this,arguments),this.gl.uniform2f(this.resolutionLocation,this.resolution.width,this.resolution.height),this.update.apply(this,arguments)},destroyComponent:function(){var a=this.gl;a.deleteShader(this.vertex),a.deleteShader(this.fragment),a.deleteProgram(this.program)},_compileProgram:function(a,b){var c=this.gl,d=this._compileShader(a,c.VERTEX_SHADER),e=this._compileShader(b,c.FRAGMENT_SHADER),f=c.createProgram();if(c.attachShader(f,d),c.attachShader(f,e),c.linkProgram(f),!c.getProgramParameter(f,c.LINK_STATUS))throw new Error("Program link Error: "+c.getProgramInfoLog(f));this.vertex=d,this.fragment=e,this.program=f},_compileShader:function(a,b){var c=this.gl,d=c.createShader(b);if(c.shaderSource(d,a),c.compileShader(d),!c.getShaderParameter(d,c.COMPILE_STATUS))throw new Error("Shader compilation Error: "+c.getShaderInfoLog(d));return d},init:function(){},update:function(){}}),a(i,h,{swapFrame:!0,destroyComponent:function(){i.super.destroyComponent.call(this);var a=this.gl;a.deleteBuffer(this.texCoordBuffer)},init:function(){var a=this.gl;this.texCoordBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.texCoordBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),a.STATIC_DRAW),this.vertexPositionLocation=a.getAttribLocation(this.program,"a_texCoord"),this.curRenderLocation=a.getUniformLocation(this.program,"u_curRender")},update:function(a){var b=this.gl;b.activeTexture(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,a),b.uniform1i(this.curRenderLocation,0),b.bindBuffer(b.ARRAY_BUFFER,this.texCoordBuffer),b.enableVertexAttribArray(this.vertexPositionLocation),b.vertexAttribPointer(this.vertexPositionLocation,2,b.FLOAT,!1,0,0),b.drawArrays(b.TRIANGLES,0,6)}});var G={REPLACE:1,MAXIMUM:2,ADDITIVE:3};window.Webvs=f,a(j,Object,{_parseSrc:function(){var a={},b={},c={},d=[];for(var e in this.codeSrc)try{a[e]=f.PegExprParser.parse(this.codeSrc[e]);var g=[],h=[];this._getVars(a[e],g,h,d),b[e]=_.uniq(g),c[e]=_.uniq(h)}catch(i){throw new Error("Error parsing "+e+"("+i.line+":"+i.column+")"+" : "+i)}this.codeAst=a,this.funcUsages=c;var j=[];for(var k in b)for(var l in b)l!=k&&(j=j.concat(_.intersection(b[k],b[l])));this.instanceVars=_.uniq(this.externalVars.concat(j)),this.registerUsages=_.uniq(d);var m={};for(var n in b)m[n]=_.difference(b[n],this.instanceVars,this.registerUsages);this.localVars=m},generateCode:function(a,c,d){var e=new k,f=this,g=[];_.each(this.instanceVars,function(a){e[a]=0;var b="";_.contains(d,a)||(b="uniform "),g.push(b+"float "+a+";")});var h=_.intersection(_.keys(this.codeAst),a),i=_.difference(a,h);_.each(h,function(a){var b=f.codeAst[a],c=f._generateJs(b,f.localVars[a]);e[a]=new Function(c)}),_.each(i,function(a){e[a]=b});var j=_.intersection(_.keys(this.codeAst),c),l=_.difference(c,j),m=_.uniq(_.flatMap(j,function(a){return f.funcUsages[a]}));return _.each(m,function(a){g.push(f.glslFuncCode[a])}),_.each(j,function(a){var b=f.codeAst[a],c=f._generateGlsl(b,f.localVars[a]);g.push("void "+a+"() {"),g.push(c),g.push("}")}),_.each(l,function(a){g.push("void "+a+"() {}")}),_.contains(j,"rand")&&(e.hasRandom=!0),e._treatAsNonUniform=d,e._registerUsages=this.registerUsages,[e,g.join("")]},funcArgLengths:{above:2,below:2,equal:2,pow:2,"if":3,sin:1,cos:1,tan:1,asin:1,acos:1,atan:1,log:1,rand:1},jsMathFuncs:["sin","cos","tan","asin","acos","atan","log","pow"],glslFuncCode:{rand:["uniform vec2 __randStep;","vec2 __randSeed;","float rand(float max) {","   __randCur += __randStep;","   float val = fract(sin(dot(__randSeed.xy ,vec2(12.9898,78.233))) * 43758.5453);","   return (floor(val*max)+1);","}"].join("\n")},_checkFunc:function(a){var b=this.funcArgLengths[a.funcName];if(void 0===b)throw Error("Unknown function "+a.funcName);if(a.args.length!=b)throw Error(a.funcName+" accepts "+b+" arguments")},_generateGlsl:function(a,b){var c=this;if(a instanceof m)return"("+this._generateGlsl(a.leftOperand)+a.operator+this._generateGlsl(a.rightOperand)+")";if(a instanceof n)return"("+a.operator+this._generateGlsl(a.operand)+")";if(a instanceof o)switch(this._checkFunc(a),a.funcName){case"above":return["(",this._generateGlsl(a.args[0]),">",this._generateGlsl(a.args[1]),"?1.0:0.0)"].join("");case"below":return["(",this._generateGlsl(a.args[0]),"<",this._generateGlsl(a.args[1]),"?1.0:0.0)"].join("");case"equal":return["(",this._generateGlsl(a.args[0]),"==",this._generateGlsl(a.args[1]),"?1.0:0.0)"].join("");case"if":return["(",this._generateGlsl(a.args[0]),"!=0.0?",this._generateGlsl(a.args[1]),":",this._generateGlsl(a.args[2]),")"].join("");default:var d=_.map(a.args,function(a){return c._generateGlsl(a)}).join(",");return"("+a.funcName+"("+d+"))"}if(a instanceof p)return this._generateGlsl(a.lhs)+"="+this._generateGlsl(a.expr);if(a instanceof q){var e=_.map(b,function(a){return"float "+a+"=0.0"}),f=_.map(a.statements,function(a){return c._generateGlsl(a)});return e.concat(f).join(";\n")+";"}return a instanceof r&&"VALUE"===a.type?a.value+(0===a.value%1?".0":""):a instanceof r&&"CONST"===a.type?this._translateConstants(a.value).toString():a instanceof r&&("ID"===a.type||"REG"===a.type)?a.value:void 0},_generateJs:function(a,b){var c,d=this;if(a instanceof m)return"("+this._generateJs(a.leftOperand)+a.operator+this._generateJs(a.rightOperand)+")";if(a instanceof n)return"("+a.operator+this._generateJs(a.operand)+")";if(a instanceof o)switch(this._checkFunc(a),a.funcName){case"above":return["(",this._generateJs(a.args[0]),">",this._generateJs(a.args[1]),"?1:0)"].join("");case"below":return["(",this._generateJs(a.args[0]),"<",this._generateJs(a.args[1]),"?1:0)"].join("");case"equal":return["(",this._generateJs(a.args[0]),"==",this._generateJs(a.args[1]),"?1:0)"].join("");case"if":return["(",this._generateJs(a.args[0]),"!==0?",this._generateJs(a.args[1]),":",this._generateJs(a.args[2]),")"].join("");default:var e=_.map(a.args,function(a){return d._generateJs(a)}).join(",");return c=_.contains(this.jsMathFuncs,a.funcName)?"Math.":"this.","("+c+a.funcName+"("+e+"))"}if(a instanceof p)return this._generateJs(a.lhs)+"="+this._generateJs(a.expr);if(a instanceof q){var f=_.map(b,function(a){return"var "+a+"=0"}),g=_.map(a.statements,function(a){return d._generateJs(a)});return f.concat(g).join(";\n")}return a instanceof r&&"VALUE"===a.type?a.value.toString():a instanceof r&&"CONST"===a.type?this._translateConstants(a.value).toString():a instanceof r&&"ID"===a.type?_.contains(this.instanceVars,a.value)?"this."+a.value:a.value:a instanceof r&&"REG"===a.type?'this._registerBank["'+a.value+'"]':void 0},_getVars:function(a,b,c,d){var e=this;a instanceof m?(this._getVars(a.leftOperand,b,c,d),this._getVars(a.rightOperand,b,c,d)):a instanceof n?this._getVars(a.operand,b,c,d):a instanceof o?(c.push(a.funcName),_.each(a.args,function(a){e._getVars(a,b,c,d)})):a instanceof p?(this._getVars(a.lhs,b,c,d),this._getVars(a.expr,b,c,d)):a instanceof q?_.each(a.statements,function(a){e._getVars(a,b,c,d)}):a instanceof r&&"ID"===a.type?b.push(a.value):a instanceof r&&"REG"===a.type&&d.push(a.value)},_translateConstants:function(a){switch(a){case"pi":return Math.PI;case"e":return Math.E;case"phi":return 1.6180339887;default:throw new Error("Unknown constant "+a)}}}),window.Webvs.ExprCodeGenerator=j,a(k,Object,{rand:function(a){return Math.floor(Math.random()*a)+1},_locationCache:{},_getLocation:function(a,b,c){var d=this._locationCache[c];return"undefined"==typeof d&&(d=b.getUniformLocation(a,c),this._locationCache[c]=d),d},bindUniforms:function(a,b){var c=this,d=_.difference(_.keys(this),this._treatAsNonUniform);if(_.each(d,function(d){var e=c[d];"number"==typeof e&&a.uniform1f(c._getLocation(b,a,d),e)}),_.each(this._registerUsages,function(d){a.uniform1f(c._getLocation(b,a,d),this._registerBank[d])}),this.hasRandom){var e=[Math.random()/100,Math.random()/100];a.uniform2fv(c._getLocation(b,a,"__randStep"),e)}},initRegisterBank:function(a){this._registerBank=a,_.each(this._registerUsages,function(b){_.has(a,b)||(a[b]=0)})}}),a(l,Object),a(m,l),a(n,l),a(o,l),a(p,l),a(q,l),a(r,l),f.PegExprParser=function(){function a(a){return'"'+a.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var b={parse:function(b,c){function d(a){var b={};for(var c in a)b[c]=a[c];return b}function e(a,c){for(var d=a.offset+c,e=a.offset;d>e;e++){var f=b.charAt(e);"\n"===f?(a.seenCR||a.line++,a.column=1,a.seenCR=!1):"\r"===f||"\u2028"===f||"\u2029"===f?(a.line++,a.column=1,a.seenCR=!0):(a.column++,a.seenCR=!1)}a.offset+=c}function f(a){L.offset<N.offset||(L.offset>N.offset&&(N=d(L),O=[]),O.push(a))}function g(){var a,c,g,i,j,k,l,m,n,o;if(m=d(L),n=d(L),a=h(),null!==a)if(c=D(),null!==c){for(g=[],o=d(L),59===b.charCodeAt(L.offset)?(i=";",e(L,1)):(i=null,0===M&&f('";"')),null!==i?(j=D(),null!==j?(k=h(),null!==k?(l=D(),null!==l?i=[i,j,k,l]:(i=null,L=d(o))):(i=null,L=d(o))):(i=null,L=d(o))):(i=null,L=d(o));null!==i;)g.push(i),o=d(L),59===b.charCodeAt(L.offset)?(i=";",e(L,1)):(i=null,0===M&&f('";"')),null!==i?(j=D(),null!==j?(k=h(),null!==k?(l=D(),null!==l?i=[i,j,k,l]:(i=null,L=d(o))):(i=null,L=d(o))):(i=null,L=d(o))):(i=null,L=d(o));null!==g?(59===b.charCodeAt(L.offset)?(i=";",e(L,1)):(i=null,0===M&&f('";"')),i=null!==i?i:"",null!==i?a=[a,c,g,i]:(a=null,L=d(n))):(a=null,L=d(n))}else a=null,L=d(n);else a=null,L=d(n);return null!==a&&(a=function(a,b,c,d){var e=[d[0]];return e=e.concat(_.map(d[2],function(a){return a[2]})),new q(e)}(m.offset,m.line,m.column,a)),null===a&&(L=d(m)),a}function h(){var a,c,g,h,i,j,k;return j=d(L),k=d(L),a=y(),null!==a?(c=D(),null!==c?(61===b.charCodeAt(L.offset)?(g="=",e(L,1)):(g=null,0===M&&f('"="')),null!==g?(h=D(),null!==h?(i=s(),null!==i?a=[a,c,g,h,i]:(a=null,L=d(k))):(a=null,L=d(k))):(a=null,L=d(k))):(a=null,L=d(k))):(a=null,L=d(k)),null!==a&&(a=function(a,b,c,d,e){return new p(d,e)}(j.offset,j.line,j.column,a[0],a[4])),null===a&&(L=d(j)),null===a&&(a=s()),a}function i(){var a;return 43===b.charCodeAt(L.offset)?(a="+",e(L,1)):(a=null,0===M&&f('"+"')),null===a&&(45===b.charCodeAt(L.offset)?(a="-",e(L,1)):(a=null,0===M&&f('"-"'))),a}function j(){var a;return 43===b.charCodeAt(L.offset)?(a="+",e(L,1)):(a=null,0===M&&f('"+"')),null===a&&(45===b.charCodeAt(L.offset)?(a="-",e(L,1)):(a=null,0===M&&f('"-"'))),a}function k(){var a;return 42===b.charCodeAt(L.offset)?(a="*",e(L,1)):(a=null,0===M&&f('"*"')),null===a&&(47===b.charCodeAt(L.offset)?(a="/",e(L,1)):(a=null,0===M&&f('"/"')),null===a&&(37===b.charCodeAt(L.offset)?(a="%",e(L,1)):(a=null,0===M&&f('"%"')))),a}function l(){var a;return 38===b.charCodeAt(L.offset)?(a="&",e(L,1)):(a=null,0===M&&f('"&"')),null===a&&(124===b.charCodeAt(L.offset)?(a="|",e(L,1)):(a=null,0===M&&f('"|"'))),a}function s(){var a,b,c,e,f,g,h,i,j;if(h=d(L),i=d(L),a=t(),null!==a){for(b=[],j=d(L),c=D(),null!==c?(e=l(),null!==e?(f=D(),null!==f?(g=t(),null!==g?c=[c,e,f,g]:(c=null,L=d(j))):(c=null,L=d(j))):(c=null,L=d(j))):(c=null,L=d(j));null!==c;)b.push(c),j=d(L),c=D(),null!==c?(e=l(),null!==e?(f=D(),null!==f?(g=t(),null!==g?c=[c,e,f,g]:(c=null,L=d(j))):(c=null,L=d(j))):(c=null,L=d(j))):(c=null,L=d(j));null!==b?a=[a,b]:(a=null,L=d(i))}else a=null,L=d(i);return null!==a&&(a=function(a,b,c,d,e){return I(d,e)}(h.offset,h.line,h.column,a[0],a[1])),null===a&&(L=d(h)),a}function t(){var a,b,c,e,f,g,h,i,k;if(h=d(L),i=d(L),a=u(),null!==a){for(b=[],k=d(L),c=D(),null!==c?(e=j(),null!==e?(f=D(),null!==f?(g=u(),null!==g?c=[c,e,f,g]:(c=null,L=d(k))):(c=null,L=d(k))):(c=null,L=d(k))):(c=null,L=d(k));null!==c;)b.push(c),k=d(L),c=D(),null!==c?(e=j(),null!==e?(f=D(),null!==f?(g=u(),null!==g?c=[c,e,f,g]:(c=null,L=d(k))):(c=null,L=d(k))):(c=null,L=d(k))):(c=null,L=d(k));null!==b?a=[a,b]:(a=null,L=d(i))}else a=null,L=d(i);return null!==a&&(a=function(a,b,c,d,e){return I(d,e)}(h.offset,h.line,h.column,a[0],a[1])),null===a&&(L=d(h)),a}function u(){var a,b,c,e,f,g,h,i,j;if(h=d(L),i=d(L),a=v(),null!==a){for(b=[],j=d(L),c=D(),null!==c?(e=k(),null!==e?(f=D(),null!==f?(g=v(),null!==g?c=[c,e,f,g]:(c=null,L=d(j))):(c=null,L=d(j))):(c=null,L=d(j))):(c=null,L=d(j));null!==c;)b.push(c),j=d(L),c=D(),null!==c?(e=k(),null!==e?(f=D(),null!==f?(g=v(),null!==g?c=[c,e,f,g]:(c=null,L=d(j))):(c=null,L=d(j))):(c=null,L=d(j))):(c=null,L=d(j));null!==b?a=[a,b]:(a=null,L=d(i))}else a=null,L=d(i);return null!==a&&(a=function(a,b,c,d,e){return I(d,e)}(h.offset,h.line,h.column,a[0],a[1])),null===a&&(L=d(h)),a}function v(){var a,b,c,e,f;return e=d(L),f=d(L),a=i(),null!==a?(b=D(),null!==b?(c=w(),null!==c?a=[a,b,c]:(a=null,L=d(f))):(a=null,L=d(f))):(a=null,L=d(f)),null!==a&&(a=function(a,b,c,d,e){return new n(d,e)}(e.offset,e.line,e.column,a[0],a[2])),null===a&&(L=d(e)),null===a&&(a=w()),a}function w(){var a,c,g,h,i,j,k,l,m,n,p,q;if(m=d(L),n=d(L),p=d(L),/^[a-zA-Z_]/.test(b.charAt(L.offset))?(a=b.charAt(L.offset),e(L,1)):(a=null,0===M&&f("[a-zA-Z_]")),null!==a){for(c=[],/^[a-zA-Z_0-9]/.test(b.charAt(L.offset))?(g=b.charAt(L.offset),e(L,1)):(g=null,0===M&&f("[a-zA-Z_0-9]"));null!==g;)c.push(g),/^[a-zA-Z_0-9]/.test(b.charAt(L.offset))?(g=b.charAt(L.offset),e(L,1)):(g=null,0===M&&f("[a-zA-Z_0-9]"));null!==c?a=[a,c]:(a=null,L=d(p))}else a=null,L=d(p);if(null!==a)if(c=D(),null!==c)if(40===b.charCodeAt(L.offset)?(g="(",e(L,1)):(g=null,0===M&&f('"("')),null!==g){for(p=d(L),h=[],q=d(L),i=D(),null!==i?(j=s(),null!==j?(k=D(),null!==k?(44===b.charCodeAt(L.offset)?(l=",",e(L,1)):(l=null,0===M&&f('","')),null!==l?i=[i,j,k,l]:(i=null,L=d(q))):(i=null,L=d(q))):(i=null,L=d(q))):(i=null,L=d(q));null!==i;)h.push(i),q=d(L),i=D(),null!==i?(j=s(),null!==j?(k=D(),null!==k?(44===b.charCodeAt(L.offset)?(l=",",e(L,1)):(l=null,0===M&&f('","')),null!==l?i=[i,j,k,l]:(i=null,L=d(q))):(i=null,L=d(q))):(i=null,L=d(q))):(i=null,L=d(q));null!==h?(i=D(),null!==i?(j=s(),null!==j?h=[h,i,j]:(h=null,L=d(p))):(h=null,L=d(p))):(h=null,L=d(p)),h=null!==h?h:"",null!==h?(i=D(),null!==i?(41===b.charCodeAt(L.offset)?(j=")",e(L,1)):(j=null,0===M&&f('")"')),null!==j?a=[a,c,g,h,i,j]:(a=null,L=d(n))):(a=null,L=d(n))):(a=null,L=d(n))}else a=null,L=d(n);else a=null,L=d(n);else a=null,L=d(n);return null!==a&&(a=function(a,b,c,d,e){var f=[];return _.each(e[0],function(a){f.push(a[1])}),f.push(e[2]),new o(J(d),f)}(m.offset,m.line,m.column,a[0],a[3])),null===a&&(L=d(m)),null===a&&(a=x()),a}function x(){var a,c,g,h,i;return a=C(),null===a&&(a=A(),null===a&&(a=B(),null===a&&(a=z(),null===a&&(h=d(L),i=d(L),40===b.charCodeAt(L.offset)?(a="(",e(L,1)):(a=null,0===M&&f('"("')),null!==a?(c=s(),null!==c?(41===b.charCodeAt(L.offset)?(g=")",e(L,1)):(g=null,0===M&&f('")"')),null!==g?a=[a,c,g]:(a=null,L=d(i))):(a=null,L=d(i))):(a=null,L=d(i)),null!==a&&(a=function(a,b,c,d){return d}(h.offset,h.line,h.column,a[1])),null===a&&(L=d(h)))))),a}function y(){var a;return a=B(),null===a&&(a=z()),a}function z(){var a,c,g,h,i;if(h=d(L),i=d(L),/^[a-zA-Z_]/.test(b.charAt(L.offset))?(a=b.charAt(L.offset),e(L,1)):(a=null,0===M&&f("[a-zA-Z_]")),null!==a){for(c=[],/^[a-zA-Z_0-9]/.test(b.charAt(L.offset))?(g=b.charAt(L.offset),e(L,1)):(g=null,0===M&&f("[a-zA-Z_0-9]"));null!==g;)c.push(g),/^[a-zA-Z_0-9]/.test(b.charAt(L.offset))?(g=b.charAt(L.offset),e(L,1)):(g=null,0===M&&f("[a-zA-Z_0-9]"));null!==c?a=[a,c]:(a=null,L=d(i))}else a=null,L=d(i);return null!==a&&(a=function(a,b,c,d){return new r(J(d).toLowerCase(),"ID")}(h.offset,h.line,h.column,a)),null===a&&(L=d(h)),a}function A(){var a,c,g,h,i;if(h=d(L),i=d(L),36===b.charCodeAt(L.offset)?(a="$",e(L,1)):(a=null,0===M&&f('"$"')),null!==a){for(c=[],/^[a-zA-Z_0-9]/.test(b.charAt(L.offset))?(g=b.charAt(L.offset),e(L,1)):(g=null,0===M&&f("[a-zA-Z_0-9]"));null!==g;)c.push(g),/^[a-zA-Z_0-9]/.test(b.charAt(L.offset))?(g=b.charAt(L.offset),e(L,1)):(g=null,0===M&&f("[a-zA-Z_0-9]"));null!==c?a=[a,c]:(a=null,L=d(i))}else a=null,L=d(i);return null!==a&&(a=function(a,b,c,d){return new r(J(d).toLowerCase(),"CONST")}(h.offset,h.line,h.column,a[1])),null===a&&(L=d(h)),a}function B(){var a,c,g,h,i,j,k;if(j=d(L),k=d(L),64===b.charCodeAt(L.offset)?(a="@",e(L,1)):(a=null,0===M&&f('"@"')),null!==a){for(c=[],/^[a-zA-Z_0-9]/.test(b.charAt(L.offset))?(g=b.charAt(L.offset),e(L,1)):(g=null,0===M&&f("[a-zA-Z_0-9]"));null!==g;)c.push(g),/^[a-zA-Z_0-9]/.test(b.charAt(L.offset))?(g=b.charAt(L.offset),e(L,1)):(g=null,0===M&&f("[a-zA-Z_0-9]"));null!==c?a=[a,c]:(a=null,L=d(k))}else a=null,L=d(k);return null!==a&&(a=function(a,b,c,d){return new r("__REG_AT_"+J(d).toLowerCase(),"REG")}(j.offset,j.line,j.column,a[1])),null===a&&(L=d(j)),null===a&&(j=d(L),k=d(L),/^[rR]/.test(b.charAt(L.offset))?(a=b.charAt(L.offset),e(L,1)):(a=null,0===M&&f("[rR]")),null!==a?(/^[eE]/.test(b.charAt(L.offset))?(c=b.charAt(L.offset),e(L,1)):(c=null,0===M&&f("[eE]")),null!==c?(/^[gG]/.test(b.charAt(L.offset))?(g=b.charAt(L.offset),e(L,1)):(g=null,0===M&&f("[gG]")),null!==g?(/^[0-9]/.test(b.charAt(L.offset))?(h=b.charAt(L.offset),e(L,1)):(h=null,0===M&&f("[0-9]")),null!==h?(/^[0-9]/.test(b.charAt(L.offset))?(i=b.charAt(L.offset),e(L,1)):(i=null,0===M&&f("[0-9]")),null!==i?a=[a,c,g,h,i]:(a=null,L=d(k))):(a=null,L=d(k))):(a=null,L=d(k))):(a=null,L=d(k))):(a=null,L=d(k)),null!==a&&(a=function(a,b,c,d){return new r("__REG_"+J(d).toLowerCase(),"REG")}(j.offset,j.line,j.column,a)),null===a&&(L=d(j))),a}function C(){var a,c,g,h,i,j,k,l,m;for(k=d(L),l=d(L),a=[],/^[0-9]/.test(b.charAt(L.offset))?(c=b.charAt(L.offset),e(L,1)):(c=null,0===M&&f("[0-9]"));null!==c;)a.push(c),/^[0-9]/.test(b.charAt(L.offset))?(c=b.charAt(L.offset),e(L,1)):(c=null,0===M&&f("[0-9]"));if(null!==a)if(46===b.charCodeAt(L.offset)?(c=".",e(L,1)):(c=null,0===M&&f('"."')),null!==c){if(/^[0-9]/.test(b.charAt(L.offset))?(h=b.charAt(L.offset),e(L,1)):(h=null,0===M&&f("[0-9]")),null!==h)for(g=[];null!==h;)g.push(h),/^[0-9]/.test(b.charAt(L.offset))?(h=b.charAt(L.offset),e(L,1)):(h=null,0===M&&f("[0-9]"));else g=null;if(null!==g){if(m=d(L),/^[Ee]/.test(b.charAt(L.offset))?(h=b.charAt(L.offset),e(L,1)):(h=null,0===M&&f("[Ee]")),null!==h){if(/^[0-9]/.test(b.charAt(L.offset))?(j=b.charAt(L.offset),e(L,1)):(j=null,0===M&&f("[0-9]")),null!==j)for(i=[];null!==j;)i.push(j),/^[0-9]/.test(b.charAt(L.offset))?(j=b.charAt(L.offset),e(L,1)):(j=null,0===M&&f("[0-9]"));else i=null;null!==i?h=[h,i]:(h=null,L=d(m))}else h=null,L=d(m);h=null!==h?h:"",null!==h?a=[a,c,g,h]:(a=null,L=d(l))}else a=null,L=d(l)}else a=null,L=d(l);else a=null,L=d(l);if(null!==a&&(a=function(a,b,c,d){return new r(parseFloat(J(d)),"VALUE")}(k.offset,k.line,k.column,a)),null===a&&(L=d(k)),null===a){if(k=d(L),l=d(L),/^[a-fA-F0-9]/.test(b.charAt(L.offset))?(c=b.charAt(L.offset),e(L,1)):(c=null,0===M&&f("[a-fA-F0-9]")),null!==c)for(a=[];null!==c;)a.push(c),/^[a-fA-F0-9]/.test(b.charAt(L.offset))?(c=b.charAt(L.offset),e(L,1)):(c=null,0===M&&f("[a-fA-F0-9]"));else a=null;if(null!==a?(/^[hH]/.test(b.charAt(L.offset))?(c=b.charAt(L.offset),e(L,1)):(c=null,0===M&&f("[hH]")),null!==c?a=[a,c]:(a=null,L=d(l))):(a=null,L=d(l)),null!==a&&(a=function(a,b,c,d){return new r(parseInt(J(d),16),"VALUE")}(k.offset,k.line,k.column,a[0])),null===a&&(L=d(k)),null===a){if(k=d(L),l=d(L),/^[0-9]/.test(b.charAt(L.offset))?(c=b.charAt(L.offset),e(L,1)):(c=null,0===M&&f("[0-9]")),null!==c)for(a=[];null!==c;)a.push(c),/^[0-9]/.test(b.charAt(L.offset))?(c=b.charAt(L.offset),e(L,1)):(c=null,0===M&&f("[0-9]"));else a=null;null!==a?(/^[dD]/.test(b.charAt(L.offset))?(c=b.charAt(L.offset),e(L,1)):(c=null,0===M&&f("[dD]")),c=null!==c?c:"",null!==c?a=[a,c]:(a=null,L=d(l))):(a=null,L=d(l)),null!==a&&(a=function(a,b,c,d){return new r(parseInt(J(d),10),"VALUE")}(k.offset,k.line,k.column,a[0])),null===a&&(L=d(k))}}return a}function D(){var a,b;for(a=[],b=E(),null===b&&(b=F(),null===b&&(b=G()));null!==b;)a.push(b),b=E(),null===b&&(b=F(),null===b&&(b=G()));return a}function E(){var a;return/^[\t\x0B\f \xA0\uFEFF]/.test(b.charAt(L.offset))?(a=b.charAt(L.offset),e(L,1)):(a=null,0===M&&f("[\\t\\x0B\\f \\xA0\\uFEFF]")),a}function F(){var a;return/^[\n\r\u2028\u2029]/.test(b.charAt(L.offset))?(a=b.charAt(L.offset),e(L,1)):(a=null,0===M&&f("[\\n\\r\\u2028\\u2029]")),a}function G(){var a,c,g,h,i,j,k;if(i=d(L),"/*"===b.substr(L.offset,2)?(a="/*",e(L,2)):(a=null,0===M&&f('"/*"')),null!==a){for(c=[],j=d(L),k=d(L),M++,"*/"===b.substr(L.offset,2)?(g="*/",e(L,2)):(g=null,0===M&&f('"*/"')),M--,null===g?g="":(g=null,L=d(k)),null!==g?(b.length>L.offset?(h=b.charAt(L.offset),e(L,1)):(h=null,0===M&&f("any character")),null!==h?g=[g,h]:(g=null,L=d(j))):(g=null,L=d(j));null!==g;)c.push(g),j=d(L),k=d(L),M++,"*/"===b.substr(L.offset,2)?(g="*/",e(L,2)):(g=null,0===M&&f('"*/"')),M--,null===g?g="":(g=null,L=d(k)),null!==g?(b.length>L.offset?(h=b.charAt(L.offset),e(L,1)):(h=null,0===M&&f("any character")),null!==h?g=[g,h]:(g=null,L=d(j))):(g=null,L=d(j));null!==c?("*/"===b.substr(L.offset,2)?(g="*/",e(L,2)):(g=null,0===M&&f('"*/"')),null!==g?a=[a,c,g]:(a=null,L=d(i))):(a=null,L=d(i))}else a=null,L=d(i);if(null===a)if(i=d(L),"//"===b.substr(L.offset,2)?(a="//",e(L,2)):(a=null,0===M&&f('"//"')),null!==a){for(c=[],j=d(L),k=d(L),M++,g=F(),M--,null===g?g="":(g=null,L=d(k)),null!==g?(b.length>L.offset?(h=b.charAt(L.offset),e(L,1)):(h=null,0===M&&f("any character")),null!==h?g=[g,h]:(g=null,L=d(j))):(g=null,L=d(j));null!==g;)c.push(g),j=d(L),k=d(L),M++,g=F(),M--,null===g?g="":(g=null,L=d(k)),null!==g?(b.length>L.offset?(h=b.charAt(L.offset),e(L,1)):(h=null,0===M&&f("any character")),null!==h?g=[g,h]:(g=null,L=d(j))):(g=null,L=d(j));null!==c?a=[a,c]:(a=null,L=d(i))}else a=null,L=d(i);return a}function H(a){a.sort();for(var b=null,c=[],d=0;d<a.length;d++)a[d]!==b&&(c.push(a[d]),b=a[d]);return c}function I(a,b){var c=a;return _.each(b,function(a){c=new m(a[1],c,a[3])}),c}function J(a){return _.flatten(a).join("")}var K={program:g,statement:h,unary_ops:i,additive_ops:j,multiplicative_ops:k,boolean_ops:l,boolean_expr:s,additive_expr:t,multiplicative_expr:u,unary:v,func_call:w,primary_expr:x,assignable:y,identifier:z,constant:A,register:B,value:C,__:D,whiteSpace:E,lineEnd:F,comment:G};
if(void 0!==c){if(void 0===K[c])throw new Error("Invalid rule name: "+a(c)+".")}else c="program";var L={offset:0,line:1,column:1,seenCR:!1},M=0,N={offset:0,line:1,column:1,seenCR:!1},O=[],P=K[c]();if(null===P||L.offset!==b.length){var Q=Math.max(L.offset,N.offset),R=Q<b.length?b.charAt(Q):null,S=L.offset>N.offset?L:N;throw new this.SyntaxError(H(O),R,Q,S.line,S.column)}return P},toSource:function(){return this._source}};return b.SyntaxError=function(b,c,d,e,f){function g(b,c){var d,e;switch(b.length){case 0:d="end of input";break;case 1:d=b[0];break;default:d=b.slice(0,b.length-1).join(", ")+" or "+b[b.length-1]}return e=c?a(c):"end of input","Expected "+d+" but "+e+" found."}this.name="SyntaxError",this.expected=b,this.found=c,this.message=g(b,c),this.offset=d,this.line=e,this.column=f},b.SyntaxError.prototype=Error.prototype,b}(),a(s,i,{init:function(){var a=this.gl;this.destTextureLocation=a.getUniformLocation(this.program,"u_destTexture"),s.super.init.call(this)},update:function(a,b){var c=this.gl;b&&(c.activeTexture(c.TEXTURE1),c.bindTexture(c.TEXTURE_2D,b),c.uniform1i(this.destTextureLocation,1)),s.super.update.call(this,a)}}),a(t,g,{swapFrame:!0,_constructComponent:function(a){for(var b=[],c=0;c<a.length;c++)if("boolean"!=typeof a[c].enabled||a[c].enabled){var d=a[c].type,e=new f[d](a[c]);b.push(e)}this.components=b},initComponent:function(a,b,c){t.super.initComponent.call(this,a,b,c),this._initFrameBuffer();for(var d=this.components,e=new s(this.output),f=[],g=0;g<d.length;g++){var h=d[g].initComponent(a,b,c);h&&f.push(h)}return e.initComponent(a,this.resolution,c),this.copyComponent=e,D.all(f)},updateComponent:function(a){t.super.updateComponent.call(this,a);var b=this.gl,c=b.getParameter(b.FRAMEBUFFER_BINDING);b.bindFramebuffer(b.FRAMEBUFFER,this.framebuffer),b.viewport(0,0,this.resolution.width,this.resolution.height),this._setFBAttachment(),(this.clearFrame||this.first)&&(b.clearColor(0,0,0,1),b.clear(b.COLOR_BUFFER_BIT),this.first=!1);for(var d=this.components,f=0;f<d.length;f++){var g=d[f];if(b.useProgram(g.program),g.swapFrame){var h=this._getCurrentTextrue();this._swapFBAttachment(),g.updateComponent(h)}else g.updateComponent()}b.bindFramebuffer(b.FRAMEBUFFER,c),b.useProgram(this.copyComponent.program),b.viewport(0,0,this.resolution.width,this.resolution.height),e(a||this.output==G.REPLACE,"Cannot blend"),this.copyComponent.updateComponent(this.frameAttachments[this.currAttachment].texture,a)},destroyComponent:function(){t.super.destroyComponent.call(this);var a,b=this.gl;for(a=0;a<this.components.length;a++)this.components[a].destroyComponent();for(this.copyComponent.destroyComponent(),a=0;2>a;a++)b.deleteRenderbuffer(this.frameAttachments[a].renderbuffer),b.deleteTexture(this.frameAttachments[a].texture);b.deleteFramebuffer(this.framebuffer)},_initFrameBuffer:function(){for(var a=this.gl,b=a.createFramebuffer(),c=[],d=0;2>d;d++){var e=a.createTexture();a.bindTexture(a.TEXTURE_2D,e),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,this.resolution.width,this.resolution.height,0,a.RGBA,a.UNSIGNED_BYTE,null);var f=a.createRenderbuffer();a.bindRenderbuffer(a.RENDERBUFFER,f),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,this.resolution.width,this.resolution.height),c[d]={texture:e,renderbuffer:f}}this.framebuffer=b,this.frameAttachments=c,this.currAttachment=0},_setFBAttachment:function(){var a=this.frameAttachments[this.currAttachment],b=this.gl;b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,a.texture,0),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,a.renderbuffer)},_getCurrentTextrue:function(){return this.frameAttachments[this.currAttachment].texture},_swapFBAttachment:function(){this.currAttachment=(this.currAttachment+1)%2,this._setFBAttachment()}}),window.Webvs.EffectList=t,a(u,Object,{beat:!1,isPlaying:function(){return!1},getWaveForm:function(){return new Float32Array(0)},getSpectrum:function(){return new Float32Array(0)}}),a(v,u,{isPlaying:function(){return this.dancer.isPlaying()},getWaveform:function(){return this.dancer.getWaveform()},getSpectrum:function(){return this.dancer.getSpectrum()}}),window.Webvs.DancerAdapter=v,a(w,h,{init:function(){var a=this.gl;this.vertexBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),a.STATIC_DRAW),this.positionLocation=a.getAttribLocation(this.program,"a_position"),this.colorLocation=a.getUniformLocation(this.program,"u_color")},update:function(){var a=this.gl,b=!1;this.analyser.beat&&!this.prevBeat&&(this.beatCount++,this.beatCount==this.n&&(b=!0,this.beatCount=0)),this.prevBeat=this.analyser.beat,b&&(this.blend&&(a.enable(a.BLEND),a.blendColor(.5,.5,.5,1),a.blendFunc(a.CONSTANT_COLOR,a.CONSTANT_COLOR)),a.uniform3fv(this.colorLocation,this.color),a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer),a.enableVertexAttribArray(this.positionLocation),a.vertexAttribPointer(this.positionLocation,2,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,6),this.blend&&a.disable(a.BLEND))},destroyComponent:function(){w.super.destroyComponent.call(this),this.gl.deleteBuffer(this.vertexBuffer)}}),window.Webvs.OnBeatClear=w,a(x,h,{init:function(){var a=this.gl,b=a.createTexture(),c=D(),d=new Image;d.src=this.src,this.imageTexture=b;var e=this;return d.onload=function(){e.imageResolution=[d.width,d.height],a.bindTexture(a.TEXTURE_2D,b),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,d),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),c.resolve()},this.texCoordBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.texCoordBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),a.STATIC_DRAW),this.imageLocation=a.getUniformLocation(this.program,"u_image"),this.imagePosLocation=a.getUniformLocation(this.program,"u_imagePos"),this.imageResLocation=a.getUniformLocation(this.program,"u_imageResolution"),this.texCoordLocation=a.getAttribLocation(this.program,"a_texCoord"),c.promise},update:function(){var a=this.gl;a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this.imageTexture),a.uniform1i(this.imageLocation,0),a.uniform2f(this.imagePosLocation,this.x,this.y),a.uniform2f(this.imageResLocation,this.imageResolution[0],this.imageResolution[1]),a.bindBuffer(a.ARRAY_BUFFER,this.texCoordBuffer),a.enableVertexAttribArray(this.texCoordLocation),a.vertexAttribPointer(this.texCoordLocation,2,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,6)},destroyComponent:function(){x.super.destroyComponent.call(this);var a=this.gl;a.deleteTexture(this.imageTexture),a.dleteBuffer(this.texCoordBuffer)}}),window.Webvs.Picture=x,a(y,h,{init:function(){var a=this.gl;this.code.initRegisterBank(this.registerBank),this.code.w=this.resolution.width,this.code.h=this.resolution.height,this.pointBuffer=a.createBuffer(),this.colorBuffer=a.createBuffer(),this.vertexPositionLocation=a.getAttribLocation(this.program,"a_position"),this.vertexColorLocation=a.getAttribLocation(this.program,"a_color"),this.pointSizeLocation=a.getUniformLocation(this.program,"u_pointSize")},update:function(){var a=this.gl,b=this.code;this._stepColor(),b.red=this.currentColor[0],b.green=this.currentColor[1],b.blue=this.currentColor[2],this.inited||(b.init(),this.inited=!0);var c=this.analyser.beat;b.b=c?1:0,b.perFrame(),c&&b.onBeat();for(var d=Math.floor(b.n),e=this.spectrum?this.analyser.getSpectrum():this.analyser.getWaveform(),f=e.length/d,g=0,h=0,i=new Float32Array(2*(this.dots?d:2*d-2)),j=new Float32Array(3*(this.dots?d:2*d-2)),k=0;d>k;k++){for(var l=0,m=0,n=Math.floor(k*f);(k+1)*f>n;n++,m++)l+=e[n];l/=m;var o=k/(d-1);b.i=o,b.v=l,b.perPoint(),i[g++]=b.x,i[g++]=-1*b.y,j[h++]=b.red,j[h++]=b.green,j[h++]=b.blue,0===k||k==d-1||this.dots||(i[g++]=b.x,i[g++]=-1*b.y,j[h++]=b.red,j[h++]=b.green,j[h++]=b.blue)}a.uniform1f(this.pointSizeLocation,this.thickness),a.bindBuffer(a.ARRAY_BUFFER,this.pointBuffer),a.bufferData(a.ARRAY_BUFFER,i,a.STATIC_DRAW),a.enableVertexAttribArray(this.vertexPositionLocation),a.vertexAttribPointer(this.vertexPositionLocation,2,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this.colorBuffer),a.bufferData(a.ARRAY_BUFFER,j,a.STATIC_DRAW),a.enableVertexAttribArray(this.vertexColorLocation),a.vertexAttribPointer(this.vertexColorLocation,3,a.FLOAT,!1,0,0);var p;this.dots||(p=a.getParameter(a.LINE_WIDTH),a.lineWidth(this.thickness)),a.drawArrays(this.dots?a.POINTS:a.LINES,0,g/2),this.dots||a.lineWidth(p)},destroyComponent:function(){y.super.destroyComponent.call(this);var a=this.gl;a.deleteBuffer(this.vertexBuffer),a.deleteBuffer(this.colorBuffer)},_stepColor:function(){var a;if(this.colors.length>1)if(this.step==this.maxStep){var b=this.colors[this.colorId];this.colorId=(this.colorId+1)%this.colors.length;var c=this.colors[this.colorId];for(a=0;3>a;a++)this.colorStep[a]=(c[a]-b[a])/this.maxStep;this.step=0,this.currentColor=b}else{for(a=0;3>a;a++)this.currentColor[a]+=this.colorStep[a];this.step++}}}),y.examples={diagonalScope:{init:"n=64; t=1;",onBeat:"t=-t;",perPoint:"sc=0.4*sin(i*$PI); x=2*(i-0.5-v*sc)*t; y=2*(i-0.5+v*sc);"}},window.Webvs.SuperScope=y,a(z,i,{channels:["RGB","RBG","BRG","BGR","GBR","GRB"],init:function(){var a=this.gl;this.channelLocation=a.getUniformLocation(this.program,"u_channel"),z.super.init.call(this)},update:function(a){var b=this.gl;this.onBeatRandom&&this.analyser.beat&&(this.channel=Math.floor(Math.random()*this.channels.length)),b.uniform1i(this.channelLocation,this.channel),z.super.update.call(this,a)}}),f.ChannelShift=z,a(A,i,{init:function(){var a=this.gl;this.kernelLocation=a.getUniformLocation(this.program,"u_kernel[0]"),this.kernelWeightLocation=a.getUniformLocation(this.program,"u_kernelWeight"),A.super.init.call(this)},update:function(a){var b=this.gl;b.uniform1fv(this.kernelLocation,this.kernel),b.uniform1f(this.kernelWeightLocation,this.kernelWeight),A.super.update.call(this,a)}}),A.kernels={normal:[0,0,0,0,1,0,0,0,0],gaussianBlur:[.045,.122,.045,.122,.332,.122,.045,.122,.045],unsharpen:[-1,-1,-1,-1,9,-1,-1,-1,-1],emboss:[-2,-1,0,-1,1,1,0,1,2],blur:[1,1,1,1,1,1,1,1,1]},window.Webvs.Convolution=A,a(B,h,{swapFrame:!0,init:function(){var a=this.gl;this.code.initRegisterBank(this.registerBank),this.code.w=this.resolution.width,this.code.h=this.resolution.height,this.pointBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.pointBuffer);for(var b=2*(this.gridW/this.resolution.width),c=2*(this.gridH/this.resolution.height),d=Math.ceil(this.resolution.width/this.gridW),e=Math.ceil(this.resolution.height/this.gridH),f=new Float32Array(2*6*d*e),g=0,h=-1,i=-1,j=0;e>j;j++){for(var k=0;d>k;k++){var l=Math.min(h+b,1),m=Math.min(i+c,1);f[g++]=h,f[g++]=i,f[g++]=l,f[g++]=i,f[g++]=h,f[g++]=m,f[g++]=l,f[g++]=i,f[g++]=l,f[g++]=m,f[g++]=h,f[g++]=m,h+=b}h=-1,i+=c}a.bufferData(a.ARRAY_BUFFER,f,a.STATIC_DRAW),this.pointBufferSize=g/2,this.vertexPositionLocation=a.getAttribLocation(this.program,"a_position"),this.curRenderLocation=a.getUniformLocation(this.program,"u_curRender")},update:function(a){var b=this.gl,c=this.code;this.inited||(c.init(),this.inited=!0);var d=this.analyser.beat;c.b=d?1:0,c.perFrame(),d&&c.onBeat(),this.code.bindUniforms(b,this.program,["x","y","d","r"]),b.activeTexture(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,a),b.uniform1i(this.curRenderLocation,0),b.bindBuffer(b.ARRAY_BUFFER,this.pointBuffer),b.enableVertexAttribArray(this.vertexPositionLocation),b.vertexAttribPointer(this.vertexPositionLocation,2,b.FLOAT,!1,0,0),b.drawArrays(b.TRIANGLES,0,this.pointBufferSize)},destroyComponent:function(){B.super.destroyComponent.call(this),this.gl.deleteBuffer(this.pointBuffer)}}),B.examples={inAndOut:{init:"speed=.2;c=0;",onBeat:["c = c + ($PI/2);","dd = 1 - (sin(c) * speed);"].join("\n"),perPixel:"d = d * dd;"},randomDirection:{init:"speed=.05;dr = (rand(200) / 100) * $PI;",perFrame:["dx = cos(dr) * speed;","dy = sin(dr) * speed;"].join("\n"),onBeat:"dr = (rand(200) / 100) * $PI;",perPixel:["x = x + dx;","y = y + dy;"].join("\n")},rollingGridley:{init:"c=200;f=0;dt=0;dl=0;beatdiv=8",perFrame:["f = f + 1;","t = ((f * $PI * 2)/c)/beatdiv;","dt = dl + t;","dx = 14+(cos(dt)*8);","dy = 10+(sin(dt*2)*4);"].join("\n"),onBeat:"c=f;f=0;dl=dt",perPixel:"x=x+(sin(y*dx)*.03); y=y-(cos(x*dy)*.03);"}},f.DynamicMovement=B,a(C,h,{init:function(){var a=this.gl;this.vertexBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),a.STATIC_DRAW),this.positionLocation=a.getAttribLocation(this.program,"a_position"),this.colorLocation=a.getUniformLocation(this.program,"u_color")},update:function(){var a=this.gl;this.frameCount++,this.frameCount==this.maxFrameCount&&(this.frameCount=0,a.enable(a.BLEND),a.blendColor(.5,.5,.5,1),a.blendFunc(a.CONSTANT_COLOR,a.CONSTANT_COLOR),a.uniform3fv(this.colorLocation,this.color),a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer),a.enableVertexAttribArray(this.positionLocation),a.vertexAttribPointer(this.positionLocation,2,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,6),a.disable(a.BLEND))},destroyComponent:function(){C.super.destroyComponent.call(this),this.gl.deleteBuffer(this.vertexBuffer)}}),window.Webvs.FadeOut=C}();