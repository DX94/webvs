!function(){function a(a,b,c){var d=function(){};if(d.prototype=b.prototype,a.prototype=new d,a.super=b.prototype,a.prototype.constructor=a,c)for(var e in c)a.prototype[e]=c[e]}function b(){}function c(a,b){for(var c in b){var d=b[c];if(!(d in a))throw new Error("Required option "+d+"not found")}}function d(a){return"[object Array]"===Object.prototype.toString.call(a)}function e(a){return a+(0===a%1?".0":"")}function f(a){if(_.isArray(a)&&3==a.length)return a;if(_.isString(a)){var b;if(a=a.toLowerCase(),b=a.match(/^#([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})$/))return _.chain(b).last(3).map(function(a){return parseInt(a,16)}).value();if(b=a.match(/^rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/))return _.chain(b).last(3).map(function(a){return Math.min(parseInt(a,10),255)}).value()}throw new Error("Invalid Color Format")}function g(a){return _.map(f(a),function(a){return a/255})}function h(a){if(c(a,["canvas","analyser"]),a=_.defaults(a,{showStat:!1}),this.canvas=a.canvas,this.analyser=a.analyser,a.showStat){var b=new Stats;b.setMode(0),b.domElement.style.position="absolute",b.domElement.style.right="5px",b.domElement.style.bottom="5px",document.body.appendChild(b.domElement),this.stats=b}this._initGl()}function i(){}function j(a,b){switch(b){case M.ADDITIVE:a.blendFunc(a.ONE,a.ONE),a.blendEquation(a.FUNC_ADD);break;case M.SUBTRACTIVE1:a.blendFunc(a.ONE,a.ONE),a.blendEquation(a.FUNC_REVERSE_SUBTRACT);break;case M.SUBTRACTIVE2:a.blendFunc(a.ONE,a.ONE),a.blendEquation(a.FUNC_SUBTRACT);break;case M.AVERAGE:a.blendColor(.5,.5,.5,1),a.blendFunc(a.CONSTANT_COLOR,a.CONSTANT_COLOR),a.blendEquation(a.FUNC_ADD);break;default:throw new Error("Invalid blend mode")}}function k(a,b){this.vertexSrc=a,this.fragmentSrc=b;var c=["precision mediump float;","uniform vec2 u_resolution;"],d=["precision mediump float;","uniform vec2 u_resolution;"],e="color";if(this.swapFrame||this.forceShaderBlend||!_.contains(this.glBlendModes,this.outputBlendMode))switch(this._glBlendMode=!1,this.swapFrame=!0,this.outputBlendMode){case M.REPLACE:e="color";break;case M.MAXIMUM:e="max(color, texture2D(u_srcTexture, v_position))";break;case M.AVERAGE:e="(color+texture2D(u_srcTexture, v_position))/2.0";break;case M.ADDITIVE:e="color+texture2D(u_srcTexture, v_position)";break;case M.SUBTRACTIVE1:e="texture2D(u_srcTexture, v_position)-color";break;case M.SUBTRACTIVE2:e="color-texture2D(u_srcTexture, v_position)";break;default:throw new Error("Blend Mode "+this.outputBlendMode+" not supported")}else this._glBlendMode=!0;c.push("#define setFragColor(color) (gl_FragColor = ("+e+"))"),this.swapFrame||this.varyingPos?(c.push("varying vec2 v_position;"),d.push("varying vec2 v_position;"),d.push("#define setPosition(pos) (v_position = (((pos)+1.0)/2.0),gl_Position = vec4((pos), 0, 1))")):d.push("#define setPosition(pos) (gl_Position = vec4((pos), 0, 1))"),this.swapFrame&&(d.push("uniform sampler2D u_srcTexture;"),d.push("#define getSrcColorAtPos(pos) (texture2D(u_srcTexture, pos))"),c.push("uniform sampler2D u_srcTexture;"),c.push("#define getSrcColor() (texture2D(u_srcTexture, v_position))"),c.push("#define getSrcColorAtPos(pos) (texture2D(u_srcTexture, pos))")),this.fragmentSrc=c.join("\n")+"\n"+b,this.vertexSrc=d.join("\n")+"\n"+a}function l(a){var b=["attribute vec2 a_position;","void main() {","   setPosition(a_position);","}"].join("\n");l.super.constructor.call(this,b,a)}function m(a,b){this.codeSrc=a,this.externalVars=b?b:[],this._parseSrc()}function n(){}function o(){}function p(a,b,c){this.operator=a,this.leftOperand=b,this.rightOperand=c}function q(a,b){this.operator=a,this.operand=b}function r(a,b){this.funcName=a,this.args=b}function s(a,b){this.lhs=a,this.expr=b}function t(a){this.statements=a}function u(a,b){this.value=a,this.type=b}function v(a,b){var c=["uniform sampler2D u_copySource;","void main() {","   setFragColor(texture2D(u_copySource, v_position));","}"].join("\n");this.outputBlendMode=a||M.REPLACE,this.forceShaderBlend=b?!0:!1,v.super.constructor.call(this,c)}function w(a){c(a,["components"]),a=_.defaults(a,{output:"REPLACE",input:"IGNORE",clearFrame:!1,enableOnBeat:!1,enableOnBeatFor:1}),this._constructComponent(a.components),this.output=M[a.output],this.input="IGNORE"==a.input?-1:M[a.input],this.clearFrame=a.clearFrame,this.enableOnBeat=a.enableOnBeat,this.enableOnBeatFor=a.enableOnBeatFor,this.first=!0,this._frameCounter=0,w.super.constructor.call(this)}function x(){}function y(a){this.dancer=a,this.beat=!1;var b=this;this.kick=a.createKick({onKick:function(){b.beat=!0},offKick:function(){b.beat=!1}}),this.kick.on()}function z(a){if(a=_.defaults(a,{action:"SAVE",bufferId:1,blendMode:"REPLACE"}),this.blendMode=M[a.blendMode],this.action=this.actions[a.action],!this.action)throw new Error("Unknown BufferSave action "+a.action);(this.action==this.actions.SAVERESTORE||this.action==this.RESTORESAVE)&&(this._nextAction=this.action==this.actions.RESTORESAVE?this.actions.RESTORE:this.actions.SAVE),this._bufferId="__BUFFERSAVE_"+a.bufferId}function A(a){c(a,["code"]);var b=new m(a.code,["b","w","h"]),d=b.generateCode(["init","onBeat","perFrame"],[],[]);this.code=d[0],this.inited=!1,A.super.constructor.call(this)}function B(a){a=_.defaults(a,{n:0,color:"#000000",blendMode:"REPLACE"}),this.n=a.n,this.color=g(a.color),this.outputBlendMode=M[a.blendMode],this.prevBeat=!1,this.beatCount=0;var b=["uniform vec3 u_color;","void main() {","   setFragColor(vec4(u_color, 1));","}"].join("\n");B.super.constructor.call(this,b)}function C(a){c(a,["src","x","y"]),this.src=a.src,this.x=a.x,this.y=a.y;var b=["attribute vec2 a_texCoord;","varying vec2 v_texCoord;","uniform vec2 u_imageResolution;","uniform vec2 u_imagePos;","void main() {","    v_texCoord = a_texCoord*vec2(1,-1);","    vec2 clipSpace = ((a_texCoord*u_imageResolution+u_imagePos)/u_resolution)*2.0-1.0;","    setPosition(vec4(clipSpace*vec2(1, -1), 0, 1));","}"].join("\n"),d=["uniform sampler2D u_image;","varying vec2 v_texCoord;","void main() {","   setFragColor(texture2D(u_image, v_texCoord));","}"].join("\n");C.super.constructor.call(this,b,d)}function E(a){c(a,["code"]),a=_.defaults(a,{source:"SPECTRUM",drawMode:"LINES",colors:["#ffffff"]});var b;if(a.code in E.examples)b=E.examples[a.code]();else{if("object"!=typeof a.code)throw new Error("Invalid superscope");b=a.code}var d=new m(b,["n","v","i","x","y","b","w","h","red","green","blue","cid"]),e=d.generateCode(["init","onBeat","perFrame","perPoint"],[],[]);this.code=e[0],this.code.n=100,this.spectrum="SPECTRUM"==a.source,this.dots="DOTS"==a.drawMode,this.colors=_.map(a.colors,g),this.currentColor=this.colors[0],this.maxStep=100,this.step=this.maxStep,this.colorId=0,this.colorStep=[0,0,0],this.thickness=a.thickness?a.thickness:1,this.inited=!1;var f=["attribute vec2 a_position;","attribute vec3 a_color;","varying vec3 v_color;","uniform float u_pointSize;","void main() {","   gl_PointSize = u_pointSize;","   setPosition(clamp(a_position, vec2(-1,-1), vec2(1,1)));","   v_color = a_color;","}"].join("\n"),h=["varying vec3 v_color;","void main() {","   setFragColor(vec4(v_color, 1));","}"].join("\n");E.super.constructor.call(this,f,h)}function F(a){if(a=_.defaults(a,{channel:"RGB",onBeatRandom:!1}),this.channel=this.channels.indexOf(a.channel),-1==this.channel)throw new Error("Invalid Channel");this.onBeatRandom=a.onBeatRandom;var b=["uniform int u_channel;","void main() {","   vec3 color = getSrcColor().rgb;",_.flatMap(this.channels,function(a,b){return["if(u_channel == "+b+") {","   setFragColor(vec4(color."+a.toLowerCase()+",1));","}"]}).join("\n"),"}"].join("\n");F.super.constructor.call(this,b)}function G(a){if(c(a,["maps"]),a=_.defaults(a,{key:"RED",output:"REPLACE",mapCycleMode:"SINGLE"}),this.maps=a.maps,this.currentMap=0,this.mapCycleMode=this.mapCycleModes[a.mapCycleMode],!this.mapCycleMode)throw new Error("Unknown mapCycleMode "+a.mapCycleMode);var b="";switch(a.key){case"RED":b="srcColor.r";break;case"GREEN":b="srcColor.g";break;case"BLUE":b="srcColor.b";break;case"(R+G+B)/2":b="mod((srcColor.r+srcColor.g+srcColor.b)/2.0, 1.0)";break;case"(R+G+B)/3":b="(srcColor.r+srcColor.g+srcColor.b)/3.0";break;case"MAX":b="max(srcColor.r, max(srcColor.g, srcColor.b))";break;default:throw new Error("Unknown colormap key function "+a.key)}var d=["uniform sampler2D u_colorMap;","void main() {","   vec4 srcColor = getSrcColor();","   setFragColor(texture2D(u_colorMap, vec2(("+b+"), 0)));","}"].join("\n");this.outputBlendMode=M[a.output],G.super.constructor.call(this,d)}function H(a){c(a,["kernel"]),a=_.defaults(a,{edgeMode:"EXTEND",bias:0});var b;if(a.kernel in H.kernels)b=H.kernels[a.kernel];else{if(!d(a.kernel)||1!==a.kernel.length%2)throw new Error("Invalid convolution kernel");b=a.kernel}var f=Math.floor(Math.sqrt(b.length));if(f*f!=b.length)throw new Error("Invalid convolution kernel");var g="";switch(a.edgeMode){case"WRAP":g="pos = vec2(pos.x<0?pos.x+1.0:pos.x%1, pos.y<0?pos.y+1.0:pos.y%1);";break;case"EXTEND":g="pos = clamp(pos, vec2(0,0), vec2(1,1));";break;default:throw new Error("Invalid edge mode")}var h,i,j=[],k=Math.floor(f/2);for(h=0;f>h;h++)for(i=0;f>i;i++){var l=b[h*f+i];0!==l&&(j.push("pos = v_position + onePixel * vec2("+(h-k)+","+(i-k)+");"),j.push(g),j.push("colorSum += texture2D(u_srcTexture, pos) * "+e(l)+";"))}var m=a.scale;_.isUndefined(m)&&(m=_.reduce(b,function(a,b){return a+b},0));var n=["void main() {","   vec2 onePixel = vec2(1.0, 1.0)/u_resolution;","   vec2 pos;","   vec4 colorSum = vec4(0,0,0,0);",j.join("\n"),"   setFragColor(vec4(((colorSum+"+e(a.bias)+") / "+e(m)+").rgb, 1.0));","}"].join("\n");H.super.constructor.call(this,n)}function I(a){c(a,["code"]),a=_.defaults(a,{gridW:16,gridH:16,coord:"POLAR"});var b;if(a.code in I.examples)b=I.examples[a.code];else{if("object"!=typeof a.code)throw new Error("Invalid Dynamic movement code");b=a.code}var d=new m(b,["x","y","r","d","b","w","h"]),e=d.generateCode(["init","onBeat","perFrame"],["perPixel"],["x","y","d","r"]);this.code=e[0],this.inited=!1,this.gridW=a.gridW,this.gridH=a.gridH,this.coordMode=a.coord;var f="";"POLAR"===this.coordMode&&(f=["d = distance(a_position, vec2(0,0));","r = atan(a_position.x, a_position.y);"].join("\n"));var g="";"POLAR"===this.coordMode&&(g=["x = d*sin(r);","y = -d*cos(r);"].join("\n"));var h=["attribute vec2 a_position;","varying vec2 v_newPoint;","uniform int u_coordMode;",e[1],"void main() {",this.code.hasRandom?"__randSeed = a_position;":"","   x = a_position.x;","   y = -a_position.y;",f,"   perPixel();",g,"   v_newPoint = vec2(x,-y);","   setPosition(a_position);","}"].join("\n"),i=["varying vec2 v_newPoint;","void main() {","   setFragColor(vec4(getSrcColorAtPos(mod((v_newPoint+1.0)/2.0, 1.0)).rgb, 1));","}"].join("\n");I.super.constructor.call(this,h,i)}function J(a){a=_.defaults(a,{speed:1,color:"#FFFFFF"}),this.color=g(a.color),this.frameCount=0,this.maxFrameCount=Math.floor(1/this.speed);var b=["uniform vec3 u_color;","void main() {","   setFragColor(vec4(u_color, 1));","}"].join("\n");J.super.constructor.call(this,b)}var K=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){return window.setTimeout(a,1e3/60)},L=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||function(a){return window.clearTimeout(a)};_.flatMap=_.compose(_.flatten,_.map),a(h,Object,{_initGl:function(){try{this.gl=this.canvas.getContext("experimental-webgl",{alpha:!1}),this.resolution={width:this.canvas.width,height:this.canvas.height}}catch(a){throw new Error("Couldnt get webgl context"+a)}},loadPreset:function(a){var b=new w(a);this.stop(),this.preset=a,this.rootComponent&&this.rootComponent.destroyComponent(),this.rootComponent=b},resetCanvas:function(){this.stop(),this.rootComponent&&(this.rootComponent.destroyComponent(),this.rootComponent=null),this._initGl(),this.preset&&(this.rootComponent=new w(this.preset))},start:function(){if(this.rootComponent){this.registerBank={};var a=this.rootComponent,b=(new Date).getTime(),c=a.initComponent(this.gl,this.resolution,this.analyser,this.registerBank,b),d=this,e=function(){d.analyser.isPlaying()&&a.updateComponent(),d.animReqId=K(e)};if(this.stats){var f=e;e=function(){d.stats.begin(),f.call(this,arguments),d.stats.end()}}c.then(function(){d.animReqId=K(e)})}},stop:function(){"undefined"!=typeof this.animReqId&&L(this.animReqId)}}),h.ui={leaf:!1,disp:"Main",schema:{name:{type:"string",title:"Name"},author:{type:"string",title:"Author"},description:{type:"string",title:"Description"},clearFrame:{type:"boolean",title:"Clear every frame","default":!1,required:!0}},form:["clearFrame","name","author",{key:"description",type:"textarea"}]},a(i,Object,{swapFrame:!1,initComponent:function(a,b,c,d,e){this.gl=a,this.resolution=b,this.analyser=c,this.registerBank=d,this.bootTime=e},updateComponent:function(){},destroyComponent:function(){},getIdString:function(){return _.isUndefined(this.parent)||_.isUndefined(this.id)?this.componentName+"#Main":this.parent.getIdString()+"/"+this.componentName+"#"+this.id}});var M={REPLACE:1,MAXIMUM:2,AVERAGE:3,ADDITIVE:4,SUBTRACTIVE1:5,SUBTRACTIVE2:6};a(k,i,{swapFrame:!1,outputBlendMode:M.REPLACE,forceShaderBlend:!1,varyingPos:!1,copyOnSwap:!1,glBlendModes:[M.REPLACE,M.AVERAGE,M.ADDITIVE,M.SUBTRACTIVE1,M.SUBTRACTIVE2],initComponent:function(a,b,c,d){k.super.initComponent.call(this,a,b,c,d);try{this._compileProgram(this.vertexSrc,this.fragmentSrc)}catch(e){throw console.log("Shader Compilation error:"),console.log("Vertex Shader:\n"+this.vertexSrc),console.log("Fragment Shader:\n"+this.fragmentSrc),e}this.resolutionLocation=this.gl.getUniformLocation(this.program,"u_resolution"),this.srcTextureLocation=this.gl.getUniformLocation(this.program,"u_srcTexture"),this.init()},updateComponent:function(a){k.super.updateComponent.apply(this,arguments);var b=this.gl;b.useProgram(this.program),b.uniform2f(this.resolutionLocation,this.resolution.width,this.resolution.height),this.swapFrame&&a&&(b.activeTexture(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,a),b.uniform1i(this.srcTextureLocation,0)),this._glBlendMode&&this.outputBlendMode!=M.REPLACE?(b.enable(b.BLEND),j(b,this.outputBlendMode)):b.disable(b.BLEND),this.update.apply(this,arguments),b.disable(b.BLEND)},destroyComponent:function(){var a=this.gl;a.deleteShader(this.vertex),a.deleteShader(this.fragment),a.deleteProgram(this.program)},_compileProgram:function(a,b){var c=this.gl,d=this._compileShader(a,c.VERTEX_SHADER),e=this._compileShader(b,c.FRAGMENT_SHADER),f=c.createProgram();if(c.attachShader(f,d),c.attachShader(f,e),c.linkProgram(f),!c.getProgramParameter(f,c.LINK_STATUS))throw new Error("Program link Error: "+c.getProgramInfoLog(f));this.vertex=d,this.fragment=e,this.program=f},_compileShader:function(a,b){var c=this.gl,d=c.createShader(b);if(c.shaderSource(d,a),c.compileShader(d),!c.getShaderParameter(d,c.COMPILE_STATUS))throw new Error("Shader compilation Error: "+c.getShaderInfoLog(d));return d},init:function(){},update:function(){}}),a(l,k,{varyingPos:!0,destroyComponent:function(){l.super.destroyComponent.call(this);var a=this.gl;a.deleteBuffer(this.texCoordBuffer)},init:function(){var a=this.gl;this.texCoordBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.texCoordBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),a.STATIC_DRAW),this.vertexPositionLocation=a.getAttribLocation(this.program,"a_position")},update:function(){var a=this.gl;a.bindBuffer(a.ARRAY_BUFFER,this.texCoordBuffer),a.enableVertexAttribArray(this.vertexPositionLocation),a.vertexAttribPointer(this.vertexPositionLocation,2,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,6)}}),window.Webvs=h,window.Webvs.Component=i,a(m,Object,{_parseSrc:function(){var a={},b=[],c={},d=[];for(var e in this.codeSrc)try{var f=this.codeSrc[e];_.isArray(f)&&(f=f.join("\n")),a[e]=h.PegExprParser.parse(f);var g=[];this._getVars(a[e],b,g,d),c[e]=g}catch(i){throw new Error("Error parsing "+e+"("+i.line+":"+i.column+")"+" : "+i)}this.codeAst=a,this.funcUsages=c,this.instanceVars=_.uniq(this.externalVars.concat(b)),this.registerUsages=_.uniq(d)},generateCode:function(a,c,d){var e=new n,f=this,g=[];_.each(this.instanceVars,function(a){e[a]=0;var b="";_.contains(d,a)||(b="uniform "),g.push(b+"float "+a+";")});var h=_.intersection(_.keys(this.codeAst),a),i=_.difference(a,h);_.each(h,function(a){var b=f.codeAst[a],c=f._generateJs(b);e[a]=new Function(c)}),_.each(i,function(a){e[a]=b});var j=_.intersection(_.keys(this.codeAst),c),k=_.difference(c,j),l=_.uniq(_.flatMap(j,function(a){return f.funcUsages[a]}));_.each(l,function(a){var b=f.glslFuncCode[a.name];b&&g.push(b)});var m=[],o=[];return _.each(j,function(a){var b=f.codeAst[a],c=f._generateGlsl(b,m);o.push("void "+a+"() {"),o.push(c),o.push("}")}),g=g.concat(_.map(m,function(a){return"uniform float "+a[1]+";"})),g=g.concat(o),e._preCompute=m,_.each(k,function(a){g.push("void "+a+"() {}")}),_.contains(j,"rand")&&(e.hasRandom=!0),_.contains(j,"gettime")&&(e.hasGettime=!0),e._treatAsNonUniform=d,e._registerUsages=this.registerUsages,[e,g.join("")]},funcArgLengths:{above:2,below:2,equal:2,pow:2,sqr:1,sqrt:1,invsqrt:1,floor:1,ceil:1,abs:1,"if":3,sin:1,cos:1,tan:1,asin:1,acos:1,atan:1,atan2:2,log:1,band:2,bor:2,bnot:1,rand:1,gettime:1,getosc:3,select:{min:2}},jsMathFuncs:["sin","cos","abs","tan","asin","acos","atan","log","pow","sqrt","floor","ceil"],glslFuncCode:{rand:["uniform vec2 __randStep;","vec2 __randSeed;","float rand(float max) {","   __randCur += __randStep;","   float val = fract(sin(dot(__randSeed.xy ,vec2(12.9898,78.233))) * 43758.5453);","   return (floor(val*max)+1);","}"].join("\n"),gettime:["uniform float __gettime0;","int gettime(int startTime) {","   int time = 0;","   if(startTime == 0) {","       time = __gettime0;","   }","   return time;","}"].join("\n")},_checkFunc:function(a){var b=this.funcArgLengths[a.funcName];if(void 0===b)throw Error("Unknown function "+a.funcName);if(_.isNumber(b)){if(a.args.length!=b)throw Error(a.funcName+" accepts "+b+" arguments")}else if(b.min&&a.args.length<b.min)throw Error(a.funcName+" accepts atleast "+b.min+" arguments")},_generateGlsl:function(a,b){var c=this;if(a instanceof p)return"("+this._generateGlsl(a.leftOperand,b)+a.operator+this._generateGlsl(a.rightOperand,b)+")";if(a instanceof q)return"("+a.operator+this._generateGlsl(a.operand,b)+")";if(a instanceof r)switch(this._checkFunc(a),a.funcName){case"above":return["(",this._generateGlsl(a.args[0],b),">",this._generateGlsl(a.args[1],b),"?1.0:0.0)"].join("");case"below":return["(",this._generateGlsl(a.args[0],b),"<",this._generateGlsl(a.args[1],b),"?1.0:0.0)"].join("");case"equal":return["(",this._generateGlsl(a.args[0],b),"==",this._generateGlsl(a.args[1],b),"?1.0:0.0)"].join("");case"if":return["(",this._generateGlsl(a.args[0],b),"!=0.0?",this._generateGlsl(a.args[1],b),":",this._generateGlsl(a.args[2],b),")"].join("");case"select":var d=this._generateGlsl(a.args[0],b),f=function(a,e){return 1==a.length?c._generateGlsl(a[0],b):["(("+d+" === "+e+")?","("+c._generateGlsl(a[0],b)+"):","("+f(_.last(a,a.length-1),e+1)+"))"].join("")};return f(_.last(a.args,a.args.length-1),0);case"sqr":return"(pow(("+this._generateGlsl(a.args[0],b)+"), 2))";case"band":return"(float(("+this._generateGlsl(a.args[0],b)+")&&("+this._generateGlsl(a.args[1],b)+")))";case"bor":return"(float(("+this._generateGlsl(a.args[0],b)+")||("+this._generateGlsl(a.args[1],b)+")))";case"bnot":return"(float(!("+this._generateGlsl(a.args[0],b)+")))";case"invsqrt":return"(1/sqrt("+this._generateGlsl(a.args[0],b)+"))";case"atan2":return"(atan(("+this._generateGlsl(a.args[0],b)+"),("+this._generateGlsl(a.args[1],b)+"))";case"getosc":var g=_.every(a.args,function(a){return a instanceof u});if(!g)throw new Error("Non Pre-Computable arguments for getosc in shader code, use variables or constants");var h="__PC_"+a.funcName+"_"+j,i=[a.funcName,h].concat(_.map(a.args,function(a){return a.value})),j=_.indexOf(b,i);return-1==j&&(b.push(i),j=b.length-1),h;default:var k=_.map(a.args,function(a){return c._generateGlsl(a,b)}).join(","),l=a.funcName;return _.contains(this.varArgFuncs,a.funcName)&&(l+=a.args.length),"("+l+"("+k+"))"}if(a instanceof s)return this._generateGlsl(a.lhs,b)+"="+this._generateGlsl(a.expr,b);if(a instanceof t){var m=_.map(a.statements,function(a){return c._generateGlsl(a,b)});return m.join(";\n")+";"}return a instanceof u&&"VALUE"===a.type?e(a.value):a instanceof u&&"CONST"===a.type?this._translateConstants(a.value).toString():a instanceof u&&("ID"===a.type||"REG"===a.type)?a.value:void 0},_generateJs:function(a){var b,c=this;if(a instanceof p)return"("+this._generateJs(a.leftOperand)+a.operator+this._generateJs(a.rightOperand)+")";if(a instanceof q)return"("+a.operator+this._generateJs(a.operand)+")";if(a instanceof r)switch(this._checkFunc(a),a.funcName){case"above":return["(",this._generateJs(a.args[0]),">",this._generateJs(a.args[1]),"?1:0)"].join("");case"below":return["(",this._generateJs(a.args[0]),"<",this._generateJs(a.args[1]),"?1:0)"].join("");case"equal":return["(",this._generateJs(a.args[0]),"==",this._generateJs(a.args[1]),"?1:0)"].join("");case"if":return["(",this._generateJs(a.args[0]),"!==0?",this._generateJs(a.args[1]),":",this._generateJs(a.args[2]),")"].join("");case"select":var d=["((function() {"];return d.push("switch("+this._generateJs(a.args[0])+") {"),_.each(_.last(a.args,a.args.length-1),function(a,b){d.push("case "+b+": return "+this._generateJs(a)+";")},this),d.push("default : throw new Error('Unknown selector value in select');"),d.push("}}).call(this))"),d.join("");case"sqr":return"(Math.pow(("+this._generateJs(a.args[0])+"),2))";case"band":return"((("+this._generateJs(a.args[0])+")&&("+this._generateJs(a.args[1])+"))?1:0)";case"bor":return"((("+this._generateJs(a.args[0])+")||("+this._generateJs(a.args[1])+"))?1:0)";case"bnot":return"((!("+this._generateJs(a.args[0])+"))?1:0)";case"invsqrt":return"(1/Math.sqrt("+this._generateJs(a.args[0])+"))";case"atan2":return"(Math.atan(("+this._generateJs(a.args[0])+")/("+this._generateJs(a.args[1])+")))";default:var e=_.map(a.args,function(a){return c._generateJs(a)}).join(",");return b=_.contains(this.jsMathFuncs,a.funcName)?"Math.":"this.","("+b+a.funcName+"("+e+"))"}if(a instanceof s)return this._generateJs(a.lhs)+"="+this._generateJs(a.expr);if(a instanceof t){var f=_.map(a.statements,function(a){return c._generateJs(a)});return f.join(";\n")}return a instanceof u&&"VALUE"===a.type?a.value.toString():a instanceof u&&"CONST"===a.type?this._translateConstants(a.value).toString():a instanceof u&&"ID"===a.type?"this."+a.value:a instanceof u&&"REG"===a.type?'this._registerBank["'+a.value+'"]':void 0},_getVars:function(a,b,c,d){var e=this;a instanceof p?(this._getVars(a.leftOperand,b,c,d),this._getVars(a.rightOperand,b,c,d)):a instanceof q?this._getVars(a.operand,b,c,d):a instanceof r?(c.push(a.funcName),_.each(a.args,function(a){e._getVars(a,b,c,d)})):a instanceof s?(this._getVars(a.lhs,b,c,d),this._getVars(a.expr,b,c,d)):a instanceof t?_.each(a.statements,function(a){e._getVars(a,b,c,d)}):a instanceof u&&"ID"===a.type?b.push(a.value):a instanceof u&&"REG"===a.type&&d.push(a.value)},_translateConstants:function(a){switch(a){case"pi":return Math.PI;case"e":return Math.E;case"phi":return 1.6180339887;default:throw new Error("Unknown constant "+a)}}}),window.Webvs.ExprCodeGenerator=m,a(n,Object,{rand:function(a){return Math.floor(Math.random()*a)+1},gettime:function(a){switch(a){case 0:var b=(new Date).getTime();return(b-this._bootTime)/1e3;default:throw new Error("Invalid startTime mode for gettime call")}},getosc:function(a,b){for(var c=this._analyser.getWaveform(),d=Math.floor((a-b/2)*c.length),e=Math.floor((a+b/2)*c.length),f=0,g=d;e>=g;g++)f+=c[g];return f/(e-d+1)},_locationCache:{},_getLocation:function(a,b,c){var d=this._locationCache[c];return"undefined"==typeof d&&(d=b.getUniformLocation(a,c),this._locationCache[c]=d),d},bindUniforms:function(a,b){var c=this,d=_.difference(_.keys(this),this._treatAsNonUniform);if(_.each(d,function(d){var e=c[d];"number"==typeof e&&a.uniform1f(c._getLocation(b,a,d),e)}),_.each(this._registerUsages,function(d){a.uniform1f(c._getLocation(b,a,d),this._registerBank[d])}),this.hasRandom){var e=[Math.random()/100,Math.random()/100];a.uniform2fv(this._getLocation(b,a,"__randStep"),e)}if(this.hasGettime){var f=((new Date).getTime()-this._bootTime)/1e3;a.uniform1f(this._getLocation(b,a,"__gettime0"),f)}_.each(this._preCompute,function(c){var d=_.map(_.last(c,c.length-2),function(a){return _.isString(a)?"__REG"==a.substring(0,5)?this._registerBank[a]:this[a]:a}),e=this[c[0]].apply(this,d);a.uniform1f(this._getLocation(b,a,c[1]),e)})},setup:function(a,b,c){this._registerBank=a,this._bootTime=b,this._analyser=c,_.each(this._registerUsages,function(b){_.has(a,b)||(a[b]=0)})}}),a(o,Object),a(p,o),a(q,o),a(r,o),a(s,o),a(t,o),a(u,o),h.PegExprParser=function(){function a(a){return'"'+a.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var b={parse:function(b,c){function d(a){var b={};for(var c in a)b[c]=a[c];return b}function e(a,c){for(var d=a.offset+c,e=a.offset;d>e;e++){var f=b.charAt(e);"\n"===f?(a.seenCR||a.line++,a.column=1,a.seenCR=!1):"\r"===f||"\u2028"===f||"\u2029"===f?(a.line++,a.column=1,a.seenCR=!0):(a.column++,a.seenCR=!1)}a.offset+=c}function f(a){L.offset<N.offset||(L.offset>N.offset&&(N=d(L),O=[]),O.push(a))}function g(){var a="program@"+L.offset,c=P[a];if(c)return L=d(c.nextPos),c.result;var g,i,j,k,l,m,n,o,p,q;if(o=d(L),p=d(L),g=h(),null!==g)if(i=D(),null!==i){for(j=[],q=d(L),59===b.charCodeAt(L.offset)?(k=";",e(L,1)):(k=null,0===M&&f('";"')),null!==k?(l=D(),null!==l?(m=h(),null!==m?(n=D(),null!==n?k=[k,l,m,n]:(k=null,L=d(q))):(k=null,L=d(q))):(k=null,L=d(q))):(k=null,L=d(q));null!==k;)j.push(k),q=d(L),59===b.charCodeAt(L.offset)?(k=";",e(L,1)):(k=null,0===M&&f('";"')),null!==k?(l=D(),null!==l?(m=h(),null!==m?(n=D(),null!==n?k=[k,l,m,n]:(k=null,L=d(q))):(k=null,L=d(q))):(k=null,L=d(q))):(k=null,L=d(q));null!==j?(59===b.charCodeAt(L.offset)?(k=";",e(L,1)):(k=null,0===M&&f('";"')),k=null!==k?k:"",null!==k?g=[g,i,j,k]:(g=null,L=d(p))):(g=null,L=d(p))}else g=null,L=d(p);else g=null,L=d(p);return null!==g&&(g=function(a,b,c,d){var e=[d[0]];return e=e.concat(_.map(d[2],function(a){return a[2]})),new t(e)}(o.offset,o.line,o.column,g)),null===g&&(L=d(o)),P[a]={nextPos:d(L),result:g},g}function h(){var a="statement@"+L.offset,c=P[a];if(c)return L=d(c.nextPos),c.result;var g,h,i,j,k,l,n;return l=d(L),n=d(L),g=y(),null!==g?(h=D(),null!==h?(61===b.charCodeAt(L.offset)?(i="=",e(L,1)):(i=null,0===M&&f('"="')),null!==i?(j=D(),null!==j?(k=m(),null!==k?g=[g,h,i,j,k]:(g=null,L=d(n))):(g=null,L=d(n))):(g=null,L=d(n))):(g=null,L=d(n))):(g=null,L=d(n)),null!==g&&(g=function(a,b,c,d,e){return new s(d,e)}(l.offset,l.line,l.column,g[0],g[4])),null===g&&(L=d(l)),null===g&&(g=m()),P[a]={nextPos:d(L),result:g},g}function i(){var a="unary_ops@"+L.offset,c=P[a];if(c)return L=d(c.nextPos),c.result;var g;return 43===b.charCodeAt(L.offset)?(g="+",e(L,1)):(g=null,0===M&&f('"+"')),null===g&&(45===b.charCodeAt(L.offset)?(g="-",e(L,1)):(g=null,0===M&&f('"-"'))),P[a]={nextPos:d(L),result:g},g}function j(){var a="additive_ops@"+L.offset,c=P[a];if(c)return L=d(c.nextPos),c.result;var g;return 43===b.charCodeAt(L.offset)?(g="+",e(L,1)):(g=null,0===M&&f('"+"')),null===g&&(45===b.charCodeAt(L.offset)?(g="-",e(L,1)):(g=null,0===M&&f('"-"'))),P[a]={nextPos:d(L),result:g},g}function k(){var a="multiplicative_ops@"+L.offset,c=P[a];if(c)return L=d(c.nextPos),c.result;var g;return 42===b.charCodeAt(L.offset)?(g="*",e(L,1)):(g=null,0===M&&f('"*"')),null===g&&(47===b.charCodeAt(L.offset)?(g="/",e(L,1)):(g=null,0===M&&f('"/"')),null===g&&(37===b.charCodeAt(L.offset)?(g="%",e(L,1)):(g=null,0===M&&f('"%"')))),P[a]={nextPos:d(L),result:g},g}function l(){var a="boolean_ops@"+L.offset,c=P[a];if(c)return L=d(c.nextPos),c.result;var g;return 38===b.charCodeAt(L.offset)?(g="&",e(L,1)):(g=null,0===M&&f('"&"')),null===g&&(124===b.charCodeAt(L.offset)?(g="|",e(L,1)):(g=null,0===M&&f('"|"'))),P[a]={nextPos:d(L),result:g},g}function m(){var a="boolean_expr@"+L.offset,b=P[a];if(b)return L=d(b.nextPos),b.result;var c,e,f,g,h,i,j,k,m;if(j=d(L),k=d(L),c=n(),null!==c){for(e=[],m=d(L),f=D(),null!==f?(g=l(),null!==g?(h=D(),null!==h?(i=n(),null!==i?f=[f,g,h,i]:(f=null,L=d(m))):(f=null,L=d(m))):(f=null,L=d(m))):(f=null,L=d(m));null!==f;)e.push(f),m=d(L),f=D(),null!==f?(g=l(),null!==g?(h=D(),null!==h?(i=n(),null!==i?f=[f,g,h,i]:(f=null,L=d(m))):(f=null,L=d(m))):(f=null,L=d(m))):(f=null,L=d(m));null!==e?c=[c,e]:(c=null,L=d(k))}else c=null,L=d(k);return null!==c&&(c=function(a,b,c,d,e){return I(d,e)}(j.offset,j.line,j.column,c[0],c[1])),null===c&&(L=d(j)),P[a]={nextPos:d(L),result:c},c}function n(){var a="additive_expr@"+L.offset,b=P[a];if(b)return L=d(b.nextPos),b.result;var c,e,f,g,h,i,k,l,m;if(k=d(L),l=d(L),c=o(),null!==c){for(e=[],m=d(L),f=D(),null!==f?(g=j(),null!==g?(h=D(),null!==h?(i=o(),null!==i?f=[f,g,h,i]:(f=null,L=d(m))):(f=null,L=d(m))):(f=null,L=d(m))):(f=null,L=d(m));null!==f;)e.push(f),m=d(L),f=D(),null!==f?(g=j(),null!==g?(h=D(),null!==h?(i=o(),null!==i?f=[f,g,h,i]:(f=null,L=d(m))):(f=null,L=d(m))):(f=null,L=d(m))):(f=null,L=d(m));null!==e?c=[c,e]:(c=null,L=d(l))}else c=null,L=d(l);return null!==c&&(c=function(a,b,c,d,e){return I(d,e)}(k.offset,k.line,k.column,c[0],c[1])),null===c&&(L=d(k)),P[a]={nextPos:d(L),result:c},c}function o(){var a="multiplicative_expr@"+L.offset,b=P[a];if(b)return L=d(b.nextPos),b.result;var c,e,f,g,h,i,j,l,m;if(j=d(L),l=d(L),c=v(),null!==c){for(e=[],m=d(L),f=D(),null!==f?(g=k(),null!==g?(h=D(),null!==h?(i=v(),null!==i?f=[f,g,h,i]:(f=null,L=d(m))):(f=null,L=d(m))):(f=null,L=d(m))):(f=null,L=d(m));null!==f;)e.push(f),m=d(L),f=D(),null!==f?(g=k(),null!==g?(h=D(),null!==h?(i=v(),null!==i?f=[f,g,h,i]:(f=null,L=d(m))):(f=null,L=d(m))):(f=null,L=d(m))):(f=null,L=d(m));null!==e?c=[c,e]:(c=null,L=d(l))}else c=null,L=d(l);return null!==c&&(c=function(a,b,c,d,e){return I(d,e)}(j.offset,j.line,j.column,c[0],c[1])),null===c&&(L=d(j)),P[a]={nextPos:d(L),result:c},c}function v(){var a="unary@"+L.offset,b=P[a];if(b)return L=d(b.nextPos),b.result;var c,e,f,g,h;return g=d(L),h=d(L),c=i(),null!==c?(e=D(),null!==e?(f=w(),null!==f?c=[c,e,f]:(c=null,L=d(h))):(c=null,L=d(h))):(c=null,L=d(h)),null!==c&&(c=function(a,b,c,d,e){return new q(d,e)}(g.offset,g.line,g.column,c[0],c[2])),null===c&&(L=d(g)),null===c&&(c=w()),P[a]={nextPos:d(L),result:c},c}function w(){var a="func_call@"+L.offset,c=P[a];if(c)return L=d(c.nextPos),c.result;var g,h,i,j,k,l,n,o,p,q,s,t;if(p=d(L),q=d(L),s=d(L),/^[a-zA-Z_]/.test(b.charAt(L.offset))?(g=b.charAt(L.offset),e(L,1)):(g=null,0===M&&f("[a-zA-Z_]")),null!==g){for(h=[],/^[a-zA-Z_0-9]/.test(b.charAt(L.offset))?(i=b.charAt(L.offset),e(L,1)):(i=null,0===M&&f("[a-zA-Z_0-9]"));null!==i;)h.push(i),/^[a-zA-Z_0-9]/.test(b.charAt(L.offset))?(i=b.charAt(L.offset),e(L,1)):(i=null,0===M&&f("[a-zA-Z_0-9]"));null!==h?g=[g,h]:(g=null,L=d(s))}else g=null,L=d(s);if(null!==g)if(h=D(),null!==h)if(40===b.charCodeAt(L.offset)?(i="(",e(L,1)):(i=null,0===M&&f('"("')),null!==i){for(s=d(L),j=[],t=d(L),k=D(),null!==k?(l=m(),null!==l?(n=D(),null!==n?(44===b.charCodeAt(L.offset)?(o=",",e(L,1)):(o=null,0===M&&f('","')),null!==o?k=[k,l,n,o]:(k=null,L=d(t))):(k=null,L=d(t))):(k=null,L=d(t))):(k=null,L=d(t));null!==k;)j.push(k),t=d(L),k=D(),null!==k?(l=m(),null!==l?(n=D(),null!==n?(44===b.charCodeAt(L.offset)?(o=",",e(L,1)):(o=null,0===M&&f('","')),null!==o?k=[k,l,n,o]:(k=null,L=d(t))):(k=null,L=d(t))):(k=null,L=d(t))):(k=null,L=d(t));null!==j?(k=D(),null!==k?(l=m(),null!==l?j=[j,k,l]:(j=null,L=d(s))):(j=null,L=d(s))):(j=null,L=d(s)),j=null!==j?j:"",null!==j?(k=D(),null!==k?(41===b.charCodeAt(L.offset)?(l=")",e(L,1)):(l=null,0===M&&f('")"')),null!==l?g=[g,h,i,j,k,l]:(g=null,L=d(q))):(g=null,L=d(q))):(g=null,L=d(q))
}else g=null,L=d(q);else g=null,L=d(q);else g=null,L=d(q);return null!==g&&(g=function(a,b,c,d,e){var f=[];return _.each(e[0],function(a){f.push(a[1])}),f.push(e[2]),new r(J(d),f)}(p.offset,p.line,p.column,g[0],g[3])),null===g&&(L=d(p)),null===g&&(g=x()),P[a]={nextPos:d(L),result:g},g}function x(){var a="primary_expr@"+L.offset,c=P[a];if(c)return L=d(c.nextPos),c.result;var g,h,i,j,k;return g=C(),null===g&&(g=A(),null===g&&(g=B(),null===g&&(g=z(),null===g&&(j=d(L),k=d(L),40===b.charCodeAt(L.offset)?(g="(",e(L,1)):(g=null,0===M&&f('"("')),null!==g?(h=m(),null!==h?(41===b.charCodeAt(L.offset)?(i=")",e(L,1)):(i=null,0===M&&f('")"')),null!==i?g=[g,h,i]:(g=null,L=d(k))):(g=null,L=d(k))):(g=null,L=d(k)),null!==g&&(g=function(a,b,c,d){return d}(j.offset,j.line,j.column,g[1])),null===g&&(L=d(j)))))),P[a]={nextPos:d(L),result:g},g}function y(){var a="assignable@"+L.offset,b=P[a];if(b)return L=d(b.nextPos),b.result;var c;return c=B(),null===c&&(c=z()),P[a]={nextPos:d(L),result:c},c}function z(){var a="identifier@"+L.offset,c=P[a];if(c)return L=d(c.nextPos),c.result;var g,h,i,j,k;if(j=d(L),k=d(L),/^[a-zA-Z_]/.test(b.charAt(L.offset))?(g=b.charAt(L.offset),e(L,1)):(g=null,0===M&&f("[a-zA-Z_]")),null!==g){for(h=[],/^[a-zA-Z_0-9]/.test(b.charAt(L.offset))?(i=b.charAt(L.offset),e(L,1)):(i=null,0===M&&f("[a-zA-Z_0-9]"));null!==i;)h.push(i),/^[a-zA-Z_0-9]/.test(b.charAt(L.offset))?(i=b.charAt(L.offset),e(L,1)):(i=null,0===M&&f("[a-zA-Z_0-9]"));null!==h?g=[g,h]:(g=null,L=d(k))}else g=null,L=d(k);return null!==g&&(g=function(a,b,c,d){return new u(J(d).toLowerCase(),"ID")}(j.offset,j.line,j.column,g)),null===g&&(L=d(j)),P[a]={nextPos:d(L),result:g},g}function A(){var a="constant@"+L.offset,c=P[a];if(c)return L=d(c.nextPos),c.result;var g,h,i,j,k;if(j=d(L),k=d(L),36===b.charCodeAt(L.offset)?(g="$",e(L,1)):(g=null,0===M&&f('"$"')),null!==g){for(h=[],/^[a-zA-Z_0-9]/.test(b.charAt(L.offset))?(i=b.charAt(L.offset),e(L,1)):(i=null,0===M&&f("[a-zA-Z_0-9]"));null!==i;)h.push(i),/^[a-zA-Z_0-9]/.test(b.charAt(L.offset))?(i=b.charAt(L.offset),e(L,1)):(i=null,0===M&&f("[a-zA-Z_0-9]"));null!==h?g=[g,h]:(g=null,L=d(k))}else g=null,L=d(k);return null!==g&&(g=function(a,b,c,d){return new u(J(d).toLowerCase(),"CONST")}(j.offset,j.line,j.column,g[1])),null===g&&(L=d(j)),P[a]={nextPos:d(L),result:g},g}function B(){var a="register@"+L.offset,c=P[a];if(c)return L=d(c.nextPos),c.result;var g,h,i,j,k,l,m;if(l=d(L),m=d(L),64===b.charCodeAt(L.offset)?(g="@",e(L,1)):(g=null,0===M&&f('"@"')),null!==g){for(h=[],/^[a-zA-Z_0-9]/.test(b.charAt(L.offset))?(i=b.charAt(L.offset),e(L,1)):(i=null,0===M&&f("[a-zA-Z_0-9]"));null!==i;)h.push(i),/^[a-zA-Z_0-9]/.test(b.charAt(L.offset))?(i=b.charAt(L.offset),e(L,1)):(i=null,0===M&&f("[a-zA-Z_0-9]"));null!==h?g=[g,h]:(g=null,L=d(m))}else g=null,L=d(m);return null!==g&&(g=function(a,b,c,d){return new u("__REG_AT_"+J(d).toLowerCase(),"REG")}(l.offset,l.line,l.column,g[1])),null===g&&(L=d(l)),null===g&&(l=d(L),m=d(L),/^[rR]/.test(b.charAt(L.offset))?(g=b.charAt(L.offset),e(L,1)):(g=null,0===M&&f("[rR]")),null!==g?(/^[eE]/.test(b.charAt(L.offset))?(h=b.charAt(L.offset),e(L,1)):(h=null,0===M&&f("[eE]")),null!==h?(/^[gG]/.test(b.charAt(L.offset))?(i=b.charAt(L.offset),e(L,1)):(i=null,0===M&&f("[gG]")),null!==i?(/^[0-9]/.test(b.charAt(L.offset))?(j=b.charAt(L.offset),e(L,1)):(j=null,0===M&&f("[0-9]")),null!==j?(/^[0-9]/.test(b.charAt(L.offset))?(k=b.charAt(L.offset),e(L,1)):(k=null,0===M&&f("[0-9]")),null!==k?g=[g,h,i,j,k]:(g=null,L=d(m))):(g=null,L=d(m))):(g=null,L=d(m))):(g=null,L=d(m))):(g=null,L=d(m)),null!==g&&(g=function(a,b,c,d){return new u("__REG_"+J(d).toLowerCase(),"REG")}(l.offset,l.line,l.column,g)),null===g&&(L=d(l))),P[a]={nextPos:d(L),result:g},g}function C(){var a="value@"+L.offset,c=P[a];if(c)return L=d(c.nextPos),c.result;var g,h,i,j,k,l,m,n,o;for(m=d(L),n=d(L),g=[],/^[0-9]/.test(b.charAt(L.offset))?(h=b.charAt(L.offset),e(L,1)):(h=null,0===M&&f("[0-9]"));null!==h;)g.push(h),/^[0-9]/.test(b.charAt(L.offset))?(h=b.charAt(L.offset),e(L,1)):(h=null,0===M&&f("[0-9]"));if(null!==g)if(46===b.charCodeAt(L.offset)?(h=".",e(L,1)):(h=null,0===M&&f('"."')),null!==h){if(/^[0-9]/.test(b.charAt(L.offset))?(j=b.charAt(L.offset),e(L,1)):(j=null,0===M&&f("[0-9]")),null!==j)for(i=[];null!==j;)i.push(j),/^[0-9]/.test(b.charAt(L.offset))?(j=b.charAt(L.offset),e(L,1)):(j=null,0===M&&f("[0-9]"));else i=null;if(null!==i){if(o=d(L),/^[Ee]/.test(b.charAt(L.offset))?(j=b.charAt(L.offset),e(L,1)):(j=null,0===M&&f("[Ee]")),null!==j){if(/^[0-9]/.test(b.charAt(L.offset))?(l=b.charAt(L.offset),e(L,1)):(l=null,0===M&&f("[0-9]")),null!==l)for(k=[];null!==l;)k.push(l),/^[0-9]/.test(b.charAt(L.offset))?(l=b.charAt(L.offset),e(L,1)):(l=null,0===M&&f("[0-9]"));else k=null;null!==k?j=[j,k]:(j=null,L=d(o))}else j=null,L=d(o);j=null!==j?j:"",null!==j?g=[g,h,i,j]:(g=null,L=d(n))}else g=null,L=d(n)}else g=null,L=d(n);else g=null,L=d(n);if(null!==g&&(g=function(a,b,c,d){return new u(parseFloat(J(d)),"VALUE")}(m.offset,m.line,m.column,g)),null===g&&(L=d(m)),null===g){if(m=d(L),n=d(L),/^[a-fA-F0-9]/.test(b.charAt(L.offset))?(h=b.charAt(L.offset),e(L,1)):(h=null,0===M&&f("[a-fA-F0-9]")),null!==h)for(g=[];null!==h;)g.push(h),/^[a-fA-F0-9]/.test(b.charAt(L.offset))?(h=b.charAt(L.offset),e(L,1)):(h=null,0===M&&f("[a-fA-F0-9]"));else g=null;if(null!==g?(/^[hH]/.test(b.charAt(L.offset))?(h=b.charAt(L.offset),e(L,1)):(h=null,0===M&&f("[hH]")),null!==h?g=[g,h]:(g=null,L=d(n))):(g=null,L=d(n)),null!==g&&(g=function(a,b,c,d){return new u(parseInt(J(d),16),"VALUE")}(m.offset,m.line,m.column,g[0])),null===g&&(L=d(m)),null===g){if(m=d(L),n=d(L),/^[0-9]/.test(b.charAt(L.offset))?(h=b.charAt(L.offset),e(L,1)):(h=null,0===M&&f("[0-9]")),null!==h)for(g=[];null!==h;)g.push(h),/^[0-9]/.test(b.charAt(L.offset))?(h=b.charAt(L.offset),e(L,1)):(h=null,0===M&&f("[0-9]"));else g=null;null!==g?(/^[dD]/.test(b.charAt(L.offset))?(h=b.charAt(L.offset),e(L,1)):(h=null,0===M&&f("[dD]")),h=null!==h?h:"",null!==h?g=[g,h]:(g=null,L=d(n))):(g=null,L=d(n)),null!==g&&(g=function(a,b,c,d){return new u(parseInt(J(d),10),"VALUE")}(m.offset,m.line,m.column,g[0])),null===g&&(L=d(m))}}return P[a]={nextPos:d(L),result:g},g}function D(){var a="__@"+L.offset,b=P[a];if(b)return L=d(b.nextPos),b.result;var c,e;for(c=[],e=E(),null===e&&(e=F(),null===e&&(e=G()));null!==e;)c.push(e),e=E(),null===e&&(e=F(),null===e&&(e=G()));return P[a]={nextPos:d(L),result:c},c}function E(){var a="whiteSpace@"+L.offset,c=P[a];if(c)return L=d(c.nextPos),c.result;var g;return/^[\t\x0B\f \xA0\uFEFF]/.test(b.charAt(L.offset))?(g=b.charAt(L.offset),e(L,1)):(g=null,0===M&&f("[\\t\\x0B\\f \\xA0\\uFEFF]")),P[a]={nextPos:d(L),result:g},g}function F(){var a="lineEnd@"+L.offset,c=P[a];if(c)return L=d(c.nextPos),c.result;var g;return/^[\n\r\u2028\u2029]/.test(b.charAt(L.offset))?(g=b.charAt(L.offset),e(L,1)):(g=null,0===M&&f("[\\n\\r\\u2028\\u2029]")),P[a]={nextPos:d(L),result:g},g}function G(){var a="comment@"+L.offset,c=P[a];if(c)return L=d(c.nextPos),c.result;var g,h,i,j,k,l,m;if(k=d(L),"/*"===b.substr(L.offset,2)?(g="/*",e(L,2)):(g=null,0===M&&f('"/*"')),null!==g){for(h=[],l=d(L),m=d(L),M++,"*/"===b.substr(L.offset,2)?(i="*/",e(L,2)):(i=null,0===M&&f('"*/"')),M--,null===i?i="":(i=null,L=d(m)),null!==i?(b.length>L.offset?(j=b.charAt(L.offset),e(L,1)):(j=null,0===M&&f("any character")),null!==j?i=[i,j]:(i=null,L=d(l))):(i=null,L=d(l));null!==i;)h.push(i),l=d(L),m=d(L),M++,"*/"===b.substr(L.offset,2)?(i="*/",e(L,2)):(i=null,0===M&&f('"*/"')),M--,null===i?i="":(i=null,L=d(m)),null!==i?(b.length>L.offset?(j=b.charAt(L.offset),e(L,1)):(j=null,0===M&&f("any character")),null!==j?i=[i,j]:(i=null,L=d(l))):(i=null,L=d(l));null!==h?("*/"===b.substr(L.offset,2)?(i="*/",e(L,2)):(i=null,0===M&&f('"*/"')),null!==i?g=[g,h,i]:(g=null,L=d(k))):(g=null,L=d(k))}else g=null,L=d(k);if(null===g)if(k=d(L),"//"===b.substr(L.offset,2)?(g="//",e(L,2)):(g=null,0===M&&f('"//"')),null!==g){for(h=[],l=d(L),m=d(L),M++,i=F(),M--,null===i?i="":(i=null,L=d(m)),null!==i?(b.length>L.offset?(j=b.charAt(L.offset),e(L,1)):(j=null,0===M&&f("any character")),null!==j?i=[i,j]:(i=null,L=d(l))):(i=null,L=d(l));null!==i;)h.push(i),l=d(L),m=d(L),M++,i=F(),M--,null===i?i="":(i=null,L=d(m)),null!==i?(b.length>L.offset?(j=b.charAt(L.offset),e(L,1)):(j=null,0===M&&f("any character")),null!==j?i=[i,j]:(i=null,L=d(l))):(i=null,L=d(l));null!==h?g=[g,h]:(g=null,L=d(k))}else g=null,L=d(k);return P[a]={nextPos:d(L),result:g},g}function H(a){a.sort();for(var b=null,c=[],d=0;d<a.length;d++)a[d]!==b&&(c.push(a[d]),b=a[d]);return c}function I(a,b){var c=a;return _.each(b,function(a){c=new p(a[1],c,a[3])}),c}function J(a){return _.flatten(a).join("")}var K={program:g,statement:h,unary_ops:i,additive_ops:j,multiplicative_ops:k,boolean_ops:l,boolean_expr:m,additive_expr:n,multiplicative_expr:o,unary:v,func_call:w,primary_expr:x,assignable:y,identifier:z,constant:A,register:B,value:C,__:D,whiteSpace:E,lineEnd:F,comment:G};if(void 0!==c){if(void 0===K[c])throw new Error("Invalid rule name: "+a(c)+".")}else c="program";var L={offset:0,line:1,column:1,seenCR:!1},M=0,N={offset:0,line:1,column:1,seenCR:!1},O=[],P={},Q=K[c]();if(null===Q||L.offset!==b.length){var R=Math.max(L.offset,N.offset),S=R<b.length?b.charAt(R):null,T=L.offset>N.offset?L:N;throw new this.SyntaxError(H(O),S,R,T.line,T.column)}return Q},toSource:function(){return this._source}};return b.SyntaxError=function(b,c,d,e,f){function g(b,c){var d,e;switch(b.length){case 0:d="end of input";break;case 1:d=b[0];break;default:d=b.slice(0,b.length-1).join(", ")+" or "+b[b.length-1]}return e=c?a(c):"end of input","Expected "+d+" but "+e+" found."}this.name="SyntaxError",this.expected=b,this.found=c,this.message=g(b,c),this.offset=d,this.line=e,this.column=f},b.SyntaxError.prototype=Error.prototype,b}(),a(v,l,{componentName:"Copy",setCopy:function(a){this.copySource=a},init:function(){var a=this.gl;this.texToBeCopiedLocation=a.getUniformLocation(this.program,"u_copySource"),v.super.init.apply(this,arguments)},update:function(a){var b=this.gl;b.activeTexture(b.TEXTURE1),b.bindTexture(b.TEXTURE_2D,this.copySource),b.uniform1i(this.texToBeCopiedLocation,1),v.super.update.call(this,a)}}),a(w,i,{componentName:"EffectList",swapFrame:!1,_constructComponent:function(a){var b=[],c=this;_.each(a,function(a,d){if("boolean"!=typeof a.enabled||a.enabled){var e=a.type,f="undefined"==typeof a.clone?1:a.clone;_.times(f,function(f){var g=new h[e](a);g.id=d,g.cloneId=f,g.parent=c,b.push(g)})}}),this.components=b},initComponent:function(){w.super.initComponent.apply(this,arguments),this._initFrameBuffer();for(var a=this.components,b=[],c=0;c<a.length;c++){var d=a[c].initComponent.apply(a[c],arguments);d&&b.push(d)}return-1!==this.input&&(this.inCopyComponent=new v(this.input),this.inCopyComponent.initComponent.apply(this.inCopyComponent,arguments)),this.copyComponent=new v,this.copyComponent.initComponent.apply(this.copyComponent,arguments),this.outCopyComponent=new v(this.output),this.outCopyComponent.initComponent.apply(this.outCopyComponent,arguments),D.all(b)},_updateSubComponent:function(a){var b=this._getCurrentTextrue();a.swapFrame?(this._swapFBAttachment(),a.copyOnSwap&&(this.copyComponent.setCopy(b),this._updateSubComponent(this.copyComponent)),a.updateComponent(b)):a.updateComponent(b)},updateComponent:function(a){w.super.updateComponent.call(this,a);var b=this.gl;if(!this.enableOnBeat||(this.analyser.beat?this._frameCounter=this.enableOnBeatFor:this._frameCounter>0&&this._frameCounter--,0!==this._frameCounter)){var c=b.getParameter(b.FRAMEBUFFER_BINDING);b.bindFramebuffer(b.FRAMEBUFFER,this.framebuffer),b.viewport(0,0,this.resolution.width,this.resolution.height),this._setFBAttachment(),(this.clearFrame||this.first)&&(b.clearColor(0,0,0,1),b.clear(b.COLOR_BUFFER_BIT),this.first=!1),-1!==this.input&&(this.inCopyComponent.setCopy(a),this._updateSubComponent(this.inCopyComponent));for(var d=this.components,e=0;e<d.length;e++)this._updateSubComponent(d[e]);b.bindFramebuffer(b.FRAMEBUFFER,c),b.viewport(0,0,this.resolution.width,this.resolution.height),this.outCopyComponent.setCopy(this._getCurrentTextrue()),this.outCopyComponent.updateComponent(a)}},destroyComponent:function(){w.super.destroyComponent.call(this);var a,b=this.gl;for(a=0;a<this.components.length;a++)this.components[a].destroyComponent();for(this.copyComponent.destroyComponent(),a=0;2>a;a++)b.deleteRenderbuffer(this.frameAttachments[a].renderbuffer),b.deleteTexture(this.frameAttachments[a].texture);b.deleteFramebuffer(this.framebuffer)},_initFrameBuffer:function(){for(var a=this.gl,b=a.createFramebuffer(),c=[],d=0;2>d;d++){var e=a.createTexture();a.bindTexture(a.TEXTURE_2D,e),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,this.resolution.width,this.resolution.height,0,a.RGBA,a.UNSIGNED_BYTE,null);var f=a.createRenderbuffer();a.bindRenderbuffer(a.RENDERBUFFER,f),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,this.resolution.width,this.resolution.height),c[d]={texture:e,renderbuffer:f}}this.framebuffer=b,this.frameAttachments=c,this.currAttachment=0},_setFBAttachment:function(){var a=this.frameAttachments[this.currAttachment],b=this.gl;b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,a.texture,0),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,a.renderbuffer)},_getCurrentTextrue:function(){return this.frameAttachments[this.currAttachment].texture},_swapFBAttachment:function(){this.currAttachment=(this.currAttachment+1)%2,this._setFBAttachment()}}),w.ui={disp:"Effect List",type:"EffectList",leaf:!1,schema:{clearFrame:{type:"boolean",title:"Clear Frame","default":!1,required:!0},enableOnBeat:{type:"boolean",title:"Enable on beat","default":!1},enableOnBeatFor:{type:"number",title:"Enable on beat for frames","default":1},output:{type:"string",title:"Output","default":"REPLACE","enum":_.keys(M)},input:{type:"string",title:"Input","default":"IGNORE","enum":_.union(_.keys(M),["IGNORE"])}}},window.Webvs.EffectList=w,a(x,Object,{beat:!1,isPlaying:function(){return!1},getWaveForm:function(){return new Float32Array(0)},getSpectrum:function(){return new Float32Array(0)}}),a(y,x,{isPlaying:function(){return this.dancer.isPlaying()},getWaveform:function(){return this.dancer.getWaveform()},getSpectrum:function(){return this.dancer.getSpectrum()}}),window.Webvs.DancerAdapter=y,a(z,i,{actions:{SAVE:1,RESTORE:2,SAVERESTORE:3,RESTORESAVE:4},initComponent:function(a,b,c,d){if(z.super.initComponent.apply(this,arguments),this.action!=this.actions.RESTORE){var e=new v;e.initComponent.apply(e,arguments),this.saveCopyComponent=e}if(this.action!=this.action.SAVE){var f=new v(this.blendMode);f.initComponent.apply(f,arguments),this.restoreCopyComponent=f,this.swapFrame=this.action==this.actions.RESTORE||this._nextAction==this.actions.RESTORE?f.swapFrame:!1}if(!d[this._bufferId]){var g=a.createFramebuffer(),h=a.createTexture();a.bindTexture(a.TEXTURE_2D,h),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,b.width,b.height,0,a.RGBA,a.UNSIGNED_BYTE,null);var i=a.createRenderbuffer();a.bindRenderbuffer(a.RENDERBUFFER,i),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,b.width,b.height),d[this._bufferId]={framebuffer:g,texture:h,renderbuffer:i}}},updateComponent:function(a){z.super.updateComponent.apply(this,arguments);var b,c=this.gl,d=this.registerBank[this._bufferId];switch(this.action==this.actions.SAVERESTORE||this.action==this.RESTORESAVE?(b=this._nextAction,this._nextAction==this.actions.SAVE?(this._nextAction=this.actions.RESTORE,this.swapFrame=this.restoreCopyComponent.swapFrame):(this._nextAction=this.actions.SAVE,this.swapFrame=!1)):b=this.action,b){case this.actions.SAVE:var e=c.getParameter(c.FRAMEBUFFER_BINDING);c.bindFramebuffer(c.FRAMEBUFFER,d.framebuffer),c.viewport(0,0,this.resolution.width,this.resolution.height),c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,d.texture,0),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,d.renderbuffer),this.saveCopyComponent.setCopy(a),this.saveCopyComponent.updateComponent(),c.bindFramebuffer(c.FRAMEBUFFER,e),c.viewport(0,0,this.resolution.width,this.resolution.height);break;case this.actions.RESTORE:this.restoreCopyComponent.setCopy(d.texture),this.restoreCopyComponent.updateComponent(a)}}}),z.ui={disp:"Buffer Save",type:"BufferSave",schema:{action:{type:"string",title:"Buffer save action","enum":["SAVE","RESTORE","SAVERESTORE","RESTORESAVE"]},bufferId:{type:"number",title:"Buffer Id","enum":[1,2,3,4,5,6,7,8]},blendMode:{type:"string",title:"Blend mode","enum":_.keys(M)}}},window.Webvs.BufferSave=z,a(A,i,{initComponent:function(){A.super.initComponent.apply(this,arguments),this.code.setup(this.registerBank,this.bootTime,this.analyser),this.code.w=this.resolution.width,this.code.h=this.resolution.height},updateComponent:function(){var a=this.code;a.b=this.analyser.beat?1:0,this.inited||(a.init(),this.inited=!0),this.analyser.beat&&a.onBeat(),a.perFrame()}}),A.ui={disp:"Global Var",type:"GlobalVar",schema:{code:{type:"object",title:"Code","default":{},properties:{init:{type:"string",title:"Init"},onBeat:{type:"string",title:"On Beat"},perFrame:{type:"string",title:"Per Frame"}}}},form:[{key:"code.init",type:"textarea"},{key:"code.onBeat",type:"textarea"},{key:"code.perFrame",type:"textarea"}]},window.Webvs.GlobalVar=A,a(B,l,{componentName:"ClearScreen",init:function(){var a=this.gl;this.colorLocation=a.getUniformLocation(this.program,"u_color"),J.super.init.apply(this,arguments)},update:function(){var a=this.gl,b=!1;0===this.n?b=!0:(this.analyser.beat&&!this.prevBeat&&(this.beatCount++,this.beatCount==this.n&&(b=!0,this.beatCount=0)),this.prevBeat=this.analyser.beat),b&&(a.uniform3fv(this.colorLocation,this.color),B.super.update.apply(this,arguments))}}),B.ui={type:"ClearScreen",disp:"Clear Screen",schema:{n:{type:"number",title:"Clear on beat (0 = always clear)","default":0},color:{type:"string",title:"Clear color",format:"color","default":"#000000"},blendMode:{type:"string",title:"Blend Mode","enum":_.keys(M)}}},window.Webvs.ClearScreen=B,a(C,k,{componentName:"Picture",init:function(){var a=this.gl,b=a.createTexture(),c=D(),d=new Image;d.src=this.src,this.imageTexture=b;var e=this;return d.onload=function(){e.imageResolution=[d.width,d.height],a.bindTexture(a.TEXTURE_2D,b),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,d),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),c.resolve()},this.texCoordBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.texCoordBuffer),a.bufferData(a.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),a.STATIC_DRAW),this.imageLocation=a.getUniformLocation(this.program,"u_image"),this.imagePosLocation=a.getUniformLocation(this.program,"u_imagePos"),this.imageResLocation=a.getUniformLocation(this.program,"u_imageResolution"),this.texCoordLocation=a.getAttribLocation(this.program,"a_texCoord"),c.promise},update:function(){var a=this.gl;a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this.imageTexture),a.uniform1i(this.imageLocation,0),a.uniform2f(this.imagePosLocation,this.x,this.y),a.uniform2f(this.imageResLocation,this.imageResolution[0],this.imageResolution[1]),a.bindBuffer(a.ARRAY_BUFFER,this.texCoordBuffer),a.enableVertexAttribArray(this.texCoordLocation),a.vertexAttribPointer(this.texCoordLocation,2,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,6)},destroyComponent:function(){C.super.destroyComponent.call(this);var a=this.gl;a.deleteTexture(this.imageTexture),a.dleteBuffer(this.texCoordBuffer)}}),window.Webvs.Picture=C,a(E,k,{componentName:"SuperScope",copyOnSwap:!0,init:function(){var a=this.gl;this.code.setup(this.registerBank,this.bootTime,this.analyser),this.code.w=this.resolution.width,this.code.h=this.resolution.height,this.code.cid=this.cloneId,this.pointBuffer=a.createBuffer(),this.colorBuffer=a.createBuffer(),this.vertexPositionLocation=a.getAttribLocation(this.program,"a_position"),this.vertexColorLocation=a.getAttribLocation(this.program,"a_color"),this.pointSizeLocation=a.getUniformLocation(this.program,"u_pointSize")},update:function(){var a=this.gl,b=this.code;this._stepColor(),b.red=this.currentColor[0],b.green=this.currentColor[1],b.blue=this.currentColor[2],this.inited||(b.init(),this.inited=!0);var c=this.analyser.beat;b.b=c?1:0,b.perFrame(),c&&b.onBeat();for(var d=Math.floor(b.n),e=this.spectrum?this.analyser.getSpectrum():this.analyser.getWaveform(),f=e.length/d,g=0,h=0,i=new Float32Array(2*(this.dots?d:2*d-2)),j=new Float32Array(3*(this.dots?d:2*d-2)),k=0;d>k;k++){for(var l=0,m=0,n=Math.floor(k*f);(k+1)*f>n;n++,m++)l+=e[n];l/=m;var o=k/(d-1);b.i=o,b.v=l,b.perPoint(),i[g++]=b.x,i[g++]=-1*b.y,0===k||k==d-1||this.dots||(i[g++]=b.x,i[g++]=-1*b.y),this.dots?(j[h++]=b.red,j[h++]=b.green,j[h++]=b.blue):0!==k&&(j[h++]=b.red,j[h++]=b.green,j[h++]=b.blue,j[h++]=b.red,j[h++]=b.green,j[h++]=b.blue)}a.uniform1f(this.pointSizeLocation,this.thickness),a.bindBuffer(a.ARRAY_BUFFER,this.pointBuffer),a.bufferData(a.ARRAY_BUFFER,i,a.STATIC_DRAW),a.enableVertexAttribArray(this.vertexPositionLocation),a.vertexAttribPointer(this.vertexPositionLocation,2,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this.colorBuffer),a.bufferData(a.ARRAY_BUFFER,j,a.STATIC_DRAW),a.enableVertexAttribArray(this.vertexColorLocation),a.vertexAttribPointer(this.vertexColorLocation,3,a.FLOAT,!1,0,0);var p;this.dots||(p=a.getParameter(a.LINE_WIDTH),a.lineWidth(this.thickness)),a.drawArrays(this.dots?a.POINTS:a.LINES,0,g/2),this.dots||a.lineWidth(p)},destroyComponent:function(){E.super.destroyComponent.call(this);var a=this.gl;a.deleteBuffer(this.vertexBuffer),a.deleteBuffer(this.colorBuffer)},_stepColor:function(){var a;if(this.colors.length>1)if(this.step==this.maxStep){var b=this.colors[this.colorId];this.colorId=(this.colorId+1)%this.colors.length;var c=this.colors[this.colorId];for(a=0;3>a;a++)this.colorStep[a]=(c[a]-b[a])/this.maxStep;this.step=0,this.currentColor=b}else{for(a=0;3>a;a++)this.currentColor[a]+=this.colorStep[a];this.step++}}}),E.ui={disp:"SuperScope",type:"SuperScope",schema:{code:{type:"object",title:"Code","default":{},properties:{init:{type:"string",title:"Init"},onBeat:{type:"string",title:"On Beat"},perFrame:{type:"string",title:"Per Frame"},perPoint:{type:"string",title:"Per Point"}}},source:{type:"string",title:"Source","default":"WAVEFORM","enum":["WAVEFORM","SPECTRUM"]},drawMode:{type:"string",title:"Draw Mode","default":"LINES","enum":["DOTS","LINES"]},colors:{type:"array",title:"Cycle Colors",items:{type:"string",format:"color","default":"#FFFFFF"}}},form:[{key:"code.init",type:"textarea"},{key:"code.onBeat",type:"textarea"},{key:"code.perFrame",type:"textarea"},{key:"code.perPoint",type:"textarea"},"colors","source","drawMode"]},E.examples={diagonalScope:{init:"n=64; t=1;",onBeat:"t=-t;",perPoint:"sc=0.4*sin(i*$PI); x=2*(i-0.5-v*sc)*t; y=2*(i-0.5+v*sc);"}},window.Webvs.SuperScope=E,a(F,l,{componentName:"ChannelShift",swapFrame:!0,channels:["RGB","RBG","BRG","BGR","GBR","GRB"],init:function(){var a=this.gl;this.channelLocation=a.getUniformLocation(this.program,"u_channel"),F.super.init.call(this)},update:function(a){var b=this.gl;this.onBeatRandom&&this.analyser.beat&&(this.channel=Math.floor(Math.random()*this.channels.length)),b.uniform1i(this.channelLocation,this.channel),F.super.update.call(this,a)}}),F.ui={disp:"Channel Shift",type:"ChannelShift",schema:{channel:{type:"string",title:"Channel","enum":["RGB","RBG","BRG","BGR","GBR","GRB"]},onBeatRandom:{type:"boolean",title:"On beat random"}}},h.ChannelShift=F,a(G,l,{swapFrame:!0,mapCycleModes:{SINGLE:1,ONBEATRANDOM:2,ONBEATSEQUENTIAL:3},init:function(){var a=this.gl,b=this;this.colorMaps=_.map(this.maps,function(a){return b._buildColorMap(a)}),this.currentMap=0,this.colorMapLocation=a.getUniformLocation(this.program,"u_colorMap"),G.super.init.apply(this,arguments)},update:function(){var a=this.gl;if(this.analyser.beat)switch(this.mapCycleMode){case this.mapCycleModes.ONBEATRANDOM:this.currentMap=Math.floor(Math.random()*this.colorMaps.length);break;case this.mapCycleModes.ONBEATSEQUENTIAL:this.currentMap=(this.currentMap+1)%this.colorMaps.length}a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,this.colorMaps[this.currentMap]),a.uniform1i(this.colorMapLocation,1),G.super.update.apply(this,arguments)},_buildColorMap:function(a){var b=this.gl;a=_.sortBy(a,function(a){return a.index});var c=_.map(a,function(a){return a.index});if(_.uniq(c).length!=c.length)throw new Error("map cannot have repeated indices");var d=_.first(a);0!==d.index&&a.splice(0,0,{color:d.color,index:0});var e=_.last(a);255!==e.index&&a.push({color:e.color,index:255}),a=_.map(a,function(a){var b=f(a.color);return{color:b,index:a.index}});var g=new Uint8Array(1024),h=0,i=_.zip(_.first(a,a.length-1),_.last(a,a.length-1));_.each(i,function(a){var b=a[0],c=a[1],d=c.index-b.index,e=[(c.color[0]-b.color[0])/d,(c.color[1]-b.color[1])/d,(c.color[2]-b.color[2])/d];_.times(d,function(a){g[h++]=b.color[0]+e[0]*a,g[h++]=b.color[1]+e[1]*a,g[h++]=b.color[2]+e[2]*a,g[h++]=255})}),g[h++]=e.color[0],g[h++]=e.color[1],g[h++]=e.color[2],g[h++]=255;var j=b.createTexture();return b.bindTexture(b.TEXTURE_2D,j),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,256,1,0,b.RGBA,b.UNSIGNED_BYTE,g),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST),j}}),G.ui={disp:"Color Map",type:"ColorMap",schema:{maps:{type:"array",items:{type:"array",title:"Map",items:{type:"object",properties:{color:{type:"string",title:"Color",format:"color","default":"#FFFFFF"},index:{type:"number",title:"Index",minimum:0,maximum:255}}}}},key:{type:"string",title:"Map key","enum":["RED","GREEN","BLUE","(R+G+B)/2","(R+G+B)/3","MAX"],"default":"RED"},mapCycleMode:{type:"string",title:"Map Cycle Mode","enum":["SINGLE","ONBEATRANDOM","ONBEATSEQUENTIAL"],"default":"SINGLE"},output:{type:"string",title:"Output blend mode","enum":_.keys(M),"default":"REPLACE"}}},window.Webvs.ColorMap=G,a(H,l,{componentName:"Convolution",swapFrame:!0}),H.kernels={normal:[0,0,0,0,1,0,0,0,0],gaussianBlur:[.045,.122,.045,.122,.332,.122,.045,.122,.045],unsharpen:[-1,-1,-1,-1,9,-1,-1,-1,-1],emboss:[-2,-1,0,-1,1,1,0,1,2],blur:[1,1,1,1,1,1,1,1,1]},window.Webvs.Convolution=H,a(I,k,{componentName:"DynamicMovement",swapFrame:!0,init:function(){var a=this.gl;this.code.setup(this.registerBank,this.bootTime,this.analyser),this.code.w=this.resolution.width,this.code.h=this.resolution.height,this.pointBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.pointBuffer);for(var b=2*(this.gridW/this.resolution.width),c=2*(this.gridH/this.resolution.height),d=Math.ceil(this.resolution.width/this.gridW),e=Math.ceil(this.resolution.height/this.gridH),f=new Float32Array(2*6*d*e),g=0,h=-1,i=-1,j=0;e>j;j++){for(var k=0;d>k;k++){var l=Math.min(h+b,1),m=Math.min(i+c,1);f[g++]=h,f[g++]=i,f[g++]=l,f[g++]=i,f[g++]=h,f[g++]=m,f[g++]=l,f[g++]=i,f[g++]=l,f[g++]=m,f[g++]=h,f[g++]=m,h+=b}h=-1,i+=c}a.bufferData(a.ARRAY_BUFFER,f,a.STATIC_DRAW),this.pointBufferSize=g/2,this.vertexPositionLocation=a.getAttribLocation(this.program,"a_position"),this.curRenderLocation=a.getUniformLocation(this.program,"u_curRender")},update:function(a){var b=this.gl,c=this.code;this.inited||(c.init(),this.inited=!0);var d=this.analyser.beat;c.b=d?1:0,c.perFrame(),d&&c.onBeat(),this.code.bindUniforms(b,this.program,["x","y","d","r"]),b.activeTexture(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,a),b.uniform1i(this.curRenderLocation,0),b.bindBuffer(b.ARRAY_BUFFER,this.pointBuffer),b.enableVertexAttribArray(this.vertexPositionLocation),b.vertexAttribPointer(this.vertexPositionLocation,2,b.FLOAT,!1,0,0),b.drawArrays(b.TRIANGLES,0,this.pointBufferSize)},destroyComponent:function(){I.super.destroyComponent.call(this),this.gl.deleteBuffer(this.pointBuffer)}}),I.ui={type:"DynamicMovement",disp:"Dynamic Movement",schema:{code:{type:"object",title:"Code","default":{},properties:{init:{type:"string",title:"Init"},onBeat:{type:"string",title:"On Beat"},perFrame:{type:"string",title:"Per Frame"},perPixel:{type:"string",title:"Per Point"}}},gridW:{type:"number",title:"Grid Width","default":16},gridH:{type:"number",title:"Grid Height","default":16},coord:{type:"string",title:"Coordinate System","enum":["POLAR","RECT"],"default":"POLAR"}},form:[{key:"code.init",type:"textarea"},{key:"code.onBeat",type:"textarea"},{key:"code.perFrame",type:"textarea"},{key:"code.perPixel",type:"textarea"},"gridW","gridH","coord"]},I.examples={inAndOut:{init:"speed=.2;c=0;",onBeat:["c = c + ($PI/2);","dd = 1 - (sin(c) * speed);"].join("\n"),perPixel:"d = d * dd;"},randomDirection:{init:"speed=.05;dr = (rand(200) / 100) * $PI;",perFrame:["dx = cos(dr) * speed;","dy = sin(dr) * speed;"].join("\n"),onBeat:"dr = (rand(200) / 100) * $PI;",perPixel:["x = x + dx;","y = y + dy;"].join("\n")},rollingGridley:{init:"c=200;f=0;dt=0;dl=0;beatdiv=8",perFrame:["f = f + 1;","t = ((f * $PI * 2)/c)/beatdiv;","dt = dl + t;","dx = 14+(cos(dt)*8);","dy = 10+(sin(dt*2)*4);"].join("\n"),onBeat:"c=f;f=0;dl=dt",perPixel:"x=x+(sin(y*dx)*.03); y=y-(cos(x*dy)*.03);"}},h.DynamicMovement=I,a(J,l,{componentName:"FadeOut",outputBlendMode:M.AVERAGE,init:function(){var a=this.gl;this.colorLocation=a.getUniformLocation(this.program,"u_color"),J.super.init.apply(this,arguments)},update:function(){this.gl,this.frameCount++,this.frameCount==this.maxFrameCount&&(this.frameCount=0,J.super.update.apply(this,arguments))}}),J.ui={type:"FadeOut",disp:"Fade Out",schema:{speed:{type:"number",title:"Speed",maximum:0,minimum:1,"default":1},color:{type:"string",title:"Fadeout color",format:"color","default":"#FFFFFF"}},form:[{key:"speed",type:"range",step:"0.05"},"color"]},window.Webvs.FadeOut=J}();