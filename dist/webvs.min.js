!function(a){var b={};a.Webvs=b,b.defineClass=function(a,b){return a.prototype=Object.create(b.prototype),a.prototype.constructor=a,a.super=b.prototype,_.chain(arguments).drop(2).each(function(b){_.extend(a.prototype,b)}),a},b.noop=function(){},b.checkRequiredOptions=function(a,b){for(var c in b){var d=b[c];if(!(d in a))throw new Error("Required option "+d+"not found")}},b.glslFloatRepr=function(a){return a+(0===a%1?".0":"")},b.parseColor=function(a){if(_.isArray(a)&&3==a.length)return a;if(_.isString(a)){var b;if(a=a.toLowerCase(),b=a.match(/^#([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})$/))return _.chain(b).last(3).map(function(a){return parseInt(a,16)}).value();if(b=a.match(/^rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/))return _.chain(b).last(3).map(function(a){return Math.min(parseInt(a,10),255)}).value()}throw new Error("Invalid Color Format")},b.parseColorNorm=function(a){return _.map(b.parseColor(a),function(a){return a/255})},b.logShaderError=function(a,b){var c=a.split("\n"),d=c.length.toString().length,e=b.match(/(\d+):(\d+)/);e&&(e=[parseInt(e[1],10),parseInt(e[2],10)]);var f=_.map(c,function(a,c){var f,g=c+1+"";for(f=0;f<d-g.length;f++)g="0"+g;var h="";if(e&&e[1]==c+1){var i="";for(f=0;f<e[0]+d+2;f++)i+=" ";h="\n"+i+"^\n"+i+b}return g+": "+a+h}).join("\n");console.log("Shader Error : \n"+f)};var c=function(){this.resolved=!1,this.listeners=[]};b.Promise=b.defineClass(c,Object,{resolve:function(){this.resolved||(this.resolved=!0,_.each(this.listeners,function(a){a()}))},onResolve:function(a){this.resolved?a():this.listeners.push(a)}}),b.joinPromises=function(a){var b=new c;if(0===a.length)b.resolve();else{var d=a.length,e=function(){d--,0===d&&b.resolve()};_.each(a,function(a){a.resolved?e():a.onResolve(e)})}return b},_.flatMap=_.compose(_.flatten,_.map),b.blendModes={REPLACE:1,MAXIMUM:2,AVERAGE:3,ADDITIVE:4,SUBTRACTIVE1:5,SUBTRACTIVE2:6},_.extend(b,b.blendModes)}(window),function(a){function b(){}a.AnalyserAdapter=a.defineClass(b,Object,{beat:!1,isPlaying:function(){return!1},getWaveForm:function(){return new Float32Array(0)},getSpectrum:function(){return new Float32Array(0)}})}(Webvs),function(a){function b(a){this.dancer=a,this.beat=!1;var b=this;this.kick=a.createKick({onKick:function(){b.beat=!0},offKick:function(){b.beat=!1}}),this.kick.on()}a.DancerAdapter=a.defineClass(b,a.AnalyserAdapter,{isPlaying:function(){return this.dancer.isPlaying()},getWaveform:function(){return this.dancer.getWaveform()},getSpectrum:function(){return this.dancer.getSpectrum()}})}(Webvs),function(a){function b(b){if(a.checkRequiredOptions(b,["canvas","analyser"]),b=_.defaults(b,{showStat:!1}),this.canvas=b.canvas,this.analyser=b.analyser,b.showStat){var c=new Stats;c.setMode(0),c.domElement.style.position="absolute",c.domElement.style.right="5px",c.domElement.style.bottom="5px",document.body.appendChild(c.domElement),this.stats=c}this._initGl()}a.Main=a.defineClass(b,Object,{_initGl:function(){try{this.gl=this.canvas.getContext("experimental-webgl",{alpha:!1}),this.copier=new a.CopyProgram({dynamicBlend:!0}),this.copier.init(this.gl),this.resolution={width:this.canvas.width,height:this.canvas.height}}catch(b){throw new Error("Couldnt get webgl context"+b)}},loadPreset:function(b){var c=new a.EffectList(b);this.stop(),this.preset=b,this.rootComponent&&this.rootComponent.destroy(),this.rootComponent=c},resetCanvas:function(){this.stop(),this.rootComponent&&(this.rootComponent.destroy(),this.rootComponent=null),this._initGl(),this.preset&&(this.rootComponent=new EffectList(this.preset))},start:function(){if(this.rootComponent){this.registerBank={},this.bootTime=(new Date).getTime();var a=this.rootComponent,b=a.init(this.gl,this),c=this,d=function(){c.analyser.isPlaying()&&a.update(),c.animReqId=requestAnimationFrame(d)};if(this.stats){var e=d;d=function(){c.stats.begin(),e.call(this,arguments),c.stats.end()}}b.onResolve(function(){c.animReqId=requestAnimationFrame(d)})}},stop:function(){"undefined"!=typeof this.animReqId&&cancelAnimationFrame(this.animReqId)}}),b.ui={leaf:!1,disp:"Main",schema:{name:{type:"string",title:"Name"},author:{type:"string",title:"Author"},description:{type:"string",title:"Description"},clearFrame:{type:"boolean",title:"Clear every frame","default":!1,required:!0}}}}(Webvs),function(a){function b(){}a.Component=a.defineClass(b,Object,{componentName:"Component",init:function(a,b,c){this.gl=a,this.main=b,this.parent=c},update:function(){},destroy:function(){},getIdString:function(){return _.isUndefined(this.parent)||_.isUndefined(this.id)?this.componentName+"#Main":this.parent.getIdString()+"/"+this.componentName+"#"+this.id}})}(Webvs),function(a){function b(c){a.checkRequiredOptions(c,["components"]),c=_.defaults(c,{output:"REPLACE",input:"IGNORE",clearFrame:!1,enableOnBeat:!1,enableOnBeatFor:1}),this._constructComponent(c.components),this.output="IGNORE"==c.output?-1:a.blendModes[c.output],this.input="IGNORE"==c.input?-1:a.blendModes[c.input],this.clearFrame=c.clearFrame,this.enableOnBeat=c.enableOnBeat,this.enableOnBeatFor=c.enableOnBeatFor,this.first=!0,this._frameCounter=0,b.super.constructor.call(this)}a.EffectList=a.defineClass(b,a.Component,{componentName:"EffectList",_constructComponent:function(b){var c=[];_.each(b,function(b,d){if("boolean"!=typeof b.enabled||b.enabled){var e=b.type,f="undefined"==typeof b.clone?1:b.clone;_.times(f,function(f){var g=new a[e](b);g.id=d,g.cloneId=f,c.push(g)})}}),this.components=c},init:function(c,d,e){b.super.init.call(this,c,d,e),this.fm=new a.FrameBufferManager(d.canvas.width,d.canvas.height,c,d.copier);for(var f=this.components,g=[],h=0;h<f.length;h++){var i=f[h].init(c,d,this);i&&g.push(i)}return a.joinPromises(g)},update:function(){b.super.update.call(this);var a=this.gl;if(!this.enableOnBeat||(this.main.analyser.beat?this._frameCounter=this.enableOnBeatFor:this._frameCounter>0&&this._frameCounter--,0!==this._frameCounter)){if(this.fm.setRenderTarget(),(this.clearFrame||this.first)&&(a.clearColor(0,0,0,1),a.clear(a.COLOR_BUFFER_BIT),this.first=!1),-1!==this.input){var c=this.parent.fm.getCurrentTexture();this.main.copier.run(this.fm,this.input,c)}for(var d=this.components,e=0;e<d.length;e++)d[e].update();this.fm.restoreRenderTarget(),-1!=this.output&&(this.parent?this.main.copier.run(this.parent.fm,this.output,this.fm.getCurrentTexture()):this.main.copier.run(null,null,this.fm.getCurrentTexture()))}},destroy:function(){for(b.super.destroy.call(this),i=0;i<this.components.length;i++)this.components[i].destroy();this.fm.destroy()}}),b.ui={disp:"Effect List",type:"EffectList",leaf:!1,schema:{clearFrame:{type:"boolean",title:"Clear Frame","default":!1,required:!0},enableOnBeat:{type:"boolean",title:"Enable on beat","default":!1},enableOnBeatFor:{type:"number",title:"Enable on beat for frames","default":1},output:{type:"string",title:"Output","default":"REPLACE","enum":_.keys(a.blendModes)},input:{type:"string",title:"Input","default":"IGNORE","enum":_.union(_.keys(a.blendModes),["IGNORE"])}}}}(Webvs),function(a){function b(b){b=_.defaults(b,{forceShaderBlend:!1,outputBlendMode:a.REPLACE,varyingPos:!1,dynamicBlend:!1,swapFrame:!1,copyOnSwap:!1});var c=["precision mediump float;","uniform vec2 u_resolution;","#define PI "+Math.PI],d=_.clone(c);if(_.isFunction(b.draw)&&(this.draw=b.draw),this.copyOnSwap=b.copyOnSwap,this.varyingPos=b.varyingPos,this.dynamicBlend=b.dynamicBlend,this.outputBlendMode=b.outputBlendMode,b.swapFrame||this.dynamicBlend||b.forceShaderBlend||!_.contains(this.glBlendModes,this.outputBlendMode)?(this.swapFrame=!0,this.glBlendMode=!1,this.varyingPos=!0):(this.swapFrame=!1,this.glBlendMode=!0),this.varyingPos?(c.push("varying vec2 v_position;"),d.push("varying vec2 v_position;","#define setPosition(pos) (v_position = (((pos)+1.0)/2.0),gl_Position = vec4((pos), 0, 1))")):d.push("#define setPosition(pos) (gl_Position = vec4((pos), 0, 1))"),this.swapFrame&&(d.push("uniform sampler2D u_srcTexture;","#define getSrcColorAtPos(pos) (texture2D(u_srcTexture, pos))"),c.push("uniform sampler2D u_srcTexture;","#define getSrcColor() (texture2D(u_srcTexture, v_position))","#define getSrcColorAtPos(pos) (texture2D(u_srcTexture, pos))")),this.dynamicBlend)c.push("uniform int u_blendMode;","void setFragColor(vec4 color) {"),_.each(this.blendEqs,function(a,b){c.push("   if(u_blendMode == "+b+") {","       gl_FragColor = ("+a+");","   }")}),c.push("}");else{var e=this.blendEqs[this.glBlendMode?a.REPLACE:this.outputBlendMode];if(_.isUndefined(e))throw new Error("Blend Mode "+this.outputBlendMode+" not supported");c.push("#define setFragColor(color) (gl_FragColor = ("+e+"))")}this.fragmentSrc=c.join("\n")+"\n"+b.fragmentShader.join("\n"),this.vertexSrc=d.join("\n")+"\n"+b.vertexShader.join("\n"),this._locations={},this._textureVars=[],this._arrBuffers={}}a.ShaderProgram=a.defineClass(b,Object,{glBlendModes:[a.REPLACE,a.AVERAGE,a.ADDITIVE,a.SUBTRACTIVE1,a.SUBTRACTIVE2],blendEqs:_.object([[a.REPLACE,"color"],[a.MAXIMUM,"max(color, texture2D(u_srcTexture, v_position))"],[a.AVERAGE,"(color+texture2D(u_srcTexture, v_position))/2.0"],[a.ADDITIVE,"color+texture2D(u_srcTexture, v_position)"],[a.SUBTRACTIVE1,"texture2D(u_srcTexture, v_position)-color"],[a.SUBTRACTIVE2,"color-texture2D(u_srcTexture, v_position)"]]),init:function(a){this.gl=a;try{this._compileProgram(this.vertexSrc,this.fragmentSrc)}catch(b){throw b}},setOutputBlendMode:function(a){this.outputBlendMode=a},run:function(b,c){var d=this.gl,e=d.getParameter(d.CURRENT_PROGRAM);d.useProgram(this.program),b&&(this.setUniform("u_resolution","2f",b.width,b.height),this.swapFrame&&(this.setUniform("u_srcTexture","texture2D",b.getCurrentTexture()),b.swapAttachment(),this.copyOnSwap&&b.copyOver())),c=c||this.outputBlendMode,this.dynamicBlend&&this.setUniform("u_blendMode","1i",c),this.glBlendMode&&c!=a.REPLACE?(d.enable(d.BLEND),this._setGlBlendMode(d,c)):d.disable(d.BLEND),this.draw.apply(this,_.drop(arguments,2)),d.disable(d.BLEND),d.useProgram(e)},draw:function(){},_compileProgram:function(a,b){var c=this.gl,d=this._compileShader(a,c.VERTEX_SHADER),e=this._compileShader(b,c.FRAGMENT_SHADER),f=c.createProgram();if(c.attachShader(f,d),c.attachShader(f,e),c.linkProgram(f),!c.getProgramParameter(f,c.LINK_STATUS))throw new Error("Program link Error: "+c.getProgramInfoLog(f));this.vertex=d,this.fragment=e,this.program=f},_compileShader:function(b,c){var d=this.gl,e=d.createShader(c);if(d.shaderSource(e,b),d.compileShader(e),!d.getShaderParameter(e,d.COMPILE_STATUS))throw a.logShaderError(this.fragmentSrc,d.getShaderInfoLog(e)),new Error("Shader compilation Error: "+d.getShaderInfoLog(e));return e},_setGlBlendMode:function(b,c){switch(c){case a.ADDITIVE:b.blendFunc(b.ONE,b.ONE),b.blendEquation(b.FUNC_ADD);break;case a.SUBTRACTIVE1:b.blendFunc(b.ONE,b.ONE),b.blendEquation(b.FUNC_REVERSE_SUBTRACT);break;case a.SUBTRACTIVE2:b.blendFunc(b.ONE,b.ONE),b.blendEquation(b.FUNC_SUBTRACT);break;case a.AVERAGE:b.blendColor(.5,.5,.5,1),b.blendFunc(b.CONSTANT_COLOR,b.CONSTANT_COLOR),b.blendEquation(b.FUNC_ADD);break;default:throw new Error("Invalid blend mode")}},getLocation:function(a,b){var c=this._locations[a];return _.isUndefined(c)&&(c=b?this.gl.getAttribLocation(this.program,a):this.gl.getUniformLocation(this.program,a),this._locations[a]=c),c},getTextureId:function(a){var b=_.indexOf(this._textureVars,a);return-1===b&&(this._textureVars.push(a),b=this._textureVars.length-1),b},setUniform:function(a,b,c){var d=this.getLocation(a),e=this.gl;switch(b){case"texture2D":var f=this.getTextureId(a);e.activeTexture(e["TEXTURE"+f]),e.bindTexture(e.TEXTURE_2D,c),e.uniform1i(d,f);break;case"1f":case"2f":case"3f":case"4f":case"1i":case"2i":case"3i":case"4i":var g=[d].concat(_.drop(arguments,2));e["uniform"+b].apply(e,g);break;case"1fv":case"2fv":case"3fv":case"4fv":case"1iv":case"2iv":case"3iv":case"4iv":e["uniform"+b].apply(e,d,c)}},setVertexAttribArray:function(a,b,c,d,e,f,g){var h=this.gl;c=c||2,d=d||h.FLOAT,e=e||!1,f=f||0,g=g||0;var i=this._arrBuffers[a];_.isUndefined(i)&&(i=h.createBuffer(),this._arrBuffers[a]=i);var j=this.getLocation(a,!0);h.bindBuffer(h.ARRAY_BUFFER,i),h.bufferData(h.ARRAY_BUFFER,b,h.STATIC_DRAW),h.enableVertexAttribArray(j),h.vertexAttribPointer(j,c,d,e,f,g)},cleanup:function(){var a=this.gl;_.each(this._buffers,function(b){a.deleteBuffer(b)},this),a.deleteProgram(this.program),a.deleteShader(this.vertexShader),a.deleteShader(this.fragmentShader)}})}(Webvs),function(a){function b(a){a=_.defaults(a,{vertexShader:["attribute vec2 a_position;","void main() {","   setPosition(a_position);","}"],varyingPos:!0}),b.super.constructor.call(this,a)}a.QuadBoxProgram=a.defineClass(b,a.ShaderProgram,{draw:function(){this.setVertexAttribArray("a_position",new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1])),this.gl.drawArrays(this.gl.TRIANGLES,0,6)}})}(Webvs),function(a){function b(a){a=_.defaults(a||{},{fragmentShader:["uniform sampler2D u_copySource;","void main() {","   setFragColor(texture2D(u_copySource, v_position));","}"]}),b.super.constructor.call(this,a)}a.CopyProgram=a.defineClass(b,a.QuadBoxProgram,{draw:function(a){this.setUniform("u_copySource","texture2D",a),b.super.draw.call(this)}})}(Webvs),function(a){function b(a,b,c,d,e){this.gl=c,this.width=a,this.height=b,this.copier=d,this.texCount=e||2,this._initFrameBuffers()}a.FrameBufferManager=a.defineClass(b,Object,{_initFrameBuffers:function(){for(var a=this.gl,b=a.createFramebuffer(),c=[],d=0;d<this.texCount;d++){var e=a.createTexture();a.bindTexture(a.TEXTURE_2D,e),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,this.width,this.height,0,a.RGBA,a.UNSIGNED_BYTE,null);var f=a.createRenderbuffer();a.bindRenderbuffer(a.RENDERBUFFER,f),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,this.width,this.height),c[d]={texture:e,renderbuffer:f}}this.framebuffer=b,this.frameAttachments=c,this.currAttachment=0},setRenderTarget:function(){var a=this.gl;this.inputFrameBuffer=a.getParameter(a.FRAMEBUFFER_BINDING),a.bindFramebuffer(a.FRAMEBUFFER,this.framebuffer),a.viewport(0,0,this.width,this.height),this._setFBAttachment()},restoreRenderTarget:function(){var a=this.gl;a.bindFramebuffer(a.FRAMEBUFFER,this.inputFrameBuffer),a.viewport(0,0,this.width,this.height)},getCurrentTexture:function(){return this.frameAttachments[this.currAttachment].texture},copyOver:function(){var a=this.frameAttachments[Math.abs(this.currAttachment-1)%this.texCount].texture;this.copier.run(null,null,a)},swapAttachment:function(){this.currAttachment=(this.currAttachment+1)%this.texCount,this._setFBAttachment()},destroy:function(){for(var a=this.gl,b=0;b<this.texCount;b++)a.deleteRenderbuffer(this.frameAttachments[b].renderbuffer),a.deleteTexture(this.frameAttachments[b].texture);a.deleteFramebuffer(this.framebuffer)},_setFBAttachment:function(){var a=this.frameAttachments[this.currAttachment],b=this.gl;b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,a.texture,0),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,a.renderbuffer)}})}(Webvs),function(a){function b(a){b.super.constructor.call(this,{fragmentShader:["uniform vec3 u_color;","void main() {","   setFragColor(vec4(u_color, 1));","}"],outputBlendMode:a})}a.ClearScreenProgram=a.defineClass(b,a.QuadBoxProgram,{draw:function(a){this.setUniform.apply(this,["u_color","3f"].concat(a)),b.super.draw.call(this)}})}(Webvs),function(a){function b(){}function c(a,b,c){this.operator=a,this.leftOperand=b,this.rightOperand=c}function d(a,b){this.operator=a,this.operand=b}function e(a,b){this.funcName=a,this.args=b}function f(a,b){this.lhs=a,this.expr=b}function g(a){this.statements=a}function h(a,b){this.value=a,this.type=b}a.AstBase=a.defineClass(b,Object),a.AstBinaryExpr=a.defineClass(c,b),a.AstUnaryExpr=a.defineClass(d,b),a.AstFuncCall=a.defineClass(e,b),a.AstAssignment=a.defineClass(f,b),a.AstProgram=a.defineClass(g,b),a.AstPrimaryExpr=a.defineClass(h,b)}(Webvs),Webvs.PegExprParser=function(){function a(a){return'"'+a.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var b={parse:function(b,c){function d(a){var b={};for(var c in a)b[c]=a[c];return b}function e(a,c){for(var d=a.offset+c,e=a.offset;d>e;e++){var f=b.charAt(e);"\n"===f?(a.seenCR||a.line++,a.column=1,a.seenCR=!1):"\r"===f||"\u2028"===f||"\u2029"===f?(a.line++,a.column=1,a.seenCR=!0):(a.column++,a.seenCR=!1)}a.offset+=c}function f(a){F.offset<H.offset||(F.offset>H.offset&&(H=d(F),I=[]),I.push(a))}function g(){var a="program@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g,i,j,k,l,m,n,o,p,q;if(o=d(F),p=d(F),g=h(),null!==g)if(i=x(),null!==i){for(j=[],q=d(F),59===b.charCodeAt(F.offset)?(k=";",e(F,1)):(k=null,0===G&&f('";"')),null!==k?(l=x(),null!==l?(m=h(),null!==m?(n=x(),null!==n?k=[k,l,m,n]:(k=null,F=d(q))):(k=null,F=d(q))):(k=null,F=d(q))):(k=null,F=d(q));null!==k;)j.push(k),q=d(F),59===b.charCodeAt(F.offset)?(k=";",e(F,1)):(k=null,0===G&&f('";"')),null!==k?(l=x(),null!==l?(m=h(),null!==m?(n=x(),null!==n?k=[k,l,m,n]:(k=null,F=d(q))):(k=null,F=d(q))):(k=null,F=d(q))):(k=null,F=d(q));null!==j?(59===b.charCodeAt(F.offset)?(k=";",e(F,1)):(k=null,0===G&&f('";"')),k=null!==k?k:"",null!==k?g=[g,i,j,k]:(g=null,F=d(p))):(g=null,F=d(p))}else g=null,F=d(p);else g=null,F=d(p);return null!==g&&(g=function(a,b,c,d){var e=[d[0]];return e=e.concat(_.map(d[2],function(a){return a[2]})),new Webvs.AstProgram(e)}(o.offset,o.line,o.column,g)),null===g&&(F=d(o)),J[a]={nextPos:d(F),result:g},g}function h(){var a="statement@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g,h,i,j,k,l,n;return l=d(F),n=d(F),g=s(),null!==g?(h=x(),null!==h?(61===b.charCodeAt(F.offset)?(i="=",e(F,1)):(i=null,0===G&&f('"="')),null!==i?(j=x(),null!==j?(k=m(),null!==k?g=[g,h,i,j,k]:(g=null,F=d(n))):(g=null,F=d(n))):(g=null,F=d(n))):(g=null,F=d(n))):(g=null,F=d(n)),null!==g&&(g=function(a,b,c,d,e){return new Webvs.AstAssignment(d,e)}(l.offset,l.line,l.column,g[0],g[4])),null===g&&(F=d(l)),null===g&&(g=m()),J[a]={nextPos:d(F),result:g},g}function i(){var a="unary_ops@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g;return 43===b.charCodeAt(F.offset)?(g="+",e(F,1)):(g=null,0===G&&f('"+"')),null===g&&(45===b.charCodeAt(F.offset)?(g="-",e(F,1)):(g=null,0===G&&f('"-"'))),J[a]={nextPos:d(F),result:g},g}function j(){var a="additive_ops@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g;return 43===b.charCodeAt(F.offset)?(g="+",e(F,1)):(g=null,0===G&&f('"+"')),null===g&&(45===b.charCodeAt(F.offset)?(g="-",e(F,1)):(g=null,0===G&&f('"-"'))),J[a]={nextPos:d(F),result:g},g}function k(){var a="multiplicative_ops@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g;return 42===b.charCodeAt(F.offset)?(g="*",e(F,1)):(g=null,0===G&&f('"*"')),null===g&&(47===b.charCodeAt(F.offset)?(g="/",e(F,1)):(g=null,0===G&&f('"/"')),null===g&&(37===b.charCodeAt(F.offset)?(g="%",e(F,1)):(g=null,0===G&&f('"%"')))),J[a]={nextPos:d(F),result:g},g}function l(){var a="boolean_ops@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g;return 38===b.charCodeAt(F.offset)?(g="&",e(F,1)):(g=null,0===G&&f('"&"')),null===g&&(124===b.charCodeAt(F.offset)?(g="|",e(F,1)):(g=null,0===G&&f('"|"'))),J[a]={nextPos:d(F),result:g},g}function m(){var a="boolean_expr@"+F.offset,b=J[a];if(b)return F=d(b.nextPos),b.result;var c,e,f,g,h,i,j,k,m;if(j=d(F),k=d(F),c=n(),null!==c){for(e=[],m=d(F),f=x(),null!==f?(g=l(),null!==g?(h=x(),null!==h?(i=n(),null!==i?f=[f,g,h,i]:(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m));null!==f;)e.push(f),m=d(F),f=x(),null!==f?(g=l(),null!==g?(h=x(),null!==h?(i=n(),null!==i?f=[f,g,h,i]:(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m));null!==e?c=[c,e]:(c=null,F=d(k))}else c=null,F=d(k);return null!==c&&(c=function(a,b,c,d,e){return C(d,e)}(j.offset,j.line,j.column,c[0],c[1])),null===c&&(F=d(j)),J[a]={nextPos:d(F),result:c},c}function n(){var a="additive_expr@"+F.offset,b=J[a];if(b)return F=d(b.nextPos),b.result;var c,e,f,g,h,i,k,l,m;if(k=d(F),l=d(F),c=o(),null!==c){for(e=[],m=d(F),f=x(),null!==f?(g=j(),null!==g?(h=x(),null!==h?(i=o(),null!==i?f=[f,g,h,i]:(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m));null!==f;)e.push(f),m=d(F),f=x(),null!==f?(g=j(),null!==g?(h=x(),null!==h?(i=o(),null!==i?f=[f,g,h,i]:(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m));null!==e?c=[c,e]:(c=null,F=d(l))}else c=null,F=d(l);return null!==c&&(c=function(a,b,c,d,e){return C(d,e)}(k.offset,k.line,k.column,c[0],c[1])),null===c&&(F=d(k)),J[a]={nextPos:d(F),result:c},c}function o(){var a="multiplicative_expr@"+F.offset,b=J[a];if(b)return F=d(b.nextPos),b.result;var c,e,f,g,h,i,j,l,m;if(j=d(F),l=d(F),c=p(),null!==c){for(e=[],m=d(F),f=x(),null!==f?(g=k(),null!==g?(h=x(),null!==h?(i=p(),null!==i?f=[f,g,h,i]:(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m));null!==f;)e.push(f),m=d(F),f=x(),null!==f?(g=k(),null!==g?(h=x(),null!==h?(i=p(),null!==i?f=[f,g,h,i]:(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m))):(f=null,F=d(m));null!==e?c=[c,e]:(c=null,F=d(l))}else c=null,F=d(l);return null!==c&&(c=function(a,b,c,d,e){return C(d,e)}(j.offset,j.line,j.column,c[0],c[1])),null===c&&(F=d(j)),J[a]={nextPos:d(F),result:c},c}function p(){var a="unary@"+F.offset,b=J[a];if(b)return F=d(b.nextPos),b.result;var c,e,f,g,h;return g=d(F),h=d(F),c=i(),null!==c?(e=x(),null!==e?(f=q(),null!==f?c=[c,e,f]:(c=null,F=d(h))):(c=null,F=d(h))):(c=null,F=d(h)),null!==c&&(c=function(a,b,c,d,e){return new Webvs.AstUnaryExpr(d,e)}(g.offset,g.line,g.column,c[0],c[2])),null===c&&(F=d(g)),null===c&&(c=q()),J[a]={nextPos:d(F),result:c},c}function q(){var a="func_call@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g,h,i,j,k,l,n,o,p,q,s,t;if(p=d(F),q=d(F),s=d(F),/^[a-zA-Z_]/.test(b.charAt(F.offset))?(g=b.charAt(F.offset),e(F,1)):(g=null,0===G&&f("[a-zA-Z_]")),null!==g){for(h=[],/^[a-zA-Z_0-9]/.test(b.charAt(F.offset))?(i=b.charAt(F.offset),e(F,1)):(i=null,0===G&&f("[a-zA-Z_0-9]"));null!==i;)h.push(i),/^[a-zA-Z_0-9]/.test(b.charAt(F.offset))?(i=b.charAt(F.offset),e(F,1)):(i=null,0===G&&f("[a-zA-Z_0-9]"));null!==h?g=[g,h]:(g=null,F=d(s))}else g=null,F=d(s);if(null!==g)if(h=x(),null!==h)if(40===b.charCodeAt(F.offset)?(i="(",e(F,1)):(i=null,0===G&&f('"("')),null!==i){for(s=d(F),j=[],t=d(F),k=x(),null!==k?(l=m(),null!==l?(n=x(),null!==n?(44===b.charCodeAt(F.offset)?(o=",",e(F,1)):(o=null,0===G&&f('","')),null!==o?k=[k,l,n,o]:(k=null,F=d(t))):(k=null,F=d(t))):(k=null,F=d(t))):(k=null,F=d(t));null!==k;)j.push(k),t=d(F),k=x(),null!==k?(l=m(),null!==l?(n=x(),null!==n?(44===b.charCodeAt(F.offset)?(o=",",e(F,1)):(o=null,0===G&&f('","')),null!==o?k=[k,l,n,o]:(k=null,F=d(t))):(k=null,F=d(t))):(k=null,F=d(t))):(k=null,F=d(t));null!==j?(k=x(),null!==k?(l=m(),null!==l?j=[j,k,l]:(j=null,F=d(s))):(j=null,F=d(s))):(j=null,F=d(s)),j=null!==j?j:"",null!==j?(k=x(),null!==k?(41===b.charCodeAt(F.offset)?(l=")",e(F,1)):(l=null,0===G&&f('")"')),null!==l?g=[g,h,i,j,k,l]:(g=null,F=d(q))):(g=null,F=d(q))):(g=null,F=d(q))}else g=null,F=d(q);else g=null,F=d(q);else g=null,F=d(q);return null!==g&&(g=function(a,b,c,d,e){var f=[];return _.each(e[0],function(a){f.push(a[1])}),f.push(e[2]),new Webvs.AstFuncCall(D(d),f)}(p.offset,p.line,p.column,g[0],g[3])),null===g&&(F=d(p)),null===g&&(g=r()),J[a]={nextPos:d(F),result:g},g}function r(){var a="primary_expr@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g,h,i,j,k;return g=w(),null===g&&(g=u(),null===g&&(g=v(),null===g&&(g=t(),null===g&&(j=d(F),k=d(F),40===b.charCodeAt(F.offset)?(g="(",e(F,1)):(g=null,0===G&&f('"("')),null!==g?(h=m(),null!==h?(41===b.charCodeAt(F.offset)?(i=")",e(F,1)):(i=null,0===G&&f('")"')),null!==i?g=[g,h,i]:(g=null,F=d(k))):(g=null,F=d(k))):(g=null,F=d(k)),null!==g&&(g=function(a,b,c,d){return d}(j.offset,j.line,j.column,g[1])),null===g&&(F=d(j)))))),J[a]={nextPos:d(F),result:g},g}function s(){var a="assignable@"+F.offset,b=J[a];if(b)return F=d(b.nextPos),b.result;var c;return c=v(),null===c&&(c=t()),J[a]={nextPos:d(F),result:c},c}function t(){var a="identifier@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g,h,i,j,k;if(j=d(F),k=d(F),/^[a-zA-Z_]/.test(b.charAt(F.offset))?(g=b.charAt(F.offset),e(F,1)):(g=null,0===G&&f("[a-zA-Z_]")),null!==g){for(h=[],/^[a-zA-Z_0-9]/.test(b.charAt(F.offset))?(i=b.charAt(F.offset),e(F,1)):(i=null,0===G&&f("[a-zA-Z_0-9]"));null!==i;)h.push(i),/^[a-zA-Z_0-9]/.test(b.charAt(F.offset))?(i=b.charAt(F.offset),e(F,1)):(i=null,0===G&&f("[a-zA-Z_0-9]"));null!==h?g=[g,h]:(g=null,F=d(k))}else g=null,F=d(k);return null!==g&&(g=function(a,b,c,d){return new Webvs.AstPrimaryExpr(D(d).toLowerCase(),"ID")}(j.offset,j.line,j.column,g)),null===g&&(F=d(j)),J[a]={nextPos:d(F),result:g},g}function u(){var a="constant@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g,h,i,j,k;if(j=d(F),k=d(F),36===b.charCodeAt(F.offset)?(g="$",e(F,1)):(g=null,0===G&&f('"$"')),null!==g){for(h=[],/^[a-zA-Z_0-9]/.test(b.charAt(F.offset))?(i=b.charAt(F.offset),e(F,1)):(i=null,0===G&&f("[a-zA-Z_0-9]"));null!==i;)h.push(i),/^[a-zA-Z_0-9]/.test(b.charAt(F.offset))?(i=b.charAt(F.offset),e(F,1)):(i=null,0===G&&f("[a-zA-Z_0-9]"));null!==h?g=[g,h]:(g=null,F=d(k))}else g=null,F=d(k);return null!==g&&(g=function(a,b,c,d){return new Webvs.AstPrimaryExpr(D(d).toLowerCase(),"CONST")}(j.offset,j.line,j.column,g[1])),null===g&&(F=d(j)),J[a]={nextPos:d(F),result:g},g}function v(){var a="register@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g,h,i,j,k,l,m;if(l=d(F),m=d(F),64===b.charCodeAt(F.offset)?(g="@",e(F,1)):(g=null,0===G&&f('"@"')),null!==g){for(h=[],/^[a-zA-Z_0-9]/.test(b.charAt(F.offset))?(i=b.charAt(F.offset),e(F,1)):(i=null,0===G&&f("[a-zA-Z_0-9]"));null!==i;)h.push(i),/^[a-zA-Z_0-9]/.test(b.charAt(F.offset))?(i=b.charAt(F.offset),e(F,1)):(i=null,0===G&&f("[a-zA-Z_0-9]"));null!==h?g=[g,h]:(g=null,F=d(m))}else g=null,F=d(m);return null!==g&&(g=function(a,b,c,d){return new Webvs.AstPrimaryExpr("__REG_AT_"+D(d).toLowerCase(),"REG")}(l.offset,l.line,l.column,g[1])),null===g&&(F=d(l)),null===g&&(l=d(F),m=d(F),/^[rR]/.test(b.charAt(F.offset))?(g=b.charAt(F.offset),e(F,1)):(g=null,0===G&&f("[rR]")),null!==g?(/^[eE]/.test(b.charAt(F.offset))?(h=b.charAt(F.offset),e(F,1)):(h=null,0===G&&f("[eE]")),null!==h?(/^[gG]/.test(b.charAt(F.offset))?(i=b.charAt(F.offset),e(F,1)):(i=null,0===G&&f("[gG]")),null!==i?(/^[0-9]/.test(b.charAt(F.offset))?(j=b.charAt(F.offset),e(F,1)):(j=null,0===G&&f("[0-9]")),null!==j?(/^[0-9]/.test(b.charAt(F.offset))?(k=b.charAt(F.offset),e(F,1)):(k=null,0===G&&f("[0-9]")),null!==k?g=[g,h,i,j,k]:(g=null,F=d(m))):(g=null,F=d(m))):(g=null,F=d(m))):(g=null,F=d(m))):(g=null,F=d(m)),null!==g&&(g=function(a,b,c,d){return new Webvs.AstPrimaryExpr("__REG_"+D(d).toLowerCase(),"REG")}(l.offset,l.line,l.column,g)),null===g&&(F=d(l))),J[a]={nextPos:d(F),result:g},g}function w(){var a="value@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g,h,i,j,k,l,m,n,o;for(m=d(F),n=d(F),g=[],/^[0-9]/.test(b.charAt(F.offset))?(h=b.charAt(F.offset),e(F,1)):(h=null,0===G&&f("[0-9]"));null!==h;)g.push(h),/^[0-9]/.test(b.charAt(F.offset))?(h=b.charAt(F.offset),e(F,1)):(h=null,0===G&&f("[0-9]"));if(null!==g)if(46===b.charCodeAt(F.offset)?(h=".",e(F,1)):(h=null,0===G&&f('"."')),null!==h){if(/^[0-9]/.test(b.charAt(F.offset))?(j=b.charAt(F.offset),e(F,1)):(j=null,0===G&&f("[0-9]")),null!==j)for(i=[];null!==j;)i.push(j),/^[0-9]/.test(b.charAt(F.offset))?(j=b.charAt(F.offset),e(F,1)):(j=null,0===G&&f("[0-9]"));else i=null;if(null!==i){if(o=d(F),/^[Ee]/.test(b.charAt(F.offset))?(j=b.charAt(F.offset),e(F,1)):(j=null,0===G&&f("[Ee]")),null!==j){if(/^[0-9]/.test(b.charAt(F.offset))?(l=b.charAt(F.offset),e(F,1)):(l=null,0===G&&f("[0-9]")),null!==l)for(k=[];null!==l;)k.push(l),/^[0-9]/.test(b.charAt(F.offset))?(l=b.charAt(F.offset),e(F,1)):(l=null,0===G&&f("[0-9]"));else k=null;null!==k?j=[j,k]:(j=null,F=d(o))}else j=null,F=d(o);j=null!==j?j:"",null!==j?g=[g,h,i,j]:(g=null,F=d(n))}else g=null,F=d(n)}else g=null,F=d(n);else g=null,F=d(n);if(null!==g&&(g=function(a,b,c,d){return new Webvs.AstPrimaryExpr(parseFloat(D(d)),"VALUE")}(m.offset,m.line,m.column,g)),null===g&&(F=d(m)),null===g){if(m=d(F),n=d(F),/^[a-fA-F0-9]/.test(b.charAt(F.offset))?(h=b.charAt(F.offset),e(F,1)):(h=null,0===G&&f("[a-fA-F0-9]")),null!==h)for(g=[];null!==h;)g.push(h),/^[a-fA-F0-9]/.test(b.charAt(F.offset))?(h=b.charAt(F.offset),e(F,1)):(h=null,0===G&&f("[a-fA-F0-9]"));else g=null;if(null!==g?(/^[hH]/.test(b.charAt(F.offset))?(h=b.charAt(F.offset),e(F,1)):(h=null,0===G&&f("[hH]")),null!==h?g=[g,h]:(g=null,F=d(n))):(g=null,F=d(n)),null!==g&&(g=function(a,b,c,d){return new Webvs.AstPrimaryExpr(parseInt(D(d),16),"VALUE")}(m.offset,m.line,m.column,g[0])),null===g&&(F=d(m)),null===g){if(m=d(F),n=d(F),/^[0-9]/.test(b.charAt(F.offset))?(h=b.charAt(F.offset),e(F,1)):(h=null,0===G&&f("[0-9]")),null!==h)for(g=[];null!==h;)g.push(h),/^[0-9]/.test(b.charAt(F.offset))?(h=b.charAt(F.offset),e(F,1)):(h=null,0===G&&f("[0-9]"));else g=null;null!==g?(/^[dD]/.test(b.charAt(F.offset))?(h=b.charAt(F.offset),e(F,1)):(h=null,0===G&&f("[dD]")),h=null!==h?h:"",null!==h?g=[g,h]:(g=null,F=d(n))):(g=null,F=d(n)),null!==g&&(g=function(a,b,c,d){return new Webvs.AstPrimaryExpr(parseInt(D(d),10),"VALUE")}(m.offset,m.line,m.column,g[0])),null===g&&(F=d(m))}}return J[a]={nextPos:d(F),result:g},g}function x(){var a="__@"+F.offset,b=J[a];if(b)return F=d(b.nextPos),b.result;var c,e;for(c=[],e=y(),null===e&&(e=z(),null===e&&(e=A()));null!==e;)c.push(e),e=y(),null===e&&(e=z(),null===e&&(e=A()));return J[a]={nextPos:d(F),result:c},c}function y(){var a="whiteSpace@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g;return/^[\t\x0B\f \xA0\uFEFF]/.test(b.charAt(F.offset))?(g=b.charAt(F.offset),e(F,1)):(g=null,0===G&&f("[\\t\\x0B\\f \\xA0\\uFEFF]")),J[a]={nextPos:d(F),result:g},g}function z(){var a="lineEnd@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g;return/^[\n\r\u2028\u2029]/.test(b.charAt(F.offset))?(g=b.charAt(F.offset),e(F,1)):(g=null,0===G&&f("[\\n\\r\\u2028\\u2029]")),J[a]={nextPos:d(F),result:g},g}function A(){var a="comment@"+F.offset,c=J[a];if(c)return F=d(c.nextPos),c.result;var g,h,i,j,k,l,m;if(k=d(F),"/*"===b.substr(F.offset,2)?(g="/*",e(F,2)):(g=null,0===G&&f('"/*"')),null!==g){for(h=[],l=d(F),m=d(F),G++,"*/"===b.substr(F.offset,2)?(i="*/",e(F,2)):(i=null,0===G&&f('"*/"')),G--,null===i?i="":(i=null,F=d(m)),null!==i?(b.length>F.offset?(j=b.charAt(F.offset),e(F,1)):(j=null,0===G&&f("any character")),null!==j?i=[i,j]:(i=null,F=d(l))):(i=null,F=d(l));null!==i;)h.push(i),l=d(F),m=d(F),G++,"*/"===b.substr(F.offset,2)?(i="*/",e(F,2)):(i=null,0===G&&f('"*/"')),G--,null===i?i="":(i=null,F=d(m)),null!==i?(b.length>F.offset?(j=b.charAt(F.offset),e(F,1)):(j=null,0===G&&f("any character")),null!==j?i=[i,j]:(i=null,F=d(l))):(i=null,F=d(l));null!==h?("*/"===b.substr(F.offset,2)?(i="*/",e(F,2)):(i=null,0===G&&f('"*/"')),null!==i?g=[g,h,i]:(g=null,F=d(k))):(g=null,F=d(k))}else g=null,F=d(k);if(null===g)if(k=d(F),"//"===b.substr(F.offset,2)?(g="//",e(F,2)):(g=null,0===G&&f('"//"')),null!==g){for(h=[],l=d(F),m=d(F),G++,i=z(),G--,null===i?i="":(i=null,F=d(m)),null!==i?(b.length>F.offset?(j=b.charAt(F.offset),e(F,1)):(j=null,0===G&&f("any character")),null!==j?i=[i,j]:(i=null,F=d(l))):(i=null,F=d(l));null!==i;)h.push(i),l=d(F),m=d(F),G++,i=z(),G--,null===i?i="":(i=null,F=d(m)),null!==i?(b.length>F.offset?(j=b.charAt(F.offset),e(F,1)):(j=null,0===G&&f("any character")),null!==j?i=[i,j]:(i=null,F=d(l))):(i=null,F=d(l));null!==h?g=[g,h]:(g=null,F=d(k))}else g=null,F=d(k);return J[a]={nextPos:d(F),result:g},g}function B(a){a.sort();for(var b=null,c=[],d=0;d<a.length;d++)a[d]!==b&&(c.push(a[d]),b=a[d]);return c}function C(a,b){var c=a;return _.each(b,function(a){c=new Webvs.AstBinaryExpr(a[1],c,a[3])
}),c}function D(a){return _.flatten(a).join("")}var E={program:g,statement:h,unary_ops:i,additive_ops:j,multiplicative_ops:k,boolean_ops:l,boolean_expr:m,additive_expr:n,multiplicative_expr:o,unary:p,func_call:q,primary_expr:r,assignable:s,identifier:t,constant:u,register:v,value:w,__:x,whiteSpace:y,lineEnd:z,comment:A};if(void 0!==c){if(void 0===E[c])throw new Error("Invalid rule name: "+a(c)+".")}else c="program";var F={offset:0,line:1,column:1,seenCR:!1},G=0,H={offset:0,line:1,column:1,seenCR:!1},I=[],J={},K=E[c]();if(null===K||F.offset!==b.length){var L=Math.max(F.offset,H.offset),M=L<b.length?b.charAt(L):null,N=F.offset>H.offset?F:H;throw new this.SyntaxError(B(I),M,L,N.line,N.column)}return K},toSource:function(){return this._source}};return b.SyntaxError=function(b,c,d,e,f){function g(b,c){var d,e;switch(b.length){case 0:d="end of input";break;case 1:d=b[0];break;default:d=b.slice(0,b.length-1).join(", ")+" or "+b[b.length-1]}return e=c?a(c):"end of input","Expected "+d+" but "+e+" found."}this.name="SyntaxError",this.expected=b,this.found=c,this.message=g(b,c),this.offset=d,this.line=e,this.column=f},b.SyntaxError.prototype=Error.prototype,b}(),function(a){function b(){}a.CodeInstance=a.defineClass(b,Object,{rand:function(a){return Math.floor(Math.random()*a)+1},gettime:function(a){switch(a){case 0:var b=(new Date).getTime();return(b-this._bootTime)/1e3;default:throw new Error("Invalid startTime mode for gettime call")}},getosc:function(a,b){for(var c=this._analyser.getWaveform(),d=Math.floor((a-b/2)*(c.length-1)),e=Math.floor((a+b/2)*(c.length-1)),f=0,g=d;e>=g;g++)f+=c[g];return f/(e-d+1)},bindUniforms:function(a){var b=this,c=_.difference(_.keys(this),this._treatAsNonUniform);if(_.each(c,function(c){var d=b[c];"number"==typeof d&&a.setUniform(c,"1f",d)}),_.each(this._registerUsages,function(b){a.setUniform(b,"1f",this._registerBank[b])}),this.hasRandom){var d=[Math.random()/100,Math.random()/100];a.setUniform("__randStep","2fv",d)}if(this.hasGettime){var e=((new Date).getTime()-this._bootTime)/1e3;a.setUniform("__gettime0","1f",e)}_.each(this._preCompute,function(b){var c=_.map(_.last(b,b.length-2),function(a){return _.isString(a)?"__REG"==a.substring(0,5)?this._registerBank[a]:this[a]:a}),d=this[b[0]].apply(this,c);a.setUniform(b[1],"1f",d)})},setup:function(a,b){this._registerBank=a.registerBank,this._bootTime=a.bootTime,this._analyser=a.analyser,this.w=a.canvas.width,this.h=a.canvas.height,this.cid=b.cloneId,_.each(this._registerUsages,function(b){_.has(a.registerBank,b)||(a.registerBank[b]=0)})}})}(Webvs),function(a){function b(a,b){this.codeSrc=a,this.externalVars=b?b:[],this._parseSrc()}a.ExprCodeGenerator=a.defineClass(b,Object,{_parseSrc:function(){var b={},c=[],d={},e=[];for(var f in this.codeSrc)try{var g=this.codeSrc[f];_.isArray(g)&&(g=g.join("\n")),b[f]=a.PegExprParser.parse(g);var h=[];this._getVars(b[f],c,h,e),d[f]=h}catch(i){throw new Error("Error parsing "+f+"("+i.line+":"+i.column+")"+" : "+i)}this.codeAst=b,this.funcUsages=d,this.instanceVars=_.uniq(this.externalVars.concat(c)),this.registerUsages=_.uniq(e)},generateCode:function(b,c,d){var e=new a.CodeInstance,f=this,g=[];_.each(this.instanceVars,function(a){e[a]=0;var b="";_.contains(d,a)||(b="uniform "),g.push(b+"float "+a+";")});var h=_.intersection(_.keys(this.codeAst),b),i=_.difference(b,h);_.each(h,function(a){var b=f.codeAst[a],c=f._generateJs(b);e[a]=new Function(c)}),_.each(i,function(b){e[b]=a.noop});var j=_.intersection(_.keys(this.codeAst),c),k=_.difference(c,j),l=_.uniq(_.flatMap(j,function(a){return f.funcUsages[a]}));_.each(l,function(a){var b=f.glslFuncCode[a];b&&g.push(b)});var m=[],n=[];return _.each(j,function(a){var b=f.codeAst[a],c=f._generateGlsl(b,m);n.push("void "+a+"() {"),n.push(c),n.push("}")}),g=g.concat(_.map(m,function(a){return"uniform float "+a[1]+";"})),g=g.concat(n),e._preCompute=m,_.each(k,function(a){g.push("void "+a+"() {}")}),_.contains(j,"rand")&&(e.hasRandom=!0),_.contains(j,"gettime")&&(e.hasGettime=!0),e._treatAsNonUniform=d,e._registerUsages=this.registerUsages,[e,g.join("")]},funcArgLengths:{above:2,below:2,equal:2,pow:2,sqr:1,sqrt:1,invsqrt:1,floor:1,ceil:1,abs:1,"if":3,sin:1,cos:1,tan:1,asin:1,acos:1,atan:1,atan2:2,log:1,band:2,bor:2,bnot:1,rand:1,gettime:1,getosc:3,select:{min:2}},jsMathFuncs:["sin","cos","abs","tan","asin","acos","atan","log","pow","sqrt","floor","ceil"],glslFuncCode:{rand:["uniform vec2 __randStep;","vec2 __randSeed;","float rand(float max) {","   __randCur += __randStep;","   float val = fract(sin(dot(__randSeed.xy ,vec2(12.9898,78.233))) * 43758.5453);","   return (floor(val*max)+1);","}"].join("\n"),gettime:["uniform float __gettime0;","int gettime(int startTime) {","   int time = 0;","   if(startTime == 0) {","       time = __gettime0;","   }","   return time;","}"].join("\n")},_checkFunc:function(a){var b=this.funcArgLengths[a.funcName];if(void 0===b)throw Error("Unknown function "+a.funcName);if(_.isNumber(b)){if(a.args.length!=b)throw Error(a.funcName+" accepts "+b+" arguments")}else if(b.min&&a.args.length<b.min)throw Error(a.funcName+" accepts atleast "+b.min+" arguments")},_generateGlsl:function(b,c){var d=this;if(b instanceof a.AstBinaryExpr)return"("+this._generateGlsl(b.leftOperand,c)+b.operator+this._generateGlsl(b.rightOperand,c)+")";if(b instanceof a.AstUnaryExpr)return"("+b.operator+this._generateGlsl(b.operand,c)+")";if(b instanceof a.AstFuncCall)switch(this._checkFunc(b),b.funcName){case"above":return["(",this._generateGlsl(b.args[0],c),">",this._generateGlsl(b.args[1],c),"?1.0:0.0)"].join("");case"below":return["(",this._generateGlsl(b.args[0],c),"<",this._generateGlsl(b.args[1],c),"?1.0:0.0)"].join("");case"equal":return["(",this._generateGlsl(b.args[0],c),"==",this._generateGlsl(b.args[1],c),"?1.0:0.0)"].join("");case"if":return["(",this._generateGlsl(b.args[0],c),"!=0.0?",this._generateGlsl(b.args[1],c),":",this._generateGlsl(b.args[2],c),")"].join("");case"select":var e=this._generateGlsl(b.args[0],c),f=function(a,b){return 1==a.length?d._generateGlsl(a[0],c):["(("+e+" === "+b+")?","("+d._generateGlsl(a[0],c)+"):","("+f(_.last(a,a.length-1),b+1)+"))"].join("")};return f(_.last(b.args,b.args.length-1),0);case"sqr":return"(pow(("+this._generateGlsl(b.args[0],c)+"), 2))";case"band":return"(float(("+this._generateGlsl(b.args[0],c)+")&&("+this._generateGlsl(b.args[1],c)+")))";case"bor":return"(float(("+this._generateGlsl(b.args[0],c)+")||("+this._generateGlsl(b.args[1],c)+")))";case"bnot":return"(float(!("+this._generateGlsl(b.args[0],c)+")))";case"invsqrt":return"(1/sqrt("+this._generateGlsl(b.args[0],c)+"))";case"atan2":return"(atan(("+this._generateGlsl(b.args[0],c)+"),("+this._generateGlsl(b.args[1],c)+"))";case"getosc":var g=_.every(b.args,function(b){return b instanceof a.AstPrimaryExpr});if(!g)throw new Error("Non Pre-Computable arguments for getosc in shader code, use variables or constants");var h="__PC_"+b.funcName+"_"+j,i=[b.funcName,h].concat(_.map(b.args,function(a){return a.value})),j=_.indexOf(c,i);return-1==j&&(c.push(i),j=c.length-1),h;default:var k=_.map(b.args,function(a){return d._generateGlsl(a,c)}).join(","),l=b.funcName;return _.contains(this.varArgFuncs,b.funcName)&&(l+=b.args.length),"("+l+"("+k+"))"}if(b instanceof a.AstAssignment)return this._generateGlsl(b.lhs,c)+"="+this._generateGlsl(b.expr,c);if(b instanceof a.AstProgram){var m=_.map(b.statements,function(a){return d._generateGlsl(a,c)});return m.join(";\n")+";"}return b instanceof a.AstPrimaryExpr&&"VALUE"===b.type?a.glslFloatRepr(b.value):b instanceof a.AstPrimaryExpr&&"CONST"===b.type?this._translateConstants(b.value).toString():b instanceof a.AstPrimaryExpr&&("ID"===b.type||"REG"===b.type)?b.value:void 0},_generateJs:function(b){var c,d=this;if(b instanceof a.AstBinaryExpr)return"("+this._generateJs(b.leftOperand)+b.operator+this._generateJs(b.rightOperand)+")";if(b instanceof a.AstUnaryExpr)return"("+b.operator+this._generateJs(b.operand)+")";if(b instanceof a.AstFuncCall)switch(this._checkFunc(b),b.funcName){case"above":return["(",this._generateJs(b.args[0]),">",this._generateJs(b.args[1]),"?1:0)"].join("");case"below":return["(",this._generateJs(b.args[0]),"<",this._generateJs(b.args[1]),"?1:0)"].join("");case"equal":return["(",this._generateJs(b.args[0]),"==",this._generateJs(b.args[1]),"?1:0)"].join("");case"if":return["(",this._generateJs(b.args[0]),"!==0?",this._generateJs(b.args[1]),":",this._generateJs(b.args[2]),")"].join("");case"select":var e=["((function() {"];return e.push("switch("+this._generateJs(b.args[0])+") {"),_.each(_.last(b.args,b.args.length-1),function(a,b){e.push("case "+b+": return "+this._generateJs(a)+";")},this),e.push("default : throw new Error('Unknown selector value in select');"),e.push("}}).call(this))"),e.join("");case"sqr":return"(Math.pow(("+this._generateJs(b.args[0])+"),2))";case"band":return"((("+this._generateJs(b.args[0])+")&&("+this._generateJs(b.args[1])+"))?1:0)";case"bor":return"((("+this._generateJs(b.args[0])+")||("+this._generateJs(b.args[1])+"))?1:0)";case"bnot":return"((!("+this._generateJs(b.args[0])+"))?1:0)";case"invsqrt":return"(1/Math.sqrt("+this._generateJs(b.args[0])+"))";case"atan2":return"(Math.atan(("+this._generateJs(b.args[0])+")/("+this._generateJs(b.args[1])+")))";default:var f=_.map(b.args,function(a){return d._generateJs(a)}).join(",");return c=_.contains(this.jsMathFuncs,b.funcName)?"Math.":"this.","("+c+b.funcName+"("+f+"))"}if(b instanceof a.AstAssignment)return this._generateJs(b.lhs)+"="+this._generateJs(b.expr);if(b instanceof a.AstProgram){var g=_.map(b.statements,function(a){return d._generateJs(a)});return g.join(";\n")}return b instanceof a.AstPrimaryExpr&&"VALUE"===b.type?b.value.toString():b instanceof a.AstPrimaryExpr&&"CONST"===b.type?this._translateConstants(b.value).toString():b instanceof a.AstPrimaryExpr&&"ID"===b.type?"this."+b.value:b instanceof a.AstPrimaryExpr&&"REG"===b.type?'this._registerBank["'+b.value+'"]':void 0},_getVars:function(b,c,d,e){var f=this;b instanceof a.AstBinaryExpr?(this._getVars(b.leftOperand,c,d,e),this._getVars(b.rightOperand,c,d,e)):b instanceof a.AstUnaryExpr?this._getVars(b.operand,c,d,e):b instanceof a.AstFuncCall?(d.push(b.funcName),_.each(b.args,function(a){f._getVars(a,c,d,e)})):b instanceof a.AstAssignment?(this._getVars(b.lhs,c,d,e),this._getVars(b.expr,c,d,e)):b instanceof a.AstProgram?_.each(b.statements,function(a){f._getVars(a,c,d,e)}):b instanceof a.AstPrimaryExpr&&"ID"===b.type?c.push(b.value):b instanceof a.AstPrimaryExpr&&"REG"===b.type&&e.push(b.value)},_translateConstants:function(a){switch(a){case"pi":return Math.PI;case"e":return Math.E;case"phi":return 1.6180339887;default:throw new Error("Unknown constant "+a)}}})}(Webvs),function(a){function b(c){a.checkRequiredOptions(c,["code"]);var d=new a.ExprCodeGenerator(c.code,["b","w","h"]),e=d.generateCode(["init","onBeat","perFrame"],[],[]);this.code=e[0],this.inited=!1,b.super.constructor.call(this)}a.GlobalVar=a.defineClass(b,a.Component,{init:function(a,c,d){b.super.init.call(this,a,c,d),this.code.setup(c,this)},update:function(){var a=this.code;a.b=this.main.analyser.beat?1:0,this.inited||(a.init(),this.inited=!0),this.main.analyser.beat&&a.onBeat(),a.perFrame()}}),b.ui={disp:"Global Var",type:"GlobalVar",schema:{code:{type:"object",title:"Code","default":{},properties:{init:{type:"string",title:"Init"},onBeat:{type:"string",title:"On Beat"},perFrame:{type:"string",title:"Per Frame"}}}}}}(Webvs),function(a){function b(c){if(c=_.defaults(c,{action:"SAVE",bufferId:1,blendMode:"REPLACE"}),this.blendMode=a.blendModes[c.blendMode],this.action=this.actions[c.action],!this.action)throw new Error("Unknown BufferSave action "+c.action);this.action==this.actions.SAVERESTORE?this._nextAction=this.actions.SAVE:this.action==this.actions.RESTORESAVE&&(this._nextAction=this.actions.RESTORE),this._bufferId="__BUFFERSAVE_"+c.bufferId,b.super.constructor.call(this)}a.BufferSave=a.defineClass(b,a.Component,{actions:{SAVE:1,RESTORE:2,SAVERESTORE:3,RESTORESAVE:4},init:function(c,d,e){if(b.super.init.call(this,c,d,e),!d.registerBank[this._bufferId]){var f=new a.FrameBufferManager(d.canvas.width,d.canvas.height,c,d.copier,1);d.registerBank[this._bufferId]=f}},update:function(){this.gl;var a,b=this.main.registerBank[this._bufferId];switch(this.action==this.actions.SAVERESTORE||this.action==this.RESTORESAVE?(a=this._nextAction,this._nextAction=this._nextAction==this.actions.SAVE?this.actions.RESTORE:this.actions.SAVE):a=this.action,a){case this.actions.SAVE:b.setRenderTarget(),this.main.copier.run(null,null,this.parent.fm.getCurrentTexture()),b.restoreRenderTarget();break;case this.actions.RESTORE:this.main.copier.run(this.parent.fm,this.blendMode,b.getCurrentTexture())}},destroy:function(){b.super.destroy.call(this),this.main.registerBank[this._bufferId].destroy()}}),b.ui={disp:"Buffer Save",type:"BufferSave",schema:{action:{type:"string",title:"Buffer save action","enum":["SAVE","RESTORE","SAVERESTORE","RESTORESAVE"]},bufferId:{type:"number",title:"Buffer Id","enum":[1,2,3,4,5,6,7,8]},blendMode:{type:"string",title:"Blend mode","enum":_.keys(a.blendModes)}}}}(Webvs),function(a){function b(c){c=_.defaults(c,{speed:1,color:"#000000"}),this.color=a.parseColorNorm(c.color),this.frameCount=0,this.maxFrameCount=Math.floor(1/c.speed),this.program=new a.ClearScreenProgram(a.AVERAGE),b.super.constructor.call(this)}a.FadeOut=a.defineClass(b,a.Component,{componentName:"FadeOut",init:function(a,c,d){b.super.init.call(this,a,c,d),this.program.init(a)},update:function(){this.gl,this.frameCount++,this.frameCount==this.maxFrameCount&&(this.frameCount=0,this.program.run(this.parent.fm,null,this.color))},destroy:function(){b.super.destroy.call(this),this.program.cleanup()}}),b.ui={type:"FadeOut",disp:"Fade Out",schema:{speed:{type:"number",title:"Speed",maximum:0,minimum:1,"default":1},color:{type:"string",title:"Fadeout color",format:"color","default":"#FFFFFF"}},form:[{key:"speed",type:"range",step:"0.05"},"color"]}}(Webvs),function(a){function b(c){a.checkRequiredOptions(c,["kernel"]),c=_.defaults(c,{edgeMode:"EXTEND",bias:0});var d;if(c.kernel in b.kernels)d=b.kernels[c.kernel];else{if(!_.isArray(c.kernel)||1!==c.kernel.length%2)throw new Error("Invalid convolution kernel");d=c.kernel}var e=Math.floor(Math.sqrt(d.length));if(e*e!=d.length)throw new Error("Invalid convolution kernel");this.program=new a.ConvolutionProgram(d,e,c.edgeMode,c.scale,c.bias),b.super.constructor.call(this)}function c(b,d,e,f,g){var h="";switch(e){case"WRAP":h="pos = vec2(pos.x<0?pos.x+1.0:pos.x%1, pos.y<0?pos.y+1.0:pos.y%1);";break;case"EXTEND":h="pos = clamp(pos, vec2(0,0), vec2(1,1));";break;default:throw new Error("Invalid edge mode")}var i,j,k=[],l=Math.floor(d/2);for(i=0;d>i;i++)for(j=0;d>j;j++){var m=b[i*d+j];0!==m&&(k.push("pos = v_position + onePixel * vec2("+(i-l)+","+(j-l)+");"),k.push(h),k.push("colorSum += texture2D(u_srcTexture, pos) * "+a.glslFloatRepr(m)+";"))}_.isUndefined(f)&&(f=_.reduce(b,function(a,b){return a+b},0)),c.super.constructor.call(this,{swapFrame:!0,fragmentShader:["void main() {","   vec2 onePixel = vec2(1.0, 1.0)/u_resolution;","   vec2 pos;","   vec4 colorSum = vec4(0,0,0,0);",k.join("\n"),"   setFragColor(vec4(((colorSum+"+a.glslFloatRepr(g)+") / "+a.glslFloatRepr(f)+").rgb, 1.0));","}"]})}a.Convolution=a.defineClass(b,a.Component,{componentName:"Convolution",init:function(a,c,d){b.super.init.call(this,a,c,d),this.program.init(a)},update:function(){this.program.run(this.parent.fm,null)},destroy:function(){b.super.destroy.call(this),this.program.cleanup()}}),b.kernels={normal:[0,0,0,0,1,0,0,0,0],gaussianBlur:[.045,.122,.045,.122,.332,.122,.045,.122,.045],unsharpen:[-1,-1,-1,-1,9,-1,-1,-1,-1],emboss:[-2,-1,0,-1,1,1,0,1,2],blur:[1,1,1,1,1,1,1,1,1]},a.ConvolutionProgram=a.defineClass(c,a.QuadBoxProgram)}(Webvs),function(a){function b(c){if(a.checkRequiredOptions(c,["maps"]),c=_.defaults(c,{key:"RED",output:"REPLACE",mapCycleMode:"SINGLE"}),this.maps=c.maps,this.currentMap=0,this.mapCycleMode=this.mapCycleModes[c.mapCycleMode],!this.mapCycleMode)throw new Error("Unknown mapCycleMode "+c.mapCycleMode);this.program=new a.ColorMapProgram(c.key,a.blendModes[c.output]),b.super.constructor.call(this)}function c(a,b){var d="";switch(a){case"RED":d="srcColor.r";break;case"GREEN":d="srcColor.g";break;case"BLUE":d="srcColor.b";break;case"(R+G+B)/2":d="mod((srcColor.r+srcColor.g+srcColor.b)/2.0, 1.0)";break;case"(R+G+B)/3":d="(srcColor.r+srcColor.g+srcColor.b)/3.0";break;case"MAX":d="max(srcColor.r, max(srcColor.g, srcColor.b))";break;default:throw new Error("Unknown colormap key function "+options.key)}c.super.constructor.call(this,{outputBlendMode:b,swapFrame:!0,fragmentShader:["uniform sampler2D u_colorMap;","void main() {","   vec4 srcColor = getSrcColor();","   setFragColor(texture2D(u_colorMap, vec2(("+d+"), 0)));","}"]})}a.ColorMap=a.defineClass(b,a.Component,{mapCycleModes:{SINGLE:1,ONBEATRANDOM:2,ONBEATSEQUENTIAL:3},init:function(a,c,d){b.super.init.call(this,a,c,d),this.colorMaps=_.map(this.maps,function(a){return this._buildColorMap(a)},this),this.currentMap=0,this.program.init(a)},update:function(){if(this.main.analyser.beat)switch(this.mapCycleMode){case this.mapCycleModes.ONBEATRANDOM:this.currentMap=Math.floor(Math.random()*this.colorMaps.length);break;case this.mapCycleModes.ONBEATSEQUENTIAL:this.currentMap=(this.currentMap+1)%this.colorMaps.length}this.program.run(this.parent.fm,null,this.colorMaps[this.currentMap])},destroy:function(){b.super.destroy.call(this),this.program.cleanup()},_buildColorMap:function(b){var c=this.gl;b=_.sortBy(b,function(a){return a.index});var d=_.map(b,function(a){return a.index});if(_.uniq(d).length!=d.length)throw new Error("map cannot have repeated indices");var e=_.first(b);0!==e.index&&b.splice(0,0,{color:e.color,index:0});var f=_.last(b);255!==f.index&&b.push({color:f.color,index:255}),b=_.map(b,function(b){var c=a.parseColor(b.color);return{color:c,index:b.index}});var g=new Uint8Array(1024),h=0,i=_.zip(_.first(b,b.length-1),_.last(b,b.length-1));_.each(i,function(a){var b=a[0],c=a[1],d=c.index-b.index,e=[(c.color[0]-b.color[0])/d,(c.color[1]-b.color[1])/d,(c.color[2]-b.color[2])/d];_.times(d,function(a){g[h++]=b.color[0]+e[0]*a,g[h++]=b.color[1]+e[1]*a,g[h++]=b.color[2]+e[2]*a,g[h++]=255})}),g[h++]=f.color[0],g[h++]=f.color[1],g[h++]=f.color[2],g[h++]=255;var j=c.createTexture();return c.bindTexture(c.TEXTURE_2D,j),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,256,1,0,c.RGBA,c.UNSIGNED_BYTE,g),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),j}}),a.ColorMapProgram=a.defineClass(c,a.QuadBoxProgram,{draw:function(a){this.setUniform("u_colorMap","texture2D",a),c.super.draw.call(this)}}),b.ui={disp:"Color Map",type:"ColorMap",schema:{maps:{type:"array",items:{type:"array",title:"Map",items:{type:"object",properties:{color:{type:"string",title:"Color",format:"color","default":"#FFFFFF"},index:{type:"number",title:"Index",minimum:0,maximum:255}}}}},key:{type:"string",title:"Map key","enum":["RED","GREEN","BLUE","(R+G+B)/2","(R+G+B)/3","MAX"],"default":"RED"},mapCycleMode:{type:"string",title:"Map Cycle Mode","enum":["SINGLE","ONBEATRANDOM","ONBEATSEQUENTIAL"],"default":"SINGLE"},output:{type:"string",title:"Output blend mode","enum":_.keys(a.blendModes),"default":"REPLACE"}}}}(Webvs),function(a){function b(b){if(a.checkRequiredOptions(b,["mode","color","outColor"]),b=_.defaults(b,{mode:"BELOW",color:"#202020",outColor:"#202020",level:0}),this.mode=_.indexOf(this.modes,b.mode),-1==this.mode)throw new Error("ColorClip: invalid mode");this.color=a.parseColorNorm(b.color),this.outColor=a.parseColorNorm(b.outColor),this.level=b.level,this.program=new a.ColorClipProgram}function c(){c.super.constructor({swapFrame:!0,fragmentShader:["uniform int u_mode;","uniform vec3 u_color;","uniform vec3 u_outColor;","uniform float u_level;","void main() {","   vec4 inColor4 = getSrcColor();","   vec3 inColor = inColor4.rgb;","   bool clip = false;","   if(u_mode == 0) {","           clip = all(lessThanEqual(inColor, u_color));","   }","   if(u_mode == 1) {","           clip = all(greaterThanEqual(inColor, u_color));","   }","   if(u_mode == 2) {","           clip = (distance(inColor, u_color) <= u_level*0.5);","   }","   if(clip) {","       setFragColor(vec4(u_outColor, inColor4.a));","   } else {","       setFragColor(inColor4);","   }","}"]})}a.ColorClip=a.defineClass(b,a.Component,{modes:["BELOW","ABOVE","NEAR"],componentName:"ChannelShift",init:function(a,c,d){b.super.init.call(this,a,c,d),this.program.init(a)},update:function(){this.program.run(this.parent.fm,null,this.mode,this.color,this.outColor,this.level)},destroy:function(){b.super.destroy.call(this),this.program.cleanup()}}),a.ColorClipProgram=a.defineClass(c,a.QuadBoxProgram,{draw:function(a,b,d,e){this.setUniform("u_mode","1i",a),this.setUniform.apply(this,["u_color","3f"].concat(b)),this.setUniform.apply(this,["u_outColor","3f"].concat(d)),this.setUniform("u_level","1f",e),c.super.draw.call(this)}})}(Webvs),function(a){function b(c){a.checkRequiredOptions(c,["code"]),c=_.defaults(c,{gridW:16,gridH:16,noGrid:!1,bFilter:!0,compat:!1,coord:"POLAR"});var d;if(!_.isObject(c.code))throw new Error("Invalid Dynamic movement code");d=c.code;var e=new a.ExprCodeGenerator(d,["x","y","r","d","b","w","h"]),f=e.generateCode(["init","onBeat","perFrame"],["perPixel"],["x","y","d","r"]);this.code=f[0],this.inited=!1,this.noGrid=c.noGrid,this.gridW=c.gridW,this.gridH=c.gridH,this.coordMode=c.coord,this.bFilter=c.bFilter,this.compat=c.compat,this.program=this.noGrid?new a.DMovProgramNG(this.coordMode,this.bFilter,this.compat,this.code.hasRandom,f[1]):new a.DMovProgram(this.coordMode,this.bFilter,this.compat,this.code.hasRandom,f[1]),b.super.constructor.call(this)}function c(a,b,d,e,f){var g=[f,this.glslFilter(b,d),"void main() {",e?"__randSeed = v_position;":"","   x = v_position.x*2.0-1.0;","   y = -(v_position.y*2.0-1.0);",this.glslRectToPolar(a),"   perPixel();",this.glslPolarToRect(a),"   setFragColor(vec4(filter(vec2(x, -y)), 1));","}"];c.super.constructor.call(this,{fragmentShader:g,swapFrame:!0})}function d(a,b,c,e,f){var g=["attribute vec2 a_position;","varying vec2 v_newPoint;","uniform int u_coordMode;",f,"void main() {",e?"__randSeed = a_position;":"","   x = a_position.x;","   y = -a_position.y;",this.glslRectToPolar(a),"   perPixel();",this.glslPolarToRect(a),"   v_newPoint = vec2(x,-y);","   setPosition(a_position);","}"],h=["varying vec2 v_newPoint;",this.glslFilter(b,c),"void main() {","   setFragColor(vec4(filter(v_newPoint), 1));","}"];d.super.constructor.call(this,{fragmentShader:h,vertexShader:g,swapFrame:!0})}a.DynamicMovement=a.defineClass(b,a.Component,{componentName:"DynamicMovement",init:function(a,c,d){if(b.super.init.call(this,a,c,d),this.program.init(a),this.code.setup(c,d),!this.noGrid){for(var e=2*(this.gridW/this.main.canvas.width),f=2*(this.gridH/this.main.canvas.height),g=Math.ceil(this.main.canvas.width/this.gridW),h=Math.ceil(this.main.canvas.height/this.gridH),i=new Float32Array(2*6*g*h),j=0,k=-1,l=-1,m=0;h>m;m++){for(var n=0;g>n;n++){var o=Math.min(k+e,1),p=Math.min(l+f,1);i[j++]=k,i[j++]=l,i[j++]=o,i[j++]=l,i[j++]=k,i[j++]=p,i[j++]=o,i[j++]=l,i[j++]=o,i[j++]=p,i[j++]=k,i[j++]=p,k+=e}k=-1,l+=f}this.gridVertices=i,this.gridVerticesSize=j/2}},update:function(){var a=this.code;this.inited||(a.init(),this.inited=!0);var b=this.main.analyser.beat;a.b=b?1:0,a.perFrame(),b&&a.onBeat(),this.noGrid?this.program.run(this.parent.fm,null,this.code):this.program.run(this.parent.fm,null,this.code,this.gridVertices,this.gridVerticesSize)},destroy:function(){b.super.destroy.call(this),this.program.cleanup()}});var e={glslRectToPolar:function(a){return"POLAR"===a?["d = distance(vec2(x, y), vec2(0,0))/sqrt(2.0);","r = mod(atan(y, x)+PI*0.5, 2.0*PI);"].join("\n"):""},glslPolarToRect:function(a){return"POLAR"===a?["d = d*sqrt(2.0);","x = d*sin(r);","y = -d*cos(r);"].join("\n"):""},glslFilter:function(a,b){return a&&!b?["vec3 filter(vec2 point) {","   vec2 texel = 1.0/(u_resolution-vec2(1,1));","   vec2 coord = (point+1.0)/2.0;","   vec2 cornoff = fract(coord/texel);","   vec2 corn = floor(coord/texel)*texel;","   vec3 tl = getSrcColorAtPos(corn).rgb;","   vec3 tr = getSrcColorAtPos(corn + vec2(texel.x, 0)).rgb;","   vec3 bl = getSrcColorAtPos(corn + vec2(0, texel.y)).rgb;","   vec3 br = getSrcColorAtPos(corn + texel).rgb;","   vec3 pt = mix(tl, tr, cornoff.x);","   vec3 pb = mix(bl, br, cornoff.x);","   return mix(pt, pb, cornoff.y);","}"].join("\n"):a&&b?["vec3 filter(vec2 point) {","   vec2 texel = 1.0/(u_resolution-vec2(1,1));","   vec2 coord = (point+1.0)/2.0;","   vec2 corn = floor(coord/texel)*texel;","   vec3 tl = getSrcColorAtPos(corn).rgb;","   vec3 tr = getSrcColorAtPos(corn + vec2(texel.x, 0)).rgb;","   vec3 bl = getSrcColorAtPos(corn + vec2(0, texel.y)).rgb;","   vec3 br = getSrcColorAtPos(corn + texel).rgb;","   float xp = floor(fract(coord.x/texel.x)*255.0);","   float yp = floor(fract(coord.y/texel.y)*255.0);","   #define g_blendtable(i, j) floor(((i)/255.0)*(j))","   float a1 = g_blendtable(255.0-xp, 255.0-yp);","   float a2 = g_blendtable(xp,       255.0-yp);","   float a3 = g_blendtable(255.0-xp, yp);","   float a4 = g_blendtable(xp,       yp);","   float r = (floor(a1*tl.r) + floor(a2*tr.r) + floor(a3*bl.r) + floor(a4*br.r))/255.0;","   float g = (floor(a1*tl.g) + floor(a2*tr.g) + floor(a3*bl.g) + floor(a4*br.g))/255.0;","   float b = (floor(a1*tl.b) + floor(a2*tr.b) + floor(a3*bl.b) + floor(a4*br.b))/255.0;","   return vec3(r, g, b);","}"].join("\n"):["vec3 filter(vec2 point) {","   return getSrcColorAtPos((point+1.0)/2.0).rgb;","}"].join("\n")}};a.DMovProgramNG=a.defineClass(c,a.QuadBoxProgram,e,{draw:function(a){a.bindUniforms(this),c.super.draw.call(this)}}),a.DMovProgram=a.defineClass(d,a.ShaderProgram,e,{draw:function(a,b,c){a.bindUniforms(this),this.setVertexAttribArray("a_position",b,2,this.gl.FLOAT,!1,0,0),this.gl.drawArrays(this.gl.TRIANGLES,0,c)}}),b.ui={type:"DynamicMovement",disp:"Dynamic Movement",schema:{code:{type:"object",title:"Code","default":{},properties:{init:{type:"string",title:"Init"},onBeat:{type:"string",title:"On Beat"},perFrame:{type:"string",title:"Per Frame"},perPixel:{type:"string",title:"Per Point"}}},gridW:{type:"number",title:"Grid Width","default":16},gridH:{type:"number",title:"Grid Height","default":16},coord:{type:"string",title:"Coordinate System","enum":["POLAR","RECT"],"default":"POLAR"}},form:[{key:"code.init",type:"textarea"},{key:"code.onBeat",type:"textarea"},{key:"code.perFrame",type:"textarea"},{key:"code.perPixel",type:"textarea"},"gridW","gridH","coord"]}}(Webvs),function(a){function b(a){if(a=_.defaults(a,{channel:"RGB",onBeatRandom:!1}),this.channel=d.indexOf(a.channel),-1==this.channel)throw new Error("Invalid Channel");this.onBeatRandom=a.onBeatRandom,this.program=new c,b.super.constructor.call(this)}function c(){c.super.constructor.call(this,{swapFrame:!0,fragmentShader:["uniform int u_channel;","void main() {","   vec3 color = getSrcColor().rgb;",_.flatMap(d,function(a,b){return["if(u_channel == "+b+") {","   setFragColor(vec4(color."+a.toLowerCase()+",1));","}"]}).join("\n"),"}"]})}var d=["RGB","RBG","BRG","BGR","GBR","GRB"];a.ChannelShift=a.defineClass(b,a.Component,{componentName:"ChannelShift",init:function(a,c,d){b.super.init.call(this,a,c,d),this.program.init(a)},update:function(){this.onBeatRandom&&this.main.analyser.beat&&(this.channel=Math.floor(Math.random()*d.length)),this.program.run(this.parent.fm,null,this.channel)},destroy:function(){b.super.destroy.call(this),this.program.cleanup()}}),a.ChannelShiftProgram=a.defineClass(c,a.QuadBoxProgram,{draw:function(a){this.setUniform("u_channel","1i",a),c.super.draw.call(this)}}),b.ui={disp:"Channel Shift",type:"ChannelShift",schema:{channel:{type:"string",title:"Channel","enum":d},onBeatRandom:{type:"boolean",title:"On beat random"}}}}(Webvs),function(a){function b(d){a.checkRequiredOptions(d,["code"]),d=_.defaults(d,{source:"SPECTRUM",drawMode:"LINES",colors:["#ffffff"]});var e;if(!_.isObject(d.code))throw new Error("Invalid superscope");e=d.code;var f=new a.ExprCodeGenerator(e,["n","v","i","x","y","b","w","h","red","green","blue","cid"]),g=f.generateCode(["init","onBeat","perFrame","perPoint"],[],[]);this.code=g[0],this.code.n=100,this.spectrum="SPECTRUM"==d.source,this.dots="DOTS"==d.drawMode,this.colors=_.map(d.colors,a.parseColorNorm),this.currentColor=this.colors[0],this.maxStep=100,this.step=this.maxStep,this.colorId=0,this.colorStep=[0,0,0],this.thickness=d.thickness?d.thickness:1,this.inited=!1,this.program=new c,b.super.constructor.call(this)}function c(){c.super.constructor.call(this,{copyOnSwap:!0,vertexShader:["attribute vec2 a_position;","attribute vec3 a_color;","varying vec3 v_color;","uniform float u_pointSize;","void main() {","   gl_PointSize = u_pointSize;","   setPosition(clamp(a_position, vec2(-1,-1), vec2(1,1)));","   v_color = a_color;","}"],fragmentShader:["varying vec3 v_color;","void main() {","   setFragColor(vec4(v_color, 1));","}"]})}a.SuperScope=a.defineClass(b,a.Component,{componentName:"SuperScope",init:function(a,c,d){b.super.init.call(this,a,c,d),this.program.init(a),this.code.setup(c,this)},update:function(){this.gl;var a=this.code;this._stepColor(),a.red=this.currentColor[0],a.green=this.currentColor[1],a.blue=this.currentColor[2],this.inited||(a.init(),this.inited=!0);var b=this.main.analyser.beat;a.b=b?1:0,a.perFrame(),b&&a.onBeat();for(var c=Math.floor(a.n),d=this.spectrum?this.main.analyser.getSpectrum():this.main.analyser.getWaveform(),e=d.length/c,f=0,g=0,h=new Float32Array(2*(this.dots?c:2*c-2)),i=new Float32Array(3*(this.dots?c:2*c-2)),j=0;c>j;j++){for(var k=0,l=0,m=Math.floor(j*e);(j+1)*e>m;m++,l++)k+=d[m];k/=l;var n=j/(c-1);a.i=n,a.v=k,a.perPoint(),h[f++]=a.x,h[f++]=-1*a.y,0===j||j==c-1||this.dots||(h[f++]=a.x,h[f++]=-1*a.y),this.dots?(i[g++]=a.red,i[g++]=a.green,i[g++]=a.blue):0!==j&&(i[g++]=a.red,i[g++]=a.green,i[g++]=a.blue,i[g++]=a.red,i[g++]=a.green,i[g++]=a.blue)}this.program.run(this.parent.fm,null,h,i,this.dots,this.thickness)},destroy:function(){b.super.destroy.call(this),this.program.cleanup()},_stepColor:function(){var a;if(this.colors.length>1)if(this.step==this.maxStep){var b=this.colors[this.colorId];this.colorId=(this.colorId+1)%this.colors.length;var c=this.colors[this.colorId];for(a=0;3>a;a++)this.colorStep[a]=(c[a]-b[a])/this.maxStep;this.step=0,this.currentColor=b}else{for(a=0;3>a;a++)this.currentColor[a]+=this.colorStep[a];this.step++}}}),a.SuperScopeShader=a.defineClass(c,a.ShaderProgram,{draw:function(a,b,c,d){var e=this.gl;this.setUniform("u_pointSize","1f",d),this.setVertexAttribArray("a_position",a,2,e.FLOAT,!1,0,0),this.setVertexAttribArray("a_color",b,3,e.FLOAT,!1,0,0);var f;c||(f=e.getParameter(e.LINE_WIDTH),e.lineWidth(d)),e.drawArrays(c?e.POINTS:e.LINES,0,a.length/2),c||e.lineWidth(f)}}),b.ui={disp:"SuperScope",type:"SuperScope",schema:{code:{type:"object",title:"Code","default":{},properties:{init:{type:"string",title:"Init"},onBeat:{type:"string",title:"On Beat"},perFrame:{type:"string",title:"Per Frame"},perPoint:{type:"string",title:"Per Point"}}},source:{type:"string",title:"Source","default":"WAVEFORM","enum":["WAVEFORM","SPECTRUM"]},drawMode:{type:"string",title:"Draw Mode","default":"LINES","enum":["DOTS","LINES"]},colors:{type:"array",title:"Cycle Colors",items:{type:"string",format:"color","default":"#FFFFFF"}}}}}(Webvs),function(a){function b(c){c=_.defaults(c,{n:0,color:"#000000",blendMode:"REPLACE"}),this.n=c.n,this.color=a.parseColorNorm(c.color),this.outputBlendMode=a.blendModes[c.blendMode],this.prevBeat=!1,this.beatCount=0,this.program=new a.ClearScreenProgram(this.outputBlendMode),b.super.constructor.call(this)}a.ClearScreen=a.defineClass(b,a.Component,{componentName:"ClearScreen",init:function(a,c,d){b.super.init.call(this,a,c,d),this.program.init(a)},update:function(){var a=!1;0===this.n?a=!0:(this.main.analyser.beat&&!this.prevBeat&&(this.beatCount++,this.beatCount==this.n&&(a=!0,this.beatCount=0)),this.prevBeat=this.main.analyser.beat),a&&this.program.run(this.parent.fm,null,this.color)
},destroy:function(){this.program.cleanup()}}),b.ui={type:"ClearScreen",disp:"Clear Screen",schema:{n:{type:"number",title:"Clear on beat (0 = always clear)","default":0},color:{type:"string",title:"Clear color",format:"color","default":"#000000"},blendMode:{type:"string",title:"Blend Mode","enum":_.keys(a.blendModes)}}}}(Webvs),function(a){function b(c){a.checkRequiredOptions(c,["src","x","y"]),this.x=c.x,this.y=c.y,this.src=c.src,this.program=new a.PictureProgram,b.super.constructor.call(this,c)}function c(){c.super.constructor.call(this,{copyOnSwap:!0,vertexShader:["attribute vec2 a_texVertex;","uniform vec2 u_pos;","uniform vec2 u_texRes;","varying vec2 v_texCoord;","void main() {","   v_texCoord = a_texVertex;","   setPosition(a_texVertex*(u_texRes/u_resolution)*vec2(2,-2)+u_pos);","}"],fragmentShader:["uniform sampler2D u_image;","varying vec2 v_texCoord;","void main() {","   setFragColor(texture2D(u_image, v_texCoord));","}"]})}a.Picture=a.defineClass(b,a.Component,{init:function(c,d,e){b.super.init.call(this,c,d,e),this.program.init(c);var f=this,g=new Image;g.src=this.src;var h=new a.Promise;return g.onload=function(){f.width=g.width,f.height=g.height,f.texture=c.createTexture(),c.bindTexture(c.TEXTURE_2D,f.texture),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,g),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),h.resolve()},h},update:function(){this.program.run(this.parent.fm,null,this.x,this.y,this.texture,this.width,this.height)},destroy:function(){this.program.cleanup(),this.gl.deleteTexture(this.texture)}}),a.PictureProgram=a.defineClass(c,a.ShaderProgram,{draw:function(a,b,c,d,e){this.setUniform("u_pos","2f",a,-b),this.setUniform("u_texRes","2f",d,e),this.setUniform("u_image","texture2D",c),this.setVertexAttribArray("a_texVertex",new Float32Array([0,0,0,1,1,1,0,0,1,1,1,0])),this.gl.drawArrays(this.gl.TRIANGLES,0,6)}})}(Webvs);